<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EVE Chat</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-180x180.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💬</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💬</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&family=Comic+Neue:wght@400;700&family=Fredoka+One&family=Nunito:wght@400;500;600;700&family=Montserrat:wght@400;500;600&family=Inter:wght@400;500;600&family=Roboto:wght@400;500&family=Raleway:wght@400;500;600&family=Lato:wght@400;700&family=Poppins:wght@400;500;600&family=Quicksand:wght@400;500;600&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=20250805-duration-spacing">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- 🔥【新增】状态指示器样式 -->
    <style>
        /* 角色列表状态指示器 */
        .contact-status-indicator {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 10;
        }

        /* 已拉黑状态 - 红色 */
        .contact-status-indicator.blocked {
            background-color: #ff4444;
            color: white;
        }

        /* 被拉黑状态 - 深橙色 */
        .contact-status-indicator.blocked-by {
            background-color: #ff8800;
            color: white;
        }

        /* 已屏蔽群聊状态 - 橙色 */
        .contact-status-indicator.muted {
            background-color: #ff9500;
            color: white;
        }

        /* 确保角色项有相对定位 */
        .contact-item {
            position: relative;
        }

        /* 🔥【新增】足迹新增高亮样式 */
        .footprint-item.new-footprint {
            animation: slideInFromTop 0.5s ease-out;
        }

        .footprint-item.highlight-new {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-left: 4px solid #2196f3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        .footprint-mood {
            color: #e91e63;
            font-size: 0.9em;
            margin-top: 5px;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 🔥【新增】消息列表状态指示器样式 */
        .message-avatar-container {
            position: relative;
            display: inline-block;
        }

        .message-status-indicator {
            position: absolute;
            right: 2px;
            bottom: 1px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            z-index: 10;
        }

        /* 已拉黑状态 - 红色 */
        .message-status-indicator.blocked {
            background-color: #ff4444;
            color: white;
        }

        /* 被拉黑状态 - 深橙色 */
        .message-status-indicator.blocked-by {
            background-color: #ff8800;
            color: white;
        }

        /* 已屏蔽群聊状态 - 橙色 */
        .message-status-indicator.muted {
            background-color: #ff9500;
            color: white;
        }

        /* 🔥【新增】未读消息提示样式 */
        .unread-badge {
            position: absolute;
            right: -2px;
            top: -2px;
            min-width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #ff4444;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            z-index: 15;
            padding: 0 4px;
            box-sizing: border-box;
        }

        /* 当数字超过99时，显示99+ */
        .unread-badge.large-count {
            font-size: 8px;
            min-width: 20px;
            border-radius: 10px;
        }

        /* 🔥【新增】危险操作样式 */
        .danger-item {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .danger-item:hover {
            background-color: rgba(255, 59, 48, 0.05);
        }

        .danger-color {
            color: #ff3b30 !important;
        }

        .danger-section-title {
            color: #ff3b30 !important;
        }

        .danger-section-icon {
            color: #ff3b30 !important;
        }

        /* 🔥【重新设计】消息列表多选模式按钮 - 放在app-header中 */
        .chat-header-multiselect-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }





        /* 🔥【重新设计】置顶对话的视觉标识 - 主题化颜色 */
        .message-item.pinned {
            background: rgba(74, 132, 193, 0.08);
            border-left: 3px solid rgba(74, 132, 193, 0.3);
        }

        /* 可爱主题下的置顶对话样式 */
        body[data-theme="cute"] .message-item.pinned {
            background: rgba(255, 182, 193, 0.08);
            border-left: 3px solid rgba(255, 182, 193, 0.3);
        }

        .pin-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #ffd700;
            font-size: 12px;
            z-index: 5;
        }

        /* 🎮【新增】游戏选择模态框样式 - 毛玻璃风格莫兰迪色系 */
        .game-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 85%;
            max-height: 70vh;
        }

        /* 等待模态框样式 */
        .waiting-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .waiting-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 40px 30px;
            text-align: center;
            max-width: 300px;
            width: 80%;
        }

        .waiting-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            border-style: dashed;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .waiting-text {
            color: #666;
            font-size: 16px;
            margin: 0;
        }

        .game-modal-header {
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .game-modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #5a5a5a;
        }

        .game-modal-title i {
            color: #8b9dc3;
        }

        .game-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .game-modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #666;
        }

        .game-modal-body {
            padding: 15px 20px 25px 20px;
        }

        .game-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .game-button {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .game-button:active {
            transform: translateY(0);
        }

        /* 莫兰迪色系游戏按钮 */
        .game-button.gomoku {
            background: linear-gradient(135deg, rgba(139, 157, 195, 0.3), rgba(139, 157, 195, 0.1));
            color: #4a5568;
        }

        .game-button.turtle-soup {
            background: linear-gradient(135deg, rgba(168, 162, 158, 0.3), rgba(168, 162, 158, 0.1));
            color: #4a5568;
        }

        .game-button.werewolf {
            background: linear-gradient(135deg, rgba(147, 125, 135, 0.3), rgba(147, 125, 135, 0.1));
            color: #4a5568;
        }

        .game-button.monopoly {
            background: linear-gradient(135deg, rgba(162, 152, 140, 0.3), rgba(162, 152, 140, 0.1));
            color: #4a5568;
        }

        .game-button.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .game-button.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .game-button-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.4);
            color: inherit;
        }

        .game-button-content {
            flex: 1;
        }

        .game-button-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: inherit;
        }

        .game-button-desc {
            font-size: 13px;
            opacity: 0.8;
            color: inherit;
        }

        .game-button-badge {
            position: absolute;
            top: 8px;
            right: 12px;
            background: rgba(255, 255, 255, 0.8);
            color: #666;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .game-button-badge.recommended {
            background: rgba(255, 193, 7, 0.8);
            color: #856404;
        }

        .game-button-badge.coming-soon {
            background: rgba(108, 117, 125, 0.8);
            color: white;
        }

        /* 🎮【删除】游戏信息按钮样式已移除 */

        /* 🔥【新增】约定完成按钮样式 */
        .appointment-action-btn.appointment-complete-btn.completed {
            background-color: #e0e0e0 !important;
            color: #999 !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }

        .appointment-action-btn.appointment-complete-btn.completed:hover {
            background-color: #e0e0e0 !important;
            color: #999 !important;
        }

        /* 🔥【新增】约定倒计时样式 */
        .appointment-countdown {
            font-size: 14px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            background-color: #f0f0f0;
            color: #666;
        }

        .appointment-countdown.pending {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .appointment-countdown.completed {
            background-color: #e8f5e8;
            color: #4caf50;
        }

        .appointment-countdown.overdue {
            background-color: #ffebee;
            color: #f44336;
        }

        /* 🔥【新增】约定详情头部样式 */
        .appointment-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .appointment-detail-left {
            flex: 1;
        }

        .appointment-detail-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .appointment-detail-time {
            font-size: 14px;
            color: #666;
        }

        .appointment-detail-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .appointment-type-tag {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background-color: #ff9800;
            color: white;
            white-space: nowrap;
        }

        /* 🛒【新增】购物小票样式 */
        .order-receipt-container {
            margin: 8px 0;
            display: flex;
            justify-content: flex-end;
        }

        .receipt-card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            max-width: 280px;
            width: 100%;
            overflow: hidden;
            border: 1px solid #e8e8e8;
        }



        .receipt-header {
            background: #ffffff;
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid #e8e8e8;
        }

        .receipt-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .receipt-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .receipt-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #e8e8e8, transparent);
            margin: 0 16px;
        }

        .receipt-info {
            padding: 16px;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding: 2px 0;
            font-size: 12px;
            line-height: 1.2;
        }

        .receipt-row:last-child {
            margin-bottom: 0;
        }

        .receipt-row .label {
            color: #666;
            font-weight: 400;
            font-size: 12px;
        }

        .receipt-row .value {
            color: #333;
            font-weight: 400;
            font-size: 12px;
        }

        .receipt-items {
            padding: 0 16px 16px;
        }

        .items-header {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e8e8e8;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .receipt-item:last-child {
            margin-bottom: 0;
        }

        .item-name {
            flex: 1;
            color: #333;
            margin-right: 8px;
        }

        .item-quantity {
            color: #666;
            margin-right: 8px;
            min-width: 30px;
            text-align: center;
        }

        .item-price {
            color: #333;
            font-weight: 600;
            min-width: 60px;
            text-align: right;
        }

        .receipt-total {
            padding: 16px;
            background: #f8f9fa;
            border-top: 1px solid #e8e8e8;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .total-row:last-child {
            margin-bottom: 0;
        }

        .total-row.final {
            border-top: 1px solid #e8e8e8;
            padding-top: 8px;
            font-size: 16px;
            font-weight: 700;
        }

        .total-label {
            color: #666;
        }

        .total-row.final .total-label {
            color: #333;
        }

        .total-amount {
            color: #ff6b6b;
            font-weight: 700;
        }

        .receipt-footer {
            padding: 12px 16px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #e8e8e8;
        }

        .thank-you {
            font-size: 12px;
            color: #999;
            font-style: italic;
        }

        /* 🛒【新增】购物小票动画效果 */
        .receipt-card {
            animation: receiptSlideIn 0.3s ease-out;
        }

        @keyframes receiptSlideIn {
            from {
                opacity: 0;
                transform: translateX(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
















    </style>

</head>
<body>
     <div id="auth-overlay">
        <div class="auth-box">
            <h1>应用激活</h1>
            <p>请将下面的“请求码”发送给作者，以获取专属于您的激活码。</p>
            <div class="code-display-box"><strong id="request-code">...</strong></div>
            <input type="text" id="license-input" placeholder="在此输入获取的激活码">
            <button id="activate-button">激活</button>
        </div>
    </div>
    <div id="notification-container"></div>
        <!-- 推送通知容器 -->
        <div id="notification-container"></div>
   <div id="phone-screen" class="phone-screen">
        <div class="wallpaper" id="wallpaper-element">
            <!-- 主屏幕状态栏 -->
            <div id="status-bar">
                <span id="status-bar-time">14:25</span>
                <div class="status-bar-right">
                    <div id="status-bar-signal" class="signal-icon">
                        <div class="signal-row">
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                        </div>
                    </div>
                    <div id="status-bar-battery" class="battery-container">
                        <div class="battery-icon">
                            <div class="battery-level"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 音乐显示区域（类似灵动岛） - 独立于状态栏 -->
            <div id="music-status-display" class="music-status-display" style="display: none;" onclick="openMusicModal()">
                <i class="fas fa-headphones music-icon"></i>
                <div class="music-lyrics-scroll">
                    <span id="current-lyric">♪ 点击开始听歌</span>
                </div>
            </div>

            <!-- 时钟容器 -->
            <div id="clock-container">
                <div id="main-date">12月18日 星期一</div>
                <div id="main-time">14:25</div>
            </div>

            <div id="worldbook-screen" class="app-screen">
                <div class="app-top-container">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('worldbook-screen')">‹</button>
                        <div class="app-title">世界书</div>
                        <div class="add-worldbook-btn worldbook-add-btn" onclick="onWorldbookAddClick()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>

                <div class="app-content">
                    <div id="global-worldbooks-content" class="worldbook-content-pane">
                        </div>
                    <div id="local-worldbooks-content" class="worldbook-content-pane" style="display: none;">
                        </div>

                </div>



                <div class="worldbook-tabs">
                    <div class="worldbook-tab active" onclick="switchWorldbookTab('global')">
                        <i class="fas fa-globe-asia"></i>
                        <span>全局设定</span>
                    </div>
                    <div class="worldbook-tab" onclick="switchWorldbookTab('local')">
                        <i class="fas fa-comment-dots"></i>
                        <span>局部设定</span>
                    </div>

                </div>
            </div>

                <!-- 主屏幕四块布局 -->
                <div id="home-grid">
                    <!-- 左上角：图片小组件 -->
                    <div class="home-section top-left">
                        <div class="widget photo-widget" onclick="showPhotoWidgetOptions()">
                            <div class="photo-widget-content" id="photo-widget-content">
                                <div class="photo-placeholder" id="photo-placeholder">
                                    <i class="fas fa-image"></i>
                                    <span>点击添加图片</span>
                                </div>
                                <img class="photo-widget-image" id="photo-widget-image" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <!-- 右上角：两个应用 -->
                    <div class="home-section top-right">
                        <div class="apps-grid-2">
                            <a href="#" class="mini-app" onclick="showApp('chat-screen')">
                                <div class="mini-app-icon">
                                    <i class="fas fa-comment-dots"></i>
                                </div>
                                <span>Chat</span>
                            </a>
                            <a href="#" class="mini-app" onclick="showApp('worldbook-screen'); switchWorldbookTab('global');">
                                <div class="mini-app-icon">
                                    <i class="fas fa-globe-americas"></i>
                                </div>
                                <span>世界书</span>
                            </a>
                        </div>
                    </div>

                    <!-- 左下角：两个应用 -->
                    <div class="home-section bottom-left">
                        <div class="apps-grid-2">
                            <a href="#" class="mini-app" onclick="showApp('anniversary-screen')">
                                <div class="mini-app-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <span>纪念日</span>
                            </a>
                            <a href="#" class="mini-app" onclick="showApp('forum-screen')">
                                <div class="mini-app-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <span>论坛</span>
                            </a>
                        </div>
                    </div>

                    <!-- 右下角：纪念日小组件 -->
                    <div class="home-section bottom-right">
                        <div class="widget anniversary-widget">
                            <div class="anniversary-widget-content" id="anniversary-widget-content">
                                <div class="anniversary-placeholder" id="anniversary-placeholder">
                                    <i class="fas fa-heart"></i>
                                    <span>暂无纪念日</span>
                                </div>
                                <div class="anniversary-display" id="anniversary-display" style="display: none;">
                                    <div class="anniversary-name" id="widget-anniversary-name"></div>
                                    <div class="anniversary-countdown" id="widget-anniversary-countdown"></div>
                                    <div class="anniversary-date" id="widget-anniversary-date"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- iPhone风格Dock栏 -->
                <div id="dock-bar">
                    <div class="dock-container">
                        <a href="#" class="dock-app" onclick="showApp('messages-screen')">
                            <div class="dock-app-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <span>短信</span>
                        </a>
                        <a href="#" class="dock-app" onclick="showApp('settings-screen')">
                            <div class="dock-app-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            <span>设置</span>
                        </a>
                        <a href="#" class="dock-app" onclick="showApp('memory-viewer-screen')">
                            <div class="dock-app-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <span>记忆</span>
                        </a>
                    </div>
                </div>


                <!-- 纪念日界面 -->
                <div id="anniversary-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('anniversary-screen')">‹</button>
                            <div class="app-title">纪念日</div>
                        <div class="add-anniversary-btn" onclick="showAnniversaryForm()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    </div>
                    <div class="app-content">
                        <!-- 纪念日内容区域 -->
                        <div id="anniversary-content" class="anniversary-content-pane">
                            <!-- 置顶纪念日显示区域 -->
                            <div id="pinned-anniversary-section" class="pinned-anniversary-section" style="display: none;">
                                <div id="pinned-anniversary-card" class="pinned-anniversary-card">
                                    <!-- 置顶纪念日内容将通过JS动态生成 -->
                                </div>
                            </div>

                            <div id="anniversary-list" class="anniversary-list">
                                <!-- 纪念日列表将通过JS动态生成 -->
                                <div class="anniversary-empty-state">
                                    <i class="fas fa-heart"></i>
                                    <p>还没有纪念日</p>
                                    <p>点击右上角 + 添加重要的日子</p>
                                </div>
                            </div>
                        </div>

                        <!-- 约定内容区域 -->
                        <div id="appointment-content" class="anniversary-content-pane" style="display: none;">
                            <!-- 置顶约定显示区域 -->
                            <div id="pinned-appointment-section" class="pinned-appointment-section" style="display: none;">
                                <div id="pinned-appointment-card" class="pinned-appointment-card">
                                    <!-- 置顶约定内容将通过JS动态生成 -->
                                </div>
                            </div>

                            <div id="appointment-list" class="appointment-list">
                                <!-- 约定列表将通过JS动态生成 -->
                                <div class="appointment-empty-state">
                                    <i class="fas fa-calendar-check"></i>
                                    <p>还没有约定</p>
                                    <p>点击右上角 + 添加新约定</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 底部分栏 -->
                    <div class="anniversary-tabs">
                        <div class="anniversary-tab active" onclick="switchAnniversaryTab('anniversary')">
                            <i class="fas fa-heart"></i>
                            <span>纪念日</span>
                        </div>
                        <div class="anniversary-tab" onclick="switchAnniversaryTab('appointment')">
                            <i class="fas fa-calendar-check"></i>
                            <span>约定</span>
                        </div>
                    </div>
                </div>

                <!-- 购物界面 -->
                <div id="shopping-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="handleShoppingBack()" id="shopping-back-btn">‹</button>
                        <div class="app-title">购物</div>
                        <div class="shopping-header-actions">
                            <div class="shopping-cart-btn" onclick="openShoppingCart()" title="购物车">
                                <i class="fas fa-shopping-cart"></i>
                                <span class="cart-badge" id="cart-badge" style="display: none;">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-content shopping-content">
                        <!-- 搜索框 -->
                        <div class="shopping-search-container">
                            <div class="shopping-search-box">
                                <i class="fas fa-search shopping-search-icon"></i>
                                <input type="text" id="shopping-search-input" class="shopping-search-input" placeholder="搜索商品..." maxlength="100">
                            </div>
                        </div>

                        <!-- 分类区域 -->
                        <div class="shopping-categories" id="shopping-categories">
                            <!-- 外卖分类 -->
                            <div class="category-list" id="takeout-categories">
                                <div class="category-item" onclick="showCategoryProducts('美食')">
                                    <i class="fas fa-utensils"></i>
                                    <span>美食</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('甜点饮品')">
                                    <i class="fas fa-coffee"></i>
                                    <span>甜点饮品</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('蔬菜水果')">
                                    <i class="fas fa-apple-alt"></i>
                                    <span>蔬菜水果</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('看病买药')">
                                    <i class="fas fa-pills"></i>
                                    <span>看病买药</span>
                                </div>
                                <div class="category-item custom-item" onclick="addCustomItem()">
                                    <i class="fas fa-plus"></i>
                                    <span>添加自定义商品</span>
                                </div>
                            </div>

                            <!-- 购物分类 -->
                            <div class="category-list" id="shopping-categories-list" style="display: none;">
                                <div class="category-item" onclick="showCategoryProducts('数码产品')">
                                    <i class="fas fa-laptop"></i>
                                    <span>数码产品</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('家居百货')">
                                    <i class="fas fa-home"></i>
                                    <span>家居百货</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('女装男装')">
                                    <i class="fas fa-tshirt"></i>
                                    <span>女装男装</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('饰品箱包')">
                                    <i class="fas fa-gem"></i>
                                    <span>饰品箱包</span>
                                </div>
                                <div class="category-item custom-item" onclick="addCustomItem()">
                                    <i class="fas fa-plus"></i>
                                    <span>添加自定义商品</span>
                                </div>
                            </div>
                        </div>

                        <!-- 商品展示区域 -->
                        <div class="products-container" id="products-container" style="display: none;">
                            <div class="products-grid" id="products-grid">
                                <!-- 商品将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>

                    <!-- 底部导航栏 -->
                    <div class="shopping-tabs">
                        <div class="shopping-tab active" onclick="switchShoppingTab('takeout')">
                            <i class="fas fa-utensils"></i>
                            <span>外卖</span>
                        </div>
                        <div class="shopping-tab" onclick="switchShoppingTab('shopping')">
                            <i class="fas fa-shopping-cart"></i>
                            <span>购物</span>
                        </div>
                    </div>
                </div>

                <!-- 购物车界面 -->
                <div id="shopping-cart-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="handleShoppingCartBack()">‹</button>
                        <div class="app-title">购物车</div>
                        <div class="cart-header-actions">
                            <div class="clear-cart-btn" onclick="clearShoppingCart()" title="清空购物车">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </div>
                    <div class="app-content cart-content">
                        <!-- 购物车商品列表 -->
                        <div class="cart-items-container" id="cart-items-container">
                            <!-- 购物车商品将通过JavaScript动态生成 -->
                        </div>

                        <!-- 购物车为空时的提示 -->
                        <div class="cart-empty-state" id="cart-empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <p>购物车是空的</p>
                            <p>去添加一些商品吧</p>
                            <button class="go-shopping-btn" onclick="hideApp('shopping-cart-screen'); openShoppingScreen();">
                                去购物
                            </button>
                        </div>
                    </div>

                    <!-- 购物车底部结算区域 -->
                    <div class="cart-footer" id="cart-footer" style="display: none;">
                        <div class="cart-summary">
                            <div class="cart-total">
                                <span class="total-label">总计：</span>
                                <span class="total-price" id="cart-total-price">¥0</span>
                            </div>
                            <div class="cart-actions">
                                <button class="pay-for-me-btn" onclick="requestPayment()">
                                    请Ta代付
                                </button>
                                <button class="checkout-btn" onclick="proceedToCheckout()">
                                    结算 (<span id="cart-items-count">0</span>)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 短信界面 -->
                <div id="messages-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('messages-screen')">‹</button>
                            <div class="app-title">短信</div>
                        <div class="messages-header-actions" id="sms-normal-actions">
                            <div class="sms-manage-btn" onclick="showSMSManageOptions()" title="管理短信">
                                <i class="fas fa-ellipsis-h"></i>
                            </div>
                            <div class="add-message-btn" onclick="showNewMessageForm()">
                                <i class="fas fa-edit"></i>
                            </div>
                        </div>
                        <!-- 🔥【新增】短信列表多选模式按钮 -->
                        <div class="messages-multiselect-actions" id="sms-list-multiselect-actions" style="display: none;">
                            <button class="multiselect-btn cancel-btn" onclick="exitSMSListMultiSelectMode()">
                                <span>取消</span>
                            </button>
                            <button class="multiselect-btn delete-btn" onclick="deleteSelectedSMSConversations()">
                                <span>删除</span>
                            </button>
                        </div>
                    </div>
                    </div>
                    <div class="app-content">
                        <div id="messages-list" class="messages-list">
                            <!-- 短信列表将通过JS动态生成 -->
                            <div class="messages-empty-state">
                                <i class="fas fa-comment-dots"></i>
                                <p>暂无短信</p>
                                <p>点击右上角编辑按钮创建新信息</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 短信聊天界面 -->
                <div id="sms-chat-screen" class="app-screen" style="display: none;">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideSMSChat()">‹</button>
                        <div class="sms-chat-header-center">
                            <div class="sms-chat-avatar" id="sms-chat-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="sms-chat-name" id="sms-chat-name"></div>
                        </div>
                        <div class="sms-chat-actions" id="sms-chat-normal-actions">
                            <button class="sms-action-btn" onclick="showSMSChatInfo()">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                        <!-- 🔥【重新设计】短信多选模式按钮 - 简洁样式 -->
                        <div class="sms-chat-multiselect-actions" id="sms-chat-multiselect-actions" style="display: none;">
                            <button class="multiselect-btn cancel-btn" onclick="exitSMSMultiSelectMode()">
                                <span>取消</span>
                            </button>
                            <button class="multiselect-btn delete-btn" onclick="deleteSelectedSMSMessages()">
                                <span>删除</span>
                            </button>
                        </div>
                    </div>
                    </div>
                    <div class="app-content sms-chat-content">
                        <div id="sms-messages-container" class="sms-messages-container">
                            <!-- 短信消息将通过JS动态生成 -->
                        </div>
                    </div>
                    <div class="sms-input-section">
                        <div class="sms-input-container">
                            <button class="sms-attachment-btn" onclick="openSMSImagePicker()">
                                <i class="fas fa-plus"></i>
                            </button>
                            <div class="sms-input-wrapper">
                                <input type="text" id="sms-message-input" class="sms-message-input" placeholder="短信" onkeydown="handleSMSInputKeydown(event)">
                                <button class="sms-wait-reply-btn" onclick="triggerSMSReply()" id="sms-wait-reply-btn" title="等待角色回复">
                                    <i class="fas fa-comment-dots"></i>
                                </button>
                            </div>
                            <button class="sms-send-btn" onclick="sendSMSMessage()" id="sms-send-button" style="display: none;">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                </div>



                <!-- 🔥【新增】短信图片选择器 -->
                <input type="file" id="sms-image-input" accept="image/*" style="display: none;" onchange="handleSMSImageSelect(event)">

                <!-- 🎨【新增】自定义主题图片上传输入框 -->
                <input type="file" id="chat-top-bg-input" accept="image/*" style="display: none;" onchange="handleChatTopBgUpload(event)">
                <input type="file" id="chat-bottom-bg-input" accept="image/*" style="display: none;" onchange="handleChatBottomBgUpload(event)">
                <input type="file" id="button-icon-input" accept="image/*" style="display: none;" onchange="handleButtonIconUpload(event)">
                <input type="file" id="global-top-app-bar-input" accept="image/*" style="display: none;" onchange="handleGlobalTopAppBarUpload(event)">
                <input type="file" id="global-bottom-app-bar-input" accept="image/*" style="display: none;" onchange="handleGlobalBottomAppBarUpload(event)">
                <input type="file" id="global-back-button-input" accept="image/*" style="display: none;" onchange="handleGlobalBackButtonUpload(event)">
                <input type="file" id="global-add-button-input" accept="image/*" style="display: none;" onchange="handleGlobalAddButtonUpload(event)">
                <input type="file" id="global-bg-input" accept="image/*" style="display: none;" onchange="handleGlobalBgUpload(event)">

                <!-- 🔥【修复】短信管理选项模态框 -->
                <div id="sms-manage-modal" class="sms-manage-modal" style="display: none;" onclick="hideSMSManageOptions(event)">
                    <div class="sms-manage-modal-content" onclick="event.stopPropagation()">
                        <div class="sms-manage-option" onclick="enterSMSListMultiSelectMode()">
                            <i class="fas fa-trash"></i>
                            <span>多选删除</span>
                        </div>
                        <div class="sms-manage-option" onclick="enterSMSPinMode()">
                            <i class="fas fa-thumbtack"></i>
                            <span>置顶对话</span>
                        </div>
                    </div>
                </div>

                <!-- 短信身份选择模态框 -->
                <div id="sms-persona-selector-modal" class="modal-overlay" style="display: none;" onclick="hideSMSPersonaSelector(event)">
                    <div class="modal-content sms-selector-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>选择你的身份</h3>
                            <button class="modal-close-btn" onclick="hideSMSPersonaSelector()">×</button>
                        </div>
                        <div class="modal-body" id="sms-persona-selector-body">
                            <!-- 身份列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 短信角色选择模态框 -->
                <div id="sms-character-selector-modal" class="modal-overlay" style="display: none;" onclick="hideSMSCharacterSelector(event)">
                    <div class="modal-content sms-selector-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>选择聊天角色</h3>
                            <button class="modal-close-btn" onclick="hideSMSCharacterSelector()">×</button>
                        </div>
                        <div class="modal-body" id="sms-character-selector-body">
                            <!-- 角色列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 自定义商品添加模态框 -->
                <div id="custom-item-modal" class="modal-overlay" style="display: none;" onclick="hideCustomItemModal(event)">
                    <div class="modal-content custom-item-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>添加自定义商品</h3>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="custom-item-name">商品名称</label>
                                <input type="text" id="custom-item-name" class="form-input" placeholder="请输入商品名称" maxlength="50" onkeydown="handleCustomItemKeydown(event)">
                            </div>

                            <div class="form-group">
                                <label for="custom-item-description">商品介绍 <span style="color: #999; font-size: 12px;">(可选)</span></label>
                                <input type="text" id="custom-item-description" class="form-input" placeholder="请输入商品介绍" maxlength="100" onkeydown="handleCustomItemKeydown(event)">
                            </div>

                            <div class="form-group">
                                <label for="custom-item-price">商品价格</label>
                                <div class="price-input-container">
                                    <span class="price-symbol">¥</span>
                                    <input type="number" id="custom-item-price" class="form-input price-input" placeholder="0.00" min="0" step="0.01" onkeydown="handleCustomItemKeydown(event)">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="hideCustomItemModal()">取消</button>
                            <button class="btn btn-primary" onclick="confirmAddCustomItem()">添加到购物车</button>
                        </div>
                    </div>
                </div>

                <!-- 代付选择模态框 -->
                <div id="payment-request-modal" class="modal-overlay" style="display: none;" onclick="hidePaymentRequestModal(event)">
                    <div class="modal-content payment-request-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>请Ta代付</h3>
                            <button class="modal-close-btn" onclick="hidePaymentRequestModal()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="payment-summary">
                                <div class="payment-total">
                                    <span class="total-label">总计：</span>
                                    <span class="total-price" id="payment-modal-total">¥0</span>
                                </div>
                                <div class="payment-items-count">
                                    共 <span id="payment-modal-items-count">0</span> 件商品
                                </div>
                            </div>

                            <div class="payment-options">
                                <h4>为谁下单？</h4>
                                <div class="payment-option-buttons">
                                    <button class="payment-option-btn" onclick="processOrder('for_self')">
                                        <i class="fas fa-user"></i>
                                        <span>为自己下单</span>
                                    </button>
                                    <button class="payment-option-btn" onclick="processOrder('for_ta')">
                                        <i class="fas fa-gift"></i>
                                        <span>为Ta下单</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 短信聊天设置界面 -->
                <div id="sms-chat-settings-screen" class="app-screen" style="display: none;">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideSMSChatSettings()">‹</button>
                            <div class="app-title">聊天设置</div>
                        </div>
                    </div>
                    <div class="app-content sms-settings-content">
                        <div class="setting-group">
                            <h4><i class="fas fa-history"></i> 历史消息</h4>
                            <div class="setting-item">
                                <label>附带历史消息回合数</label>
                                <div class="slider-container">
                                    <input type="range" id="sms-history-rounds-slider" min="0" max="500" value="50" onchange="updateSMSHistoryRounds()">
                                    <span id="sms-history-rounds-value">50轮</span>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <h4><i class="fas fa-palette"></i> 气泡颜色</h4>
                            <div class="setting-item">
                                <label>我的消息气泡颜色</label>
                                <div class="bubble-color-selector">
                                    <div class="color-option-text" data-color="blue" onclick="setSMSBubbleColor('blue')">
                                        蓝色
                                    </div>
                                    <div class="color-option-text" data-color="green" onclick="setSMSBubbleColor('green')">
                                        绿色
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <h4><i class="fas fa-trash-alt"></i> 数据管理</h4>
                            <div class="setting-item" onclick="clearSMSChatHistory()">
                                <label style="white-space: nowrap;">清空记录</label>
                                <div class="setting-desc">删除所有短信记录和相关记忆，不可恢复</div>
                            </div>
                        </div>


                    </div>
                </div>

                <!-- 聊天界面 -->
                <div id="chat-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('chat-screen')">‹</button>
                            <div class="app-title">💬</div>
                        <div class="chat-header-actions">
                            <div id="group-manage-btn" class="header-action-btn" onclick="enterGroupManageMode()" title="管理分组">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div id="add-contact-btn" class="add-btn" onclick="showCharacterForm()">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div id="add-chat-btn" class="add-btn" onclick="showChatOptions()">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                    </div>

                    <div class="app-content" id="chat-content">
                        <!-- 默认显示消息列表 -->
                        <div class="message-list" id="message-list">
                            <!-- 消息列表将通过JS动态生成 -->
                        </div>

                        <!-- 通讯录 -->
                        <div class="contact-list hide" id="contact-list">
                            <div class="contact-section">

                                <!-- 角色列表将通过JS动态生成 -->
                            </div>

                        </div>

                        <!-- 动态页面 -->
                        <div class="moments-page hide moments-page-no-padding" id="moments-page">
                            <div class="moments-header">
                                <div class="moments-cover" onclick="changeCoverImage()">
                                    <div class="cover-image-placeholder" id="cover-placeholder">
                                        <div class="cover-placeholder-text">点击更换封面</div>
                                        </div>
                                    <img class="cover-image hide" id="cover-image" src="">
                                    </div>

                                <!-- 用户名，独立放置在头像左上角 -->
                                <div class="moments-username" onclick="changeUsername(event)" id="moments-username">用户</div>

                                <!-- 独立的头像，跨越背景和动态列表区域，放在header外面 -->
                                <div class="moments-avatar" onclick="changeAvatarImage(event)" id="moments-avatar">
                                    <i class="fas fa-user moments-avatar-icon"></i>
                                </div>
                            </div>

                            <div class="moments-list" id="moments-list">
                                <!-- 动态列表将通过JS动态生成 -->
                            </div>


                        </div>


                        <!-- 面具区域 -->
                        <div class="profile-page hide" id="profile-page">
                            <div class="persona-section">
                                <div class="persona-header" onclick="togglePersonaSection()">
                                    <div class="persona-title">
                                        <h2>我的面具</h2>
                                        <p>管理你的多重身份设定</p>
                                    </div>
                                    <div class="persona-header-actions">
                                        <button class="add-persona-btn-header" onclick="event.stopPropagation(); showPersonaForm()" title="添加面具">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <div class="persona-toggle" onclick="event.stopPropagation(); togglePersonaSection()">
                                            <i class="fas fa-chevron-down expanded" id="persona-chevron"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="persona-content" id="persona-content">
                                    <div class="persona-list" id="persona-list">
                                        <!-- 面具列表将通过JS动态生成 -->
                                    </div>
                                </div>
                            </div>

                            <!-- 表情包库区域 -->
                            <div class="emoji-library-section">
                                <div class="emoji-library-header" onclick="toggleEmojiLibrarySection()">
                                    <div class="emoji-library-title">
                                        <h3>角色表情包库</h3>
                                        <p>管理角色的表情包分类</p>
                                    </div>
                                    <div class="emoji-library-header-actions">
                                        <button class="create-library-btn-header" onclick="event.stopPropagation(); showCreateLibraryForm()" title="新建表情包库">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <div class="emoji-library-toggle" onclick="event.stopPropagation(); toggleEmojiLibrarySection()">
                                            <i class="fas fa-chevron-down" id="emoji-library-chevron"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="emoji-library-content" id="emoji-library-content" style="display: none;">
                                    <div class="emoji-library-list" id="emoji-library-list">
                                        <!-- 表情包库列表将通过JS动态生成 -->
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="chat-tabs">
                        <div class="chat-tab active" onclick="switchChatTab('message-list')" id="message-tab">
                            <i class="fas fa-comments"></i>
                            <span>消息</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('contact-list')">
                            <i class="fas fa-user-friends"></i>
                            <span>角色</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('moments-page')">
                            <i class="fas fa-globe-americas"></i>
                            <span>动态</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('profile-page')">
                            <i class="fas fa-user-circle"></i>
                            <span>我</span>
                        </div>
                    </div>
                </div>

                <!-- 发布动态界面 -->
                <div id="publish-moment-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hidePublishMoment()">‹</button>
                        <div class="app-title">发表动态</div>
                        <button class="publish-btn" onclick="publishMoment()">发表</button>
                    </div>
                    <div class="app-content">
                        <div class="publish-moment-form">
                            <!-- 文字输入区域 -->
                            <div class="moment-text-input">
                                <textarea
                                    id="moment-text"
                                    placeholder="此刻想法..."
                                    class="moment-textarea"
                                    maxlength="500"
                                    oninput="updateTextCount()"></textarea>
                                <div class="text-count" id="text-count">0/500</div>
                            </div>

                            <!-- 图片上传区域 -->
                            <div class="moment-images-section">
                                <div class="moment-images-grid" id="moment-images-grid">
                                    <!-- 动态添加的图片预览 -->
                                </div>
                                <div class="add-image-btn" onclick="addMomentImage()">
                                    <i class="fas fa-plus"></i>
                                    <span>添加图片</span>
                                </div>
                            </div>

                            <!-- 发布选项 -->
                            <div class="publish-options">
                                <div class="option-item" onclick="showLocationModal()">
                                    <i class="fas fa-map-marker-alt location-icon"></i>
                                    <span>所在位置</span>
                                    <span class="option-value" id="selected-location"></span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                                <div class="option-item" onclick="showMomentMentionModal()">
                                    <i class="fas fa-at mention-icon"></i>
                                    <span>提醒谁看</span>
                                    <div class="selected-mentions" id="selected-mentions">
                                        <!-- 已选择的角色头像将显示在这里 -->
                                    </div>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                                <div class="option-item" onclick="showVisibilityModal()">
                                    <i class="fas fa-eye visibility-icon"></i>
                                    <span>谁可以看</span>
                                    <span class="option-value" id="selected-visibility">公开</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 位置选择模态框 -->
                <div id="location-modal" class="modal-overlay" style="display: none;" onclick="hideLocationModal(event)">
                    <div class="modal-content location-modal-content" onclick="event.stopPropagation()">
                        <div class="location-modal-header">
                            <button class="location-cancel-btn" onclick="hideLocationModal()">取消</button>
                            <h3 class="location-modal-title">所在位置</h3>
                            <button class="location-confirm-btn" onclick="confirmLocation()">完成</button>
                        </div>
                        <div class="location-modal-body">
                            <div class="location-search-section">
                                <div class="location-search-box">
                                    <i class="fas fa-search location-search-icon"></i>
                                    <input type="text" id="location-input" class="location-search-input" placeholder="搜索附近位置" maxlength="50">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 提醒谁看模态框 -->
                <div id="mention-modal" class="modal-overlay" style="display: none;" onclick="hideMomentMentionModal(event)">
                    <div class="modal-content mention-modal-content" onclick="event.stopPropagation()">
                        <div class="mention-modal-header">
                            <button class="mention-cancel-btn" onclick="hideMomentMentionModal()">取消</button>
                            <h3 class="mention-modal-title">提醒谁看</h3>
                            <button class="mention-confirm-btn" onclick="confirmMomentMention()">完成</button>
                        </div>
                        <div class="mention-modal-body">
                            <div class="mention-characters-list" id="mention-characters-list">
                                <!-- 角色列表将通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 谁可以看模态框 -->
                <div id="visibility-modal" class="modal-overlay" style="display: none;" onclick="hideVisibilityModal(event)">
                    <div class="modal-content visibility-modal-content" onclick="event.stopPropagation()">
                        <div class="visibility-modal-header">
                            <button class="visibility-cancel-btn" onclick="hideVisibilityModal()">取消</button>
                            <h3 class="visibility-modal-title">谁可以看</h3>
                            <button class="visibility-confirm-btn" onclick="confirmVisibility()">完成</button>
                        </div>
                        <div class="visibility-modal-body">
                            <div class="visibility-options" id="visibility-options">
                                <div class="visibility-option" data-value="public">
                                    <div class="visibility-option-icon">
                                        <i class="fas fa-globe"></i>
                                    </div>
                                    <div class="visibility-option-content">
                                        <div class="visibility-option-title">公开</div>
                                        <div class="visibility-option-desc">所有人都可以看到</div>
                                    </div>
                                    <div class="visibility-option-radio">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div class="visibility-option" data-value="private">
                                    <div class="visibility-option-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div class="visibility-option-content">
                                        <div class="visibility-option-title">私密</div>
                                        <div class="visibility-option-desc">只有自己可以看到</div>
                                    </div>
                                    <div class="visibility-option-radio">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div class="visibility-option" data-value="partial">
                                    <div class="visibility-option-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="visibility-option-content">
                                        <div class="visibility-option-title">部分可见</div>
                                        <div class="visibility-option-desc">选择特定分组可见</div>
                                    </div>
                                    <div class="visibility-option-radio">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="visibility-groups-section" id="visibility-groups-section" style="display: none;">
                                <div class="visibility-groups-title">选择可见分组</div>
                                <div class="visibility-groups-list" id="visibility-groups-list">
                                    <!-- 分组列表将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 论坛界面 -->
                <div id="forum-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('forum-screen')">‹</button>
                            <div class="app-title">论坛</div>
                        <div class="add-forum-btn" onclick="showCreateForumScreen()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    </div>
                    <div class="app-content">
                        <div id="forum-archive-list" class="forum-archive-list">
                            <div class="forum-empty-state">
                                <i class="fas fa-comments"></i>
                                <p>还没有创建任何论坛</p>
                                <p>点击右上角 + 创建你的第一个论坛</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 创建论坛界面 -->
                <div id="create-forum-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('create-forum-screen'); renderForumArchives(); showApp('forum-screen');">‹</button>
                        <div class="app-title" id="forum-form-title">创建新论坛</div>
                    </div>
                    <div class="app-content">
                        <input type="hidden" id="forum-form-id">
                        <div class="form-group">
                            <label class="form-label">论坛名称</label>
                            <input type="text" id="forum-name-input" class="form-input" placeholder="给这个世界线起个名字吧">
                        </div>
                        <div class="form-group">
                            <label class="form-label">选择角色 (可多选)</label>
                            <div id="forum-character-selection" class="selection-grid"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">选择你的身份</label>
                            <div id="forum-persona-selection" class="selection-grid single-selection"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">补充世界观 (可选)</label>
                            <textarea id="forum-worldview-input" class="form-textarea" rows="4" placeholder="补充一些背景故事或设定..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">挂载局部世界书 (可选)</label>
                            <div id="forum-worldbook-selection" class="selection-grid"></div>
                        </div>
                        <button class="form-submit" id="forum-form-submit-btn" onclick="handleForumFormSubmit()">进入论坛</button>
                    </div>
                </div>

                <!-- 帖子列表界面 -->
                <div id="forum-view-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToForumArchives()">‹</button>
                            <div class="app-title" id="forum-view-title">论坛</div>
                        <div class="header-actions">
                            <span class="action-btn" onclick="showMakeNewsModal()" title="搞个大新闻">
                                <i class="fas fa-pencil-alt"></i>
                            </span>
                            <span class="action-btn" onclick="showForumProfile()" title="个人主页">
                                <i class="fas fa-user"></i>
                            </span>
                        </div>
                    </div>
                    </div>
                    <div class="app-content">
                        <div id="forum-posts-list" class="post-list">
                        </div>
                    </div>

                    <!-- 悬浮按钮组 -->
                    <div class="floating-action-buttons">
                        <div class="floating-btn refresh-btn" onclick="refreshPosts()" title="刷新帖子">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="floating-btn post-btn" onclick="showCreatePostModal()" title="发帖">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>

                <!-- 用户发帖模态框 -->
                <div id="create-post-modal" class="modal-overlay" style="display: none;" onclick="hideCreatePostModal(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>发布新帖</h3>
                            <button class="modal-close-btn" onclick="hideCreatePostModal()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>标题</label>
                                <input type="text" id="post-title-input" placeholder="请输入帖子标题..." maxlength="100">
                            </div>
                            <div class="form-group">
                                <label>内容</label>
                                <textarea id="post-content-input" placeholder="分享你的想法..." rows="6" maxlength="2000"></textarea>
                            </div>
                            <div class="form-group">
                                <label>图片 (可选)</label>
                                <div id="post-image-preview-container" style="display:none; margin-bottom: 10px; position: relative;">
                                    <img id="post-image-preview" src="" alt="图片预览" style="max-width: 100%; max-height: 150px; border-radius: 8px;">
                                    <button id="post-remove-image-btn" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer;">×</button>
                                </div>
                                <button class="form-upload-btn" id="post-upload-image-btn">
                                    <i class="fas fa-image"></i> 选择图片
                                </button>
                                <input type="file" id="post-image-upload" accept="image/*" style="display: none;">
                            </div>
                            <div class="char-count">
                                <span id="title-count">0/100</span> | <span id="content-count">0/2000</span>
                            </div>
                            <div class="form-group" style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="anonymous-post-checkbox" style="margin-right: 8px;">
                                    匿名发帖（其他用户无法识别你的身份）
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="hideCreatePostModal()">取消</button>
                            <button class="btn-primary" onclick="submitUserPost()">发布</button>
                        </div>
                    </div>
                </div>

                <!-- 🔥【新增】视频通话形象设置模态框 -->
                <div id="video-avatar-modal" class="modal-overlay" style="display: none;" onclick="hideVideoAvatarModal(event)">
                    <div class="modal-content video-avatar-modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>通话形象设置</h3>
                            <button class="modal-close-btn" onclick="hideVideoAvatarModal()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="video-avatar-preview">
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview-item">
                                        <div class="avatar-preview-label">角色通话形象</div>
                                        <div class="avatar-preview-image-container">
                                            <img id="character-video-avatar-preview" src="" alt="角色通话形象" class="avatar-preview-image">
                                            <div class="avatar-preview-placeholder" id="character-avatar-placeholder">
                                                <i class="fas fa-user"></i>
                                                <span>点击设置</span>
                                            </div>
                                        </div>
                                        <button class="avatar-change-btn" onclick="changeCharacterVideoAvatar()">
                                            <i class="fas fa-camera"></i>
                                            更换形象
                                        </button>
                                    </div>

                                    <div class="avatar-preview-item">
                                        <div class="avatar-preview-label">用户通话形象</div>
                                        <div class="avatar-preview-image-container">
                                            <img id="user-video-avatar-preview" src="" alt="用户通话形象" class="avatar-preview-image">
                                            <div class="avatar-preview-placeholder" id="user-avatar-placeholder">
                                                <i class="fas fa-user"></i>
                                                <span>点击设置</span>
                                            </div>
                                        </div>
                                        <button class="avatar-change-btn" onclick="changeUserVideoAvatar()">
                                            <i class="fas fa-camera"></i>
                                            更换形象
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="video-avatar-tips">
                                <div class="tips-title">
                                    <i class="fas fa-lightbulb"></i>
                                    设置说明
                                </div>
                                <div class="tips-content">
                                    • 角色通话形象：视频通话时角色显示的形象<br>
                                    • 用户通话形象：视频通话时你显示的形象<br>
                                    • 如不设置将使用默认头像
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="hideVideoAvatarModal()">取消</button>
                            <button class="btn-primary" onclick="saveVideoAvatarSettings()">保存设置</button>
                        </div>
                    </div>
                </div>

                <!-- 🔥【新增】导出选项模态框 -->
                <div id="export-options-modal" class="modal-overlay" style="display: none;" onclick="hideExportOptions(event)">
                    <div class="modal-content export-options-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>导出聊天记录</h3>
                            <button class="modal-close-btn" onclick="hideExportOptions()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="export-format-section">
                                <h4>选择导出格式</h4>
                                <div class="export-format-options">
                                    <div class="export-format-option" onclick="selectExportFormat('html')">
                                        <div class="format-icon">
                                            <i class="fas fa-file-code"></i>
                                        </div>
                                        <div class="format-info">
                                            <div class="format-title">HTML格式</div>
                                            <div class="format-desc">适合阅读和分享的网页格式</div>
                                        </div>
                                        <div class="format-radio">
                                            <input type="radio" name="exportFormat" value="html" id="format-html" checked>
                                            <label for="format-html"></label>
                                        </div>
                                    </div>
                                    <div class="export-format-option" onclick="selectExportFormat('json')">
                                        <div class="format-icon">
                                            <i class="fas fa-database"></i>
                                        </div>
                                        <div class="format-info">
                                            <div class="format-title">JSON格式</div>
                                            <div class="format-desc">完整数据备份，包含聊天记录和记忆系统</div>
                                        </div>
                                        <div class="format-radio">
                                            <input type="radio" name="exportFormat" value="json" id="format-json">
                                            <label for="format-json"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideExportOptions()">取消</button>
                            <button class="modal-button modal-primary" onclick="executeExport()">导出</button>
                        </div>
                    </div>
                </div>

                <!-- 🔥【新增】导入选项模态框 -->
                <div id="import-options-modal" class="modal-overlay" style="display: none;" onclick="hideImportOptions(event)">
                    <div class="modal-content import-options-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>导入聊天记录</h3>
                            <button class="modal-close-btn" onclick="hideImportOptions()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="import-warning">
                                <div class="warning-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="warning-text">
                                    <strong>注意：</strong>导入操作将完全覆盖当前角色的所有数据，包括：
                                    <ul>
                                        <li>聊天记录</li>
                                        <li>短信记录</li>
                                        <li>记忆系统</li>
                                    </ul>
                                    此操作不可撤销，请确保已备份重要数据！
                                </div>
                            </div>
                            <div class="import-file-section">
                                <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="handleImportFileSelect(event)">
                                <button class="import-file-btn" onclick="document.getElementById('import-file-input').click()">
                                    <i class="fas fa-upload"></i>
                                    选择JSON文件
                                </button>
                                <div class="import-file-info" id="import-file-info" style="display: none;">
                                    <div class="file-name" id="import-file-name"></div>
                                    <div class="file-preview" id="import-file-preview"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideImportOptions()">取消</button>
                            <button class="modal-button modal-primary modal-danger" onclick="executeImport()" id="import-execute-btn" disabled>导入并覆盖</button>
                        </div>
                    </div>
                </div>

                <!-- 隐藏的文件输入 -->
                <input type="file" id="character-video-avatar-input" accept="image/*" style="display: none;" onchange="handleCharacterVideoAvatarChange(event)">
                <input type="file" id="user-video-avatar-input" accept="image/*" style="display: none;" onchange="handleUserVideoAvatarChange(event)">

                <!-- 帖子详情和回复界面 -->
                <div id="post-view-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToForum()">‹ </button>
                            <div class="app-title">帖子详情</div>
                        <div class="header-actions">
                            <span id="favorite-btn" class="action-btn" onclick="toggleFavoritePost()" title="收藏">
                                <i class="far fa-star"></i>
                            </span>
                            <span id="share-btn" class="action-btn" onclick="showSharePostModal()" title="分享">
                                <i class="fas fa-share-square"></i>
                            </span>
                        </div>
                    </div>
                    </div>
                    <div class="app-content" id="post-view-content">
                    </div>
                    <div class="reply-input-area">
                        <button id="anonymous-toggle" class="anonymous-toggle-btn" onclick="toggleAnonymousMode()" title="匿名回复">
                            <i class="fas fa-user-secret"></i>
                        </button>
                        <input type="text" id="reply-input" placeholder="输入你的回复...">
                        <button onclick="sendReply()">发送</button>
                    </div>
                </div>

                <!-- 论坛个人主页/收藏夹 -->
                <div id="forum-profile-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToCurrentForum()">‹</button>
                            <div class="app-title">个人主页</div>
                        <div class="header-actions">
                            <span class="action-btn multi-select-toggle-btn" onclick="toggleMultiSelectMode()" title="多选删除" id="multi-select-btn">
                                <i class="fas fa-trash"></i>
                            </span>
                            <span class="action-btn" onclick="showVoteHistory()" title="投票历史">
                                <i class="fas fa-vote-yea"></i>
                            </span>
                        </div>
                    </div>
                    </div>
                    <div class="app-content" style="padding: 0;">
                        <div class="profile-tabs">
                            <div class="profile-tab active" onclick="switchProfileTab('my-posts')">我的帖子</div>
                            <div class="profile-tab" onclick="switchProfileTab('my-favorites')">我的收藏</div>
                        </div>

                        <div id="my-posts-list" class="post-list profile-post-list">
                        </div>
                        <div id="favorite-posts-list" class="post-list profile-post-list" style="display: none;">
                        </div>
                    </div>
                </div>

                <!-- 🎮【新增】五子棋游戏界面 -->
                <div id="gomoku-game-screen" class="app-screen" style="display: none;">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="exitGomokuGame()">‹</button>
                        <div class="app-title">五子棋</div>
                        <!-- 🎮【删除】机器人标志已移除 -->
                    </div>

                    <!-- 🎮【新增】游戏内容容器 -->
                    <div class="app-content">
                        <!-- 游戏区域 (70%) -->
                        <div class="gomoku-game-area">
                        <div class="gomoku-board-container">
                            <div class="gomoku-board" id="gomoku-board">
                                <!-- 棋盘将通过JavaScript动态生成 -->
                            </div>
                        </div>

                        <!-- 🎮【修改】拆开的玩家信息 - AI在左下角 -->
                        <div class="gomoku-player-left">
                            <div class="player-avatar" id="ai-player-avatar">
                                <i class="fas fa-robot"></i>
                                <span class="piece-indicator ai-piece"></span>
                            </div>
                            <div class="player-name" id="ai-player-name" style="display: none;">AI</div>
                        </div>

                        <!-- 🎮【修改】拆开的玩家信息 - 用户在右下角 -->
                        <div class="gomoku-player-right">
                            <div class="player-avatar" id="user-player-avatar">
                                <i class="fas fa-user"></i>
                                <span class="piece-indicator user-piece"></span>
                            </div>
                            <div class="player-name" style="display: none;">你</div>
                        </div>
                    </div>

                    <!-- 聊天区域 (30%) -->
                    <div class="gomoku-chat-area">
                        <div class="gomoku-chat-header">
                            <div class="chat-header-left">
                                <button class="next-game-main-btn" onclick="startNextGomokuGame()" title="开始下一局">
                                    <i class="fas fa-play"></i>
                                    <span>下一局</span>
                                </button>
                            </div>
                            <div class="chat-header-center">
                                <!-- AI头像在计时器左侧 -->
                                <div class="player-avatar" id="ai-player-avatar-header">
                                    <i class="fas fa-robot"></i>
                                    <span class="piece-indicator ai-piece"></span>
                                </div>
                                <div class="game-status" id="gomoku-status">
                                    <div class="current-turn" id="current-turn">你的回合</div>
                                    <div class="game-timer" id="game-timer">00:00</div>
                                </div>
                                <!-- 用户头像在计时器右侧 -->
                                <div class="player-avatar" id="user-player-avatar-header">
                                    <i class="fas fa-user"></i>
                                    <span class="piece-indicator user-piece"></span>
                                </div>
                            </div>
                            <div class="chat-header-right">
                                <div class="chat-actions">
                                    <button class="chat-action-btn undo-btn" onclick="undoGomokuMove()" title="悔棋">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="chat-action-btn surrender-btn" onclick="surrenderGomokuGame()" title="认输">
                                        <i class="fas fa-flag"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="gomoku-chat-messages" id="gomoku-chat-messages">
                            <!-- 游戏聊天消息将在这里显示 -->
                        </div>
                        <div class="gomoku-chat-input">
                            <input type="text" id="gomoku-chat-input" placeholder="在游戏中聊天..." maxlength="200">
                            <button onclick="sendGameChatMessage()" id="send-game-chat-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    <!-- 🎮【结束】游戏内容容器 -->
                    </div>
                </div>

                <!-- 🎮【新增】海龟汤游戏界面 -->
                <div id="turtle-soup-game-screen" class="app-screen turtle-soup-game-container" style="display: none;">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="exitTurtleSoupGame()">‹</button>
                        <div class="app-title">海龟汤</div>
                        <button class="game-settings-button" onclick="showTurtleSoupSettings()">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>

                    <!-- 游戏区域 (60%) -->
                    <div class="turtle-soup-game-area">
                        <!-- DM区域 -->
                        <div class="turtle-soup-dm-section">
                            <div class="turtle-soup-dm-header">
                                <div class="turtle-soup-dm-avatar">
                                    <i class="fas fa-gamepad"></i>
                                </div>
                                <div>
                                    <div class="turtle-soup-dm-name">游戏主持人</div>
                                    <div class="turtle-soup-dm-role">(DM)</div>
                                </div>
                            </div>
                            <div class="turtle-soup-dm-message" id="turtle-soup-dm-message">
                                欢迎来到海龟汤推理游戏！我将为大家主持这场推理之旅...
                            </div>
                        </div>

                        <!-- 汤面展示区域 -->
                        <div class="turtle-soup-story-section">
                            <div class="turtle-soup-story-title">🐢 汤面</div>
                            <div class="turtle-soup-story-content" id="turtle-soup-story-content">
                                请稍等，我正在为你准备一个有趣的推理故事...
                            </div>
                            <div class="turtle-soup-game-status">
                                <div class="turtle-soup-question-count" id="turtle-soup-question-count">
                                    提问次数: 0
                                </div>
                                <div class="turtle-soup-game-timer" id="turtle-soup-game-timer">
                                    00:00
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 聊天区域 (40%) -->
                    <div class="turtle-soup-chat-area">
                        <div class="turtle-soup-chat-header">
                            <span class="turtle-soup-chat-title">推理讨论</span>
                            <!-- 🔥【新增】发言结束按钮 -->
                            <button class="finish-speaking-btn" onclick="finishSpeakingAndTriggerDM()" title="发言结束，让DM回应">
                                <i class="fas fa-check-circle"></i>
                                <span>发言结束</span>
                            </button>
                            <div class="turtle-soup-chat-actions">
                                <button class="chat-action-btn hint-btn" onclick="requestTurtleSoupHint()" title="请求提示">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                                <button class="chat-action-btn give-up-btn" onclick="giveTurtleSoupAnswer()" title="公布答案">
                                    <i class="fas fa-flag"></i>
                                </button>
                                <button class="chat-action-btn new-game-btn" onclick="startNewTurtleSoupGame()" title="新游戏">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="turtle-soup-chat-messages" id="turtle-soup-chat-messages">
                            <!-- 推理聊天消息将在这里显示 -->
                        </div>
                        <div class="turtle-soup-chat-input">
                            <input type="text" id="turtle-soup-chat-input" placeholder="提出你的推理问题（只能问是/否问题）..." maxlength="200">
                            <button onclick="sendTurtleSoupQuestion()" id="send-turtle-soup-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 日记功能界面 - 仿线下模式样式 -->
                <div id="diary-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 日记模式覆盖层 - 仿线下模式 -->
                    <div id="diary-mode-overlay" class="diary-mode-overlay">
                        <div class="diary-mode-header">
                            <button class="back-btn" onclick="backFromDiary()">‹</button>
                            <span class="header-title" id="diary-mode-title">今日日记</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="switchDiaryTab('past')" id="past-diary-btn" title="过往日记">
                                    <i class="fas fa-history"></i>
                                </span>
                                <span class="action-btn" onclick="openDiarySettings()" id="diary-settings-btn" title="日记设置">
                                    <i class="fas fa-cog"></i>
                                </span>
                            </div>
                        </div>

                        <div class="diary-mode-content">
                            <!-- 今日日记内容 -->
                            <div id="today-diary-view" class="diary-view active">
                                <div id="today-diary-content" class="diary-paper-background">
                                    <!-- 日记内容将在这里显示 -->
                                </div>
                            </div>

                            <!-- 过往日记列表 -->
                            <div id="past-diaries-view" class="diary-view">
                                <div id="past-diaries-list" class="past-diaries-list">
                                    <!-- 过往日记列表将在这里显示 -->
                                </div>
                            </div>

                            <!-- 单个过往日记全屏查看 -->
                            <div id="single-diary-view" class="diary-view">
                                <div id="single-diary-content" class="diary-paper-background">
                                    <!-- 单个日记内容将在这里显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 日记设置全屏界面 -->
                <div id="diary-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 日记设置覆盖层 -->
                    <div id="diary-settings-overlay" class="diary-settings-overlay">
                        <div class="diary-settings-header">
                            <button class="back-btn" onclick="backFromDiarySettings()">‹</button>
                            <span class="header-title">日记设置</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="resetDiarySettings()" title="重置设置">
                                    <i class="fas fa-undo"></i>
                                </span>
                            </div>
                        </div>

                        <div class="diary-settings-content">
                            <!-- 实时预览区域 -->
                            <div class="settings-preview-section">
                                <h3>预览效果</h3>
                                <div class="diary-preview-container">
                                    <div id="diary-preview-content" class="diary-preview-paper">
                                        <div class="preview-text">
                                            2024年8月2日 星期五，天气：晴朗

                                            今天是美好的一天，阳光明媚。我在这里写下我的心情和想法。
                                            <mark>这是一段重要的内容</mark>，需要特别标记。
                                            <strike>这是一段后悔写下的话</strike>。
                                            希望每一天都能记录下美好的回忆。
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 设置选项区域 -->
                            <div class="settings-options-section">
                                <!-- 字体设置 -->
                                <div class="setting-group">
                                    <h4><i class="fas fa-font"></i> 字体设置</h4>

                                    <!-- 🔥【移除】字体族选项，使用全局字体设置 -->

                                    <div class="setting-item">
                                        <label>字体大小</label>
                                        <div class="slider-container">
                                            <input type="range" id="font-size-slider" min="12" max="24" value="16" onchange="updateDiarySettings()">
                                            <span id="font-size-value">16px</span>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label>字体粗细</label>
                                        <select id="fontWeightSelect" onchange="setFontWeight(this.value)">
                                            <option value="300">细体</option>
                                            <option value="400">正常</option>
                                            <option value="500" selected>中等</option>
                                            <option value="600">半粗</option>
                                            <option value="700">粗体</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 排版设置 -->
                                <div class="setting-group">
                                    <h4><i class="fas fa-align-left"></i> 排版设置</h4>

                                    <div class="setting-item">
                                        <label>行距</label>
                                        <div class="slider-container">
                                            <input type="range" id="line-height-slider" min="1.2" max="2.5" step="0.1" value="1.6" onchange="updateDiarySettings()">
                                            <span id="line-height-value">1.6</span>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label>段落间距</label>
                                        <div class="slider-container">
                                            <input type="range" id="paragraph-spacing-slider" min="0" max="30" value="15" onchange="updateDiarySettings()">
                                            <span id="paragraph-spacing-value">15px</span>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label>文本对齐</label>
                                        <select id="textAlignSelect" onchange="setTextAlign(this.value)">
                                            <option value="left" selected>左对齐</option>
                                            <option value="center">居中</option>
                                            <option value="right">右对齐</option>
                                            <option value="justify">两端对齐</option>
                                        </select>
                                    </div>

                                    <div class="setting-item">
                                        <label>文本装饰</label>
                                        <select id="textDecorationSelect" onchange="setTextDecoration(this.value)">
                                            <option value="none" selected>无装饰</option>
                                            <option value="underline">下划线</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 内容宽度设置 -->
                                <div class="setting-group">
                                    <h4><i class="fas fa-arrows-alt-h"></i> 内容宽度</h4>

                                    <div class="setting-item">
                                        <label>文本宽度</label>
                                        <div class="slider-container">
                                            <input type="range" id="content-width-slider" min="60" max="100" value="100" onchange="updateDiarySettings()">
                                            <span id="content-width-value">100%</span>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label>左右边距</label>
                                        <div class="slider-container">
                                            <input type="range" id="content-padding-slider" min="10" max="60" value="40" onchange="updateDiarySettings()">
                                            <span id="content-padding-value">40px</span>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label>上边距</label>
                                        <div class="slider-container">
                                            <input type="range" id="content-top-margin-slider" min="0" max="120" value="20" onchange="updateDiarySettings()">
                                            <span id="content-top-margin-value">20px</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 背景纸张设置 -->
                                <div class="setting-group">
                                    <h4><i class="fas fa-image"></i> 背景纸张</h4>
                                    <div class="paper-options">
                                        <div class="paper-option active" onclick="setDiaryPaper('plain')" data-paper="plain">
                                            <div class="paper-preview plain-paper"></div>
                                            <span>白纸</span>
                                        </div>
                                        <div class="paper-option" onclick="setDiaryPaper('vintage')" data-paper="vintage">
                                            <div class="paper-preview vintage-paper"></div>
                                            <span>复古纸</span>
                                        </div>
                                        <div class="paper-option custom-paper" onclick="uploadCustomPaper()">
                                            <div class="paper-preview custom-preview">
                                                <i class="fas fa-plus"></i>
                                            </div>
                                            <span>自定义</span>
                                        </div>
                                    </div>
                                    <input type="file" id="paperImageInput" accept="image/*" style="display: none;" onchange="handlePaperUpload(event)">
                                </div>

                                <!-- 编辑功能 -->
                                <div class="setting-group">
                                    <h4><i class="fas fa-edit"></i> 编辑功能</h4>
                                    <div class="edit-actions">
                                        <button class="btn btn-primary" onclick="editTodayDiary(); backFromDiarySettings();">
                                            <i class="fas fa-pencil-alt"></i> 编辑日记
                                        </button>
                                        <button class="btn btn-secondary" onclick="generateTodayDiary(); backFromDiarySettings();">
                                            <i class="fas fa-sync-alt"></i> 重新生成
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 记忆设置模态框 -->
                <div id="memorySettingsModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>记忆系统设置</h3>
                            <button class="modal-close" onclick="closeMemorySettings()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-group">
                                <label for="aiExtractInterval">AI记忆提取间隔（回合数）</label>
                                <input type="number" id="aiExtractInterval" min="10" max="200" step="10" value="30">
                                <small>每多少回合对话进行一次AI记忆提取（建议20-50回合）</small>
                            </div>

                            <div class="setting-group">
                                <label for="coreMemoryThreshold">核心记忆重要性阈值</label>
                                <input type="range" id="coreMemoryThreshold" min="0.7" max="1.0" step="0.05" value="0.9">
                                <span id="coreThresholdValue">90%</span>
                                <small>只有重要性超过此阈值的记忆才会成为核心记忆</small>
                            </div>

                            <div class="setting-group">
                                <label for="episodicMemoryThreshold">情景记忆重要性阈值</label>
                                <input type="range" id="episodicMemoryThreshold" min="0.4" max="0.8" step="0.05" value="0.6">
                                <span id="episodicThresholdValue">60%</span>
                                <small>重要性在此范围内的记忆会成为情景记忆</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeMemorySettings()">取消</button>
                            <button class="btn btn-primary" onclick="saveMemorySettings()">保存设置</button>
                        </div>
                    </div>
                </div>

                <!-- 线下预设设置模态框 -->
                <div id="offline-preset-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>线下剧情预设</h3>
                            <button class="modal-close" onclick="closeOfflinePresetSettings()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- 已保存的预设列表 -->
                            <div class="form-group">
                                <label>已保存的预设</label>
                                <div id="saved-presets-list" class="saved-presets-list">
                                    <!-- 预设列表将在这里动态生成 -->
                                </div>
                            </div>

                            <!-- 新建/编辑预设表单 -->
                            <div class="form-group">
                                <label for="offline-preset-name">预设名称</label>
                                <input type="text" id="offline-preset-name" placeholder="为这个预设起个名字..." maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="offline-preset-content">剧情预设内容</label>
                                <textarea id="offline-preset-content" rows="6" placeholder="请输入线下剧情模式的预设内容，这将决定AI的文风、字数、视角等...&#10;&#10;例如：&#10;- 以第三人称视角描述&#10;- 每次回复200-400字&#10;- 注重环境描写和心理活动&#10;- 营造浪漫/悬疑/冒险等氛围"></textarea>
                            </div>
                            <div class="form-group">
                                <label>预设说明</label>
                                <div class="preset-help-text">
                                    <p>• 预设内容将作为AI回复的重要指导</p>
                                    <p>• 可以指定文风、字数、视角、氛围等</p>
                                    <p>• 支持情景描写、动作描写、心理描写</p>
                                    <p>• 预设权重很高，会显著影响AI的回复风格</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeOfflinePresetSettings()">取消</button>
                            <button class="btn btn-secondary" onclick="clearPresetForm()">清空表单</button>
                            <button class="btn btn-primary" onclick="saveOfflinePreset()">保存预设</button>
                        </div>
                    </div>
                </div>

                <!-- 线下模式聊天记录模态框 -->
                <div id="offline-history-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>线下模式聊天记录</h3>
                            <button class="modal-close" onclick="closeOfflineHistoryModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="offline-history-list" class="offline-history-list">
                                <!-- 聊天记录列表将在这里动态生成 -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeOfflineHistoryModal()">关闭</button>
                            <button class="btn btn-danger" onclick="clearAllOfflineHistory()">清空所有记录</button>
                        </div>
                    </div>
                </div>

                <!-- 纪念日表单模态框 -->
                <div id="anniversary-form-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="anniversary-form-title">添加纪念日</h3>
                            <button class="modal-close" onclick="closeAnniversaryForm()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="anniversary-name">纪念日名称</label>
                                <input type="text" id="anniversary-name" placeholder="例如：小雪的生日" maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="anniversary-date">日期</label>
                                <input type="date" id="anniversary-date">
                            </div>
                            <div class="form-group">
                                <label for="anniversary-type">类型</label>
                                <select id="anniversary-type" onchange="toggleCustomTypeInput('anniversary')">
                                    <option value="birthday">生日</option>
                                    <option value="relationship">确定关系</option>
                                    <option value="anniversary">纪念日</option>
                                    <option value="holiday">节日</option>
                                    <option value="family">家人生日</option>
                                    <option value="other">其他</option>
                                </select>
                            </div>
                            <div class="form-group" id="anniversary-custom-type-group" style="display: none;">
                                <label for="anniversary-custom-type">自定义类型</label>
                                <input type="text" id="anniversary-custom-type" placeholder="请输入自定义类型..." maxlength="20">
                            </div>
                            <div class="form-group">
                                <label for="anniversary-character">相关角色</label>
                                <select id="anniversary-character" onchange="toggleCharacterQuoteGroup('anniversary', this.value)">
                                    <option value="">选择角色（可选）</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="anniversary-description">描述（可选）</label>
                                <textarea id="anniversary-description" rows="3" placeholder="添加一些备注..." maxlength="200"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="anniversary-user-quote">我的语录</label>
                                <textarea id="anniversary-user-quote" rows="2" placeholder="你对这个纪念日的感想..." maxlength="150"></textarea>
                            </div>
                            <div class="form-group" id="anniversary-character-quote-group" style="display: none;">
                                <label for="anniversary-character-quote" id="anniversary-quote-label">角色语录</label>
                                <textarea id="anniversary-character-quote" rows="2" placeholder="角色对这个纪念日的感想..." maxlength="150"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="anniversary-count-type">天数计算方式</label>
                                <select id="anniversary-count-type">
                                    <option value="countdown">倒数</option>
                                    <option value="countup">正数</option>
                                </select>
                                <small class="form-hint">选择显示"还有X天"还是"已经X天"</small>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="anniversary-yearly" checked>
                                    每年重复
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="anniversary-shared">
                                    与角色共享（角色也能看到这个纪念日）
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="anniversary-pinned">
                                    置顶显示（在纪念日列表顶部大卡片显示）
                                </label>
                            </div>
                            <div class="form-group" id="anniversary-background-group">
                                <label for="anniversary-background-upload">背景图片（可选）</label>
                                <input type="file" id="anniversary-background-upload" accept="image/*" onchange="handleAnniversaryBackgroundUpload(this)">
                                <small class="form-hint">用于置顶显示和主屏幕小组件背景</small>
                                <div id="anniversary-background-preview" class="background-preview" style="display: none;">
                                    <img id="anniversary-background-img" src="" alt="背景预览">
                                    <button type="button" class="remove-background-btn" onclick="removeAnniversaryBackground()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group" id="anniversary-user-avatar-group">
                                <label for="anniversary-user-avatar-upload">你的头像（可选）</label>
                                <input type="file" id="anniversary-user-avatar-upload" accept="image/*" onchange="handleAnniversaryUserAvatarUpload(this)">
                                <small class="form-hint">用于置顶显示时显示你的身份</small>
                                <div id="anniversary-user-avatar-preview" class="avatar-preview" style="display: none;">
                                    <img id="anniversary-user-avatar-img" src="" alt="头像预览">
                                    <button type="button" class="remove-avatar-btn" onclick="removeAnniversaryUserAvatar()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAnniversaryForm()">取消</button>
                            <button class="btn btn-primary" onclick="saveAnniversary()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 约定表单模态框 -->
                <div id="appointment-form-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="appointment-form-title">添加约定</h3>
                            <button class="modal-close" onclick="closeAppointmentForm()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="appointment-name">约定名称</label>
                                <input type="text" id="appointment-name" placeholder="例如：和小雪去看电影" maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="appointment-date">日期</label>
                                <input type="date" id="appointment-date">
                            </div>
                            <div class="form-group">
                                <label for="appointment-time">时间</label>
                                <input type="time" id="appointment-time">
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="appointment-never-expires" onchange="toggleNeverExpires('appointment')">
                                    永不过期
                                </label>
                                <small class="form-hint">勾选后，此约定将不会显示剩余天数，适合长期承诺</small>
                            </div>
                            <div class="form-group">
                                <label for="appointment-type">类型</label>
                                <select id="appointment-type" onchange="toggleCustomTypeInput('appointment')">
                                    <option value="date">约会</option>
                                    <option value="promise">承诺</option>
                                    <option value="activity">活动</option>
                                    <option value="meeting">见面</option>
                                    <option value="task">任务</option>
                                    <option value="other">其他</option>
                                </select>
                            </div>
                            <div class="form-group" id="appointment-custom-type-group" style="display: none;">
                                <label for="appointment-custom-type">自定义类型</label>
                                <input type="text" id="appointment-custom-type" placeholder="请输入自定义类型..." maxlength="20">
                            </div>
                            <div class="form-group">
                                <label for="appointment-character">相关角色</label>
                                <select id="appointment-character" onchange="toggleCharacterQuoteGroup('appointment', this.value)">
                                    <option value="">选择角色（可选）</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="appointment-priority">重要程度</label>
                                <select id="appointment-priority">
                                    <option value="low">一般</option>
                                    <option value="medium" selected>重要</option>
                                    <option value="high">很重要</option>
                                    <option value="urgent">非常重要</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="appointment-description">描述（可选）</label>
                                <textarea id="appointment-description" rows="3" placeholder="添加一些备注..." maxlength="200"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="appointment-user-quote">我的语录</label>
                                <textarea id="appointment-user-quote" rows="2" placeholder="你对这个约定的感想..." maxlength="150"></textarea>
                            </div>
                            <div class="form-group" id="appointment-character-quote-group" style="display: none;">
                                <label for="appointment-character-quote" id="appointment-quote-label">角色语录</label>
                                <textarea id="appointment-character-quote" rows="2" placeholder="角色对这个约定的感想..." maxlength="150"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="appointment-count-type">天数计算方式</label>
                                <select id="appointment-count-type">
                                    <option value="countdown">倒数</option>
                                    <option value="countup">正数</option>
                                </select>
                                <small class="form-hint">选择显示"还有X天"还是"已经X天"</small>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="appointment-shared">
                                    与角色共享（角色也能看到这个约定）
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="appointment-pinned">
                                    置顶显示（在约定列表顶部大卡片显示）
                                </label>
                            </div>
                            <div class="form-group" id="appointment-background-group">
                                <label for="appointment-background-upload">背景图片（可选）</label>
                                <input type="file" id="appointment-background-upload" accept="image/*" onchange="handleAppointmentBackgroundUpload(this)">
                                <small class="form-hint">用于置顶显示背景</small>
                                <div id="appointment-background-preview" class="background-preview" style="display: none;">
                                    <img id="appointment-background-img" src="" alt="背景预览">
                                    <button type="button" class="remove-background-btn" onclick="removeAppointmentBackground()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group" id="appointment-user-avatar-group">
                                <label for="appointment-user-avatar-upload">你的头像（可选）</label>
                                <input type="file" id="appointment-user-avatar-upload" accept="image/*" onchange="handleAppointmentUserAvatarUpload(this)">
                                <small class="form-hint">用于置顶显示时显示你的身份</small>
                                <div id="appointment-user-avatar-preview" class="avatar-preview" style="display: none;">
                                    <img id="appointment-user-avatar-img" src="" alt="头像预览">
                                    <button type="button" class="remove-avatar-btn" onclick="removeAppointmentUserAvatar()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAppointmentForm()">取消</button>
                            <button class="btn btn-primary" onclick="saveAppointment()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 图片小组件设置模态框 -->
                <div id="photo-widget-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>图片小组件</h3>
                            <button class="modal-close" onclick="closePhotoWidgetModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="widget-photo-upload">选择图片</label>
                                <input type="file" id="widget-photo-upload" accept="image/*" onchange="handlePhotoWidgetUpload(this)">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-secondary" onclick="clearPhotoWidget()">清除图片</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closePhotoWidgetModal()">关闭</button>
                        </div>
                    </div>
                </div>

                <!-- 纪念日小组件设置模态框 -->
                <div id="anniversary-widget-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>纪念日小组件</h3>
                            <button class="modal-close" onclick="closeAnniversaryWidgetModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="widget-anniversary-select">选择要显示的纪念日</label>
                                <select id="widget-anniversary-select" onchange="updateAnniversaryWidget()">
                                    <option value="">请选择纪念日</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-secondary" onclick="clearAnniversaryWidget()">清除显示</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAnniversaryWidgetModal()">关闭</button>
                        </div>
                    </div>
                </div>

                <!-- 线下模式界面设置模态框 -->
                <div id="offline-ui-settings-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>线下模式界面设置</h3>
                            <button class="modal-close" onclick="closeOfflineUISettings()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- 气泡颜色设置 -->
                            <div class="form-group">
                                <label>气泡颜色设置</label>
                                <div class="color-setting-group">
                                    <div class="color-picker-container">
                                        <div class="flex-gap-15">
                                            <div class="flex-1">
                                                <label class="label-small">我的气泡</label>
                                                <input type="color" id="offline-my-bubble-color" class="color-input" value="#007AFF">
                                            </div>
                                            <div class="flex-1">
                                                <label class="label-small">角色气泡</label>
                                                <input type="color" id="offline-ai-bubble-color" class="color-input" value="#f0f0f0">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 透明度设置 -->
                            <div class="form-group">
                                <label>气泡透明度</label>
                                <div class="opacity-setting">
                                    <input type="range" id="offline-bubble-opacity" class="theme-range" min="0" max="1" step="0.01" value="0.9">
                                    <span id="offline-opacity-value">90%</span>
                                </div>
                            </div>



                            <!-- 🔥【新增】字体大小设置 -->
                            <div class="form-group">
                                <label>字体大小</label>
                                <div class="opacity-setting">
                                    <input type="range" id="offline-font-size" class="theme-range" min="12" max="24" step="1" value="15">
                                    <span id="offline-font-size-value">15px</span>
                                </div>
                            </div>

                            <!-- 壁纸设置 -->
                            <div class="form-group">
                                <label>背景壁纸</label>
                                <div class="wallpaper-setting">
                                    <input type="file" id="offline-wallpaper-file" accept="image/*" class="form-input" onchange="handleOfflineWallpaperUpload(this)">
                                    <button type="button" class="theme-button theme-button-secondary" onclick="clearOfflineWallpaper()">清除</button>
                                </div>
                            </div>

                            <!-- 字体设置 -->
                            <div class="form-group">
                                <label>字体设置</label>
                                <div class="font-setting">
                                    <select id="offline-font-select" class="form-input" onchange="handleOfflineFontChange()">
                                        <option value="">系统默认字体</option>
                                        <option value="custom">自定义字体URL...</option>
                                    </select>
                                    <div id="custom-font-input" style="display: none; margin-top: 10px;">
                                        <input type="url" id="offline-font-url" placeholder="例如：https://fonts.googleapis.com/css2?family=Noto+Sans+SC 或直接字体文件URL" class="form-input">
                                        <button type="button" class="theme-button theme-button-secondary" onclick="previewOfflineFont()">预览</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 文字颜色设置 -->
                            <div class="form-group">
                                <label>文字颜色设置</label>
                                <div class="text-color-setting">
                                    <!-- 用户消息文字颜色 -->
                                    <div class="color-section">
                                        <label class="section-label">用户消息文字颜色</label>
                                        <div class="color-picker-container">
                                            <div class="flex-gap-15">
                                                <div class="flex-1">
                                                    <label class="label-small">普通文字</label>
                                                    <input type="color" id="offline-user-normal-text-color" class="color-input" value="#ffffff">
                                                    <div class="saved-colors" id="offline-user-normal-saved-colors"></div>
                                                </div>
                                                <div class="flex-1">
                                                    <label class="label-small">斜体文字</label>
                                                    <input type="color" id="offline-user-italic-text-color" class="color-input" value="#f0f0f0">
                                                    <div class="saved-colors" id="offline-user-italic-saved-colors"></div>
                                                </div>
                                                <div class="flex-1">
                                                    <label class="label-small">加粗文字</label>
                                                    <input type="color" id="offline-user-bold-text-color" class="color-input" value="#ffffff">
                                                    <div class="saved-colors" id="offline-user-bold-saved-colors"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 角色消息文字颜色 -->
                                    <div class="color-section">
                                        <label class="section-label">角色消息文字颜色</label>
                                        <div class="color-picker-container">
                                            <div class="flex-gap-15">
                                                <div class="flex-1">
                                                    <label class="label-small">普通文字</label>
                                                    <input type="color" id="offline-ai-normal-text-color" class="color-input" value="#000000">
                                                    <div class="saved-colors" id="offline-ai-normal-saved-colors"></div>
                                                </div>
                                                <div class="flex-1">
                                                    <label class="label-small">斜体文字</label>
                                                    <input type="color" id="offline-ai-italic-text-color" class="color-input" value="#666666">
                                                    <div class="saved-colors" id="offline-ai-italic-saved-colors"></div>
                                                </div>
                                                <div class="flex-1">
                                                    <label class="label-small">加粗文字</label>
                                                    <input type="color" id="offline-ai-bold-text-color" class="color-input" value="#333333">
                                                    <div class="saved-colors" id="offline-ai-bold-saved-colors"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 预存颜色功能 -->
                            <div class="form-group">
                                <label>颜色管理</label>
                                <div class="color-management">
                                    <button type="button" class="theme-button theme-button-secondary" onclick="saveCurrentOfflineColors()">保存当前颜色</button>
                                    <button type="button" class="theme-button theme-button-secondary" onclick="resetOfflineColors()">重置为默认</button>
                                </div>
                            </div>

                            <!-- 头像设置 -->
                            <div class="form-group">
                                <label>头像设置</label>
                                <div class="avatar-setting">
                                    <div class="setting-row">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="offline-show-user-avatar" checked>
                                            显示用户头像
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="offline-show-ai-avatar" checked>
                                            显示角色头像
                                        </label>
                                    </div>
                                    <div class="setting-row">
                                        <label class="radio-label">头像位置：</label>
                                        <div class="radio-options">
                                            <div class="radio-option-button selected" onclick="selectAvatarPosition('side', this)">
                                                <div class="radio-indicator"></div>
                                                侧边显示
                                            </div>
                                            <div class="radio-option-button" onclick="selectAvatarPosition('custom', this)">
                                                <div class="radio-indicator"></div>
                                                自定义CSS控制
                                            </div>
                                            <input type="radio" name="offline-avatar-position" value="side" checked style="display: none;">
                                            <input type="radio" name="offline-avatar-position" value="custom" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 气泡样式设置 -->
                            <div class="form-group">
                                <label>气泡样式设置</label>
                                <div class="bubble-style-setting">
                                    <div class="setting-row">
                                        <label class="radio-label">气泡宽度：</label>
                                        <div class="radio-options">
                                            <div class="radio-option-button selected" onclick="selectBubbleWidth('default', this)">
                                                <div class="radio-indicator"></div>
                                                智能宽度
                                            </div>
                                            <div class="radio-option-button" onclick="selectBubbleWidth('custom', this)">
                                                <div class="radio-indicator"></div>
                                                自定义CSS控制
                                            </div>
                                            <input type="radio" name="offline-bubble-width" value="default" checked style="display: none;">
                                            <input type="radio" name="offline-bubble-width" value="custom" style="display: none;">
                                        </div>
                                    </div>
                                    <div class="setting-row">
                                        <label class="radio-label">气泡样式：</label>
                                        <div class="radio-options">
                                            <div class="radio-option-button selected" onclick="selectBubbleStyle('default', this)">
                                                <div class="radio-indicator"></div>
                                                默认样式
                                            </div>
                                            <div class="radio-option-button" onclick="selectBubbleStyle('custom', this)">
                                                <div class="radio-indicator"></div>
                                                自定义CSS控制
                                            </div>
                                            <input type="radio" name="offline-bubble-style" value="default" checked style="display: none;">
                                            <input type="radio" name="offline-bubble-style" value="custom" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 自定义CSS设置 -->
                            <div class="form-group">
                                <label>自定义CSS代码</label>
                                <div class="custom-css-setting">
                                    <textarea id="offline-custom-css" rows="8" class="form-input" placeholder="在这里输入自定义CSS代码来控制头像位置、气泡样式、气泡大小等...&#10;&#10;示例：&#10;/* 调整气泡宽度 */&#10;.offline-message-content {&#10;    max-width: 70% !important;&#10;}&#10;&#10;/* 调整头像位置 */&#10;.offline-avatar {&#10;    position: absolute;&#10;    top: -10px;&#10;    right: -10px;&#10;}"></textarea>
                                    <div class="css-buttons">
                                        <button type="button" class="theme-button theme-button-secondary" onclick="previewOfflineCSS()">预览CSS</button>
                                        <button type="button" class="theme-button theme-button-secondary" onclick="clearOfflineCSS()">清除CSS</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 预览区域 -->
                            <div class="form-group">
                                <label>效果预览</label>
                                <div class="offline-preview-area" id="offline-preview-area">
                                    <div class="offline-preview-message user">
                                        <div class="offline-avatar user-avatar" id="preview-user-avatar">👤</div>
                                        <div class="offline-preview-content">
                                            这是用户消息的预览效果，包含<em>斜体文字</em>和<strong>加粗文字</strong>
                                        </div>
                                    </div>
                                    <div class="offline-preview-message ai">
                                        <div class="offline-avatar ai-avatar" id="preview-ai-avatar">🤖</div>
                                        <div class="offline-preview-content">
                                            这是角色回复的预览效果，包含<em>斜体文字</em>和<strong>加粗文字</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeOfflineUISettings()">取消</button>
                            <button class="btn btn-secondary" onclick="resetOfflineUISettings()">重置</button>
                            <button class="btn btn-primary" onclick="saveOfflineUISettings()">保存设置</button>
                        </div>
                    </div>
                </div>





                <!-- 记忆查看器界面 -->
                <div id="memory-viewer-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('memory-viewer-screen')">‹</button>

                            <div class="app-title">记忆查看器</div>
                        <div class="header-actions">
                            <!-- 右侧放3个按钮：设置、刷新、清理错误记录 -->
                            <button class="header-action-btn" onclick="showMemorySettings()" title="记忆设置">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button class="header-action-btn" onclick="refreshMemoryData()" title="刷新">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="header-action-btn" onclick="cleanupIncorrectRecords()" title="清理错误记录">
                                <i class="fas fa-tools"></i>
                            </button>
                        </div>
                    </div>
                    </div>
                    <div class="app-content">
                        <!-- 角色选择器 -->
                        <div class="memory-character-selector">
                            <label for="memory-character-select">选择角色：</label>
                            <select id="memory-character-select" onchange="loadCharacterMemories()">
                                <option value="">请选择角色</option>
                            </select>
                        </div>

                        <!-- 搜索和过滤 -->
                        <div class="memory-search-section">
                            <div class="memory-search-bar">
                                <input type="text" id="memory-search-input" placeholder="搜索记忆内容..." oninput="filterMemories()">
                                <button class="search-btn" onclick="filterMemories()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="memory-filter-tabs">
                                <button class="memory-filter-tab active" data-type="all" onclick="switchMemoryFilter('all')">全部</button>
                                <button class="memory-filter-tab" data-type="core" onclick="switchMemoryFilter('core')">核心记忆</button>
                                <button class="memory-filter-tab" data-type="episodic" onclick="switchMemoryFilter('episodic')">情景记忆</button>
                                <button class="memory-filter-tab" data-type="storyline" onclick="switchMemoryFilter('storyline')">剧情总结</button>
                                <button class="memory-filter-tab" data-type="timeline" onclick="switchMemoryFilter('timeline')">时间线</button>
                            </div>
                        </div>

                        <!-- 记忆内容显示区域 -->
                        <div class="memory-content-area">
                            <div id="memory-list" class="memory-list">
                                <div class="memory-empty-state">
                                    <i class="fas fa-brain"></i>
                                    <p>请选择角色查看记忆</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 世界书编辑表单 -->
                <div id="worldbook-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideWorldbookForm()">‹</button>
                        <div class="app-title" id="worldbook-form-title">新建世界书</div>
                        <button class="save-worldbook-btn save-btn-absolute" onclick="saveWorldbook()">保存</button>
                    </div>
                    <div class="app-content">
                        <div class="worldbook-form">
                            <div class="form-group">
                                <label class="form-label">标题</label>
                                <input type="text" id="worldbook-title" class="form-input" placeholder="请输入世界书标题">
                            </div>
                            <div class="form-group">
                                <label class="form-label">内容</label>
                                <textarea id="worldbook-content" class="form-textarea textarea-large" placeholder="请输入世界书内容，这里可以描述角色背景、世界观设定等..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- 聊天设置界面 -->
                <div id="api-chat-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideChatSettings()">‹</button>
                        <div class="app-title">聊天设置</div>
                    </div>
                    <div class="app-content padding-none-flex overflow-auto">
                        <div class="settings-container">

                            <!-- 群聊专用设置 - 仿QQ/微信群聊界面 -->
                            <div class="settings-section" id="group-chat-settings" style="display: none;">
                                <!-- 群聊信息卡片 -->
                                <div class="group-info-card">
                                    <div class="group-avatar-section" onclick="changeGroupAvatar()">
                                        <img id="group-avatar-preview" src="" class="group-avatar-large" alt="群头像">
                                        <div class="group-avatar-edit-hint">点击修改</div>
                                    </div>
                                    <div class="group-basic-info">
                                        <div class="group-name" onclick="changeGroupName()" id="group-name-display">群聊名称</div>
                                        <div class="group-member-count" id="group-member-count-display">0名成员</div>
                                        <div class="group-description" onclick="editGroupDescription()" id="group-description-display">群公告：点击设置群公告</div>
                                    </div>
                                </div>

                                <!-- 群成员展示区域 -->
                                <div class="group-members-section">
                                    <div class="section-title">群成员</div>
                                    <div class="group-members-grid" id="group-members-grid">
                                        <!-- 群成员头像将动态生成 -->
                                        <div class="member-item add-member" onclick="addGroupMember()">
                                            <div class="member-avatar">
                                                <i class="fas fa-plus"></i>
                                            </div>
                                            <div class="member-name">邀请</div>
                                        </div>
                                        <div class="member-item remove-member" onclick="removeGroupMember()">
                                            <div class="member-avatar">
                                                <i class="fas fa-minus"></i>
                                            </div>
                                            <div class="member-name">移除</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 群功能设置 -->
                                <div class="setting-card">
                                    <div class="setting-item" onclick="changeMyGroupNickname()">
                                        <div class="setting-left">
                                            <div class="setting-label">我在本群的昵称</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-my-group-nickname">未选择</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showGroupNotice()">
                                        <div class="setting-left">
                                            <div class="setting-label">群公告</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value">查看详情</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                </div>


                            </div>

                            <!-- 聊天窗口设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-user-edit section-icon"></i>
                                    <span class="section-title">聊天窗口设置</span>
                                </div>
                                <div class="setting-card">
                                    <!-- 身份选择功能已移除，身份在创建对话时选择 -->
                                    <!-- 单聊时显示双方设置，群聊时隐藏 -->
                                    <div class="setting-item single-chat-only" onclick="showAvatarSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">双方头像设置</div>
                                            <div class="setting-desc">设置在此聊天窗口中显示的头像</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item single-chat-only" onclick="showNicknameSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">双方备注设置</div>
                                            <div class="setting-desc">设置在此聊天窗口中显示的昵称</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBackgroundSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">聊天背景设置</div>
                                            <div class="setting-desc">自定义聊天界面的背景图片</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBubbleStyleSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">气泡样式设置</div>
                                            <div class="setting-desc">选择气泡外观样式和颜色</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-bubble-style">默认样式</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item single-chat-only">
                                        <div class="setting-left">
                                            <div class="setting-label">显示角色状态</div>
                                            <div class="setting-desc">在聊天界面显示角色的在线状态和活动</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="character-status-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- 🔥【新增】状态更新频率设置 -->
                                    <div class="setting-item single-chat-only" id="status-frequency-setting" style="display: none;">
                                        <div class="setting-left">
                                            <div class="setting-label">状态更新频率</div>
                                            <div class="setting-desc">控制角色状态的检查和更新频率</div>
                                        </div>
                                        <div class="setting-right">
                                            <select class="setting-select" id="status-update-frequency">
                                                <option value="high">高频 (30秒)</option>
                                                <option value="medium-high">中高频 (1分钟)</option>
                                                <option value="medium">中频 (3分钟)</option>
                                                <option value="medium-low">中低频 (5分钟)</option>
                                                <option value="low">低频 (10分钟)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 戳一戳功能设置 - 单聊特有 -->
                            <div class="settings-section" id="poke-settings-section">
                                <div class="section-header">
                                    <i class="fas fa-hand-paper section-icon"></i>
                                    <span class="section-title">戳一戳功能</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" id="poke-suffix-settings" onclick="showPokeSuffixSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">戳一戳后缀设置</div>
                                            <div class="setting-desc">自定义双方的戳一戳动作后缀</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 记忆设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-brain section-icon"></i>
                                    <span class="section-title">记忆设置</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showHistorySettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">附带历史消息数</div>
                                            <div class="setting-desc">自定义角色回复时参考的历史对话数量</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-history-count">5回合</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                    <div class="setting-item" onclick="showGlobalMemorySettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">全局记忆系统</div>
                                            <div class="setting-desc">智能记忆管理，让角色记住重要的聊天内容</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="global-memory-status">7天记忆</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item single-chat-only" onclick="showMemoryShareSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">与群聊共享记忆</div>
                                            <div class="setting-desc">让角色在单聊中记住群聊的内容</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="memory-share-status">已关闭</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showWorldbookMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">挂载世界书</div>
                                            <div class="setting-desc">让角色参考选定的世界书内容作为背景知识</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-worldbook-mount">未挂载</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showEmojiLibraryMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">挂载表情包库</div>
                                            <div class="setting-desc">选择在此聊天中可使用的表情包库</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-emoji-library-mount">未挂载</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 时间感知设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-clock section-icon"></i>
                                    <span class="section-title">时间感知</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">时间感知开关</div>
                                            <div class="setting-desc">角色会感知当前时间并调整回复</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="time-awareness-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 通话设置 - 仅在单聊时显示 -->
                            <div class="settings-section single-chat-only">
                                <div class="section-header">
                                    <i class="fas fa-phone section-icon"></i>
                                    <span class="section-title">通话设置</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">角色主动拨打电话</div>
                                            <div class="setting-desc">允许角色根据对话内容主动发起通话</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-call-enabled" class="ai-call-enabled-checkbox">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <!-- 🔥【新增】通话形象设置 - 仅在单聊时显示 -->
                                    <div class="setting-item single-chat-only" id="video-avatar-setting" style="display: none;" onclick="showVideoAvatarModal()">
                                        <div class="setting-left">
                                            <div class="setting-label">通话形象设置</div>
                                            <div class="setting-desc">设置双方视频通话时使用的形象</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AI心率监测 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-heartbeat section-icon"></i>
                                    <span class="section-title">角色心率监测</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">心率监测显示</div>
                                            <div class="setting-desc">在状态栏显示角色的情感心率</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-heartrate-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>





                            <!-- 后台互动设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-robot section-icon"></i>
                                    <span class="section-title">后台互动</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">后台互动开关</div>
                                            <div class="setting-desc">角色可在后台主动活动并发送推送</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="background-interaction-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="background-interaction-details hide" id="background-interaction-settings">
                                        <div class="setting-item">
                                        <div class="setting-left">
                                                <div class="setting-label">主动聊天</div>
                                                <div class="setting-desc">角色在你10分钟未回复时主动发消息</div>
                                        </div>
                                        <div class="setting-right">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="background-chat-enabled">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                        </div>
                                    </div>

                                        <div class="setting-item" id="chat-frequency-setting" style="display: none;">
                                        <div class="setting-left">
                                                <div class="setting-label">主动聊天频率</div>
                                                <div class="setting-desc">角色主动发起对话的频率</div>
                                        </div>
                                        <div class="setting-right">
                                                <select id="background-chat-frequency" class="setting-select">
                                                    <option value="low">低 (1-2小时/次)</option>
                                                    <option value="medium">中 (30-60分钟/次)</option>
                                                    <option value="high">高 (10-30分钟/次)</option>
                                                </select>
                                </div>
                            </div>

                                    <div class="setting-item">
                                        <div class="setting-left">
                                                <div class="setting-label">主动发动态</div>
                                                <div class="setting-desc">角色根据人设主动发布动态</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                    <input type="checkbox" id="background-moments-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                        <div class="setting-item" id="moments-frequency-setting" style="display: none; justify-content: space-between !important; align-items: center !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">主动发动态频率</div>
                                                <div class="setting-desc">角色主动发布社交动态的频率</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; align-items: center !important; flex-shrink: 0 !important;">
                                                <select id="background-moments-frequency" class="setting-select">
                                                    <option value="low">低 (4-8小时/次)</option>
                                                    <option value="medium">中 (2-4小时/次)</option>
                                                    <option value="high">高 (1-2小时/次)</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="setting-item" id="scheduled-moments-setting" style="display: none; justify-content: space-between !important; align-items: center !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">定时发布动态</div>
                                                <div class="setting-desc">设置固定时间点自动发布动态</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; align-items: center !important; gap: 8px !important; flex-shrink: 0 !important;">
                                                <button onclick="showScheduleTimesModal()" style="background-color: #4a84c1; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    <span id="schedule-times-display">未设置</span>
                                                </button>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="scheduled-moments-enabled">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="setting-item" id="test-publish-setting" style="display: none; justify-content: space-between !important; align-items: center !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">测试发布</div>
                                                <div class="setting-desc">让角色立即发布一条测试动态</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; align-items: center !important; flex-shrink: 0 !important; gap: 8px;">
                                                <button onclick="testPublishMoment()" style="background-color: #4a84c1; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    发布
                                                </button>
                                                <button onclick="fixAvatarData()" style="background-color: #ff6b6b; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    修复头像
                                                </button>
                                            </div>
                                        </div>

                                        <!-- 🔥【新增】后台写日记设置 -->
                                        <div class="setting-item">
                                            <div class="setting-left">
                                                <div class="setting-label">后台写日记</div>
                                                <div class="setting-desc">角色可在指定时间自动写日记</div>
                                            </div>
                                            <div class="setting-right">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="background-diary-enabled">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="setting-item" id="diary-time-setting" style="display: none; justify-content: space-between !important; align-items: flex-start !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">写日记时间</div>
                                                <div class="setting-desc">设置角色每天写日记的时间点（支持±5分钟波动）</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; flex-direction: column !important; align-items: flex-end !important; gap: 8px !important; flex-shrink: 0 !important;">
                                                <input type="time" id="diary-time-input" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px;">
                                                <button onclick="saveDiaryTime()" style="background-color: #4a84c1; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    保存时间
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- 其他设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-cog section-icon"></i>
                                    <span class="section-title">其他设置</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">显示时间戳</div>
                                            <div class="setting-desc">在聊天消息中显示时间信息</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="timestamp-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showTimestampSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">时间戳设置</div>
                                            <div class="setting-desc">设置时间戳显示位置和格式</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="searchChatContent()">
                                        <div class="setting-left">
                                            <div class="setting-label">查找聊天内容</div>
                                            <div class="setting-desc">搜索历史消息中的关键词</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showExportOptions()">
                                        <div class="setting-left">
                                            <div class="setting-label">导出聊天记录</div>
                                            <div class="setting-desc">导出当前角色的完整数据</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showImportOptions()">
                                        <div class="setting-left">
                                            <div class="setting-label">导入聊天记录</div>
                                            <div class="setting-desc">导入角色的完整数据</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- 🔥【新增】角色专属音效设置 -->
                            <div class="settings-section" id="character-sound-settings" style="display: none;">
                                <div class="section-header">
                                    <i class="fas fa-volume-up section-icon"></i>
                                    <span class="section-title">专属音效</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">启用专属音效</div>
                                            <div class="setting-desc">为该角色设置独特的音效</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="character-sound-enabled" onchange="toggleCharacterSounds()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                    <div id="character-sound-list" style="display: none;">
                                        <!-- 接收消息音效 -->
                                        <div class="character-sound-item">
                                            <div class="character-sound-header">
                                                <h4>接收消息音效</h4>
                                                <p>该角色发消息时播放的音效</p>
                                            </div>
                                            <div class="character-sound-controls">
                                                <input type="url" class="sound-url-input" id="character-messageReceived-url" placeholder="输入音效链接">
                                                <input type="file" id="character-messageReceived-file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" style="display: none;" onchange="handleCharacterSoundFileUpload(this, 'messageReceived')">
                                                <button onclick="document.getElementById('character-messageReceived-file').click()" class="sound-file-btn">
                                                    <i class="fas fa-upload"></i> 本地文件
                                                </button>
                                                <button onclick="testCharacterSound('messageReceived')" class="sound-test-btn">
                                                    <i class="fas fa-play"></i> 试听
                                                </button>
                                                <button onclick="clearCharacterSound('messageReceived')" class="sound-clear-btn">
                                                    <i class="fas fa-trash"></i> 清除
                                                </button>
                                            </div>
                                        </div>

                                        <!-- 来电音效 -->
                                        <div class="character-sound-item">
                                            <div class="character-sound-header">
                                                <h4>来电音效</h4>
                                                <p>该角色拨打语音/视频通话时播放的音效</p>
                                            </div>
                                            <div class="character-sound-controls">
                                                <input type="url" class="sound-url-input" id="character-incomingCall-url" placeholder="输入音效链接">
                                                <input type="file" id="character-incomingCall-file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" style="display: none;" onchange="handleCharacterSoundFileUpload(this, 'incomingCall')">
                                                <button onclick="document.getElementById('character-incomingCall-file').click()" class="sound-file-btn">
                                                    <i class="fas fa-upload"></i> 本地文件
                                                </button>
                                                <button onclick="testCharacterSound('incomingCall')" class="sound-test-btn">
                                                    <i class="fas fa-play"></i> 试听
                                                </button>
                                                <button onclick="clearCharacterSound('incomingCall')" class="sound-clear-btn">
                                                    <i class="fas fa-trash"></i> 清除
                                                </button>
                                            </div>
                                        </div>

                                        <!-- 推送通知音效 -->
                                        <div class="character-sound-item">
                                            <div class="character-sound-header">
                                                <h4>推送通知音效</h4>
                                                <p>收到该角色推送通知时播放的音效</p>
                                            </div>
                                            <div class="character-sound-controls">
                                                <input type="url" class="sound-url-input" id="character-notification-url" placeholder="输入音效链接">
                                                <input type="file" id="character-notification-file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" style="display: none;" onchange="handleCharacterSoundFileUpload(this, 'notification')">
                                                <button onclick="document.getElementById('character-notification-file').click()" class="sound-file-btn">
                                                    <i class="fas fa-upload"></i> 本地文件
                                                </button>
                                                <button onclick="testCharacterSound('notification')" class="sound-test-btn">
                                                    <i class="fas fa-play"></i> 试听
                                                </button>
                                                <button onclick="clearCharacterSound('notification')" class="sound-clear-btn">
                                                    <i class="fas fa-trash"></i> 清除
                                                </button>
                                            </div>
                                        </div>

                                        <!-- 静音选项 -->
                                        <div class="setting-item">
                                            <div class="setting-left">
                                                <div class="setting-label">静音模式</div>
                                                <div class="setting-desc">该角色的所有音效都静音</div>
                                            </div>
                                            <div class="setting-right">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="character-silent-mode" onchange="toggleCharacterSilentMode()">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="character-sound-note">
                                            <p><i class="fas fa-info-circle"></i> <strong>音效优先级：</strong>静音模式 > 专属音效 > 全局音效</p>
                                            <p><i class="fas fa-info-circle"></i> 支持在线链接和本地文件（最大3MB）</p>
                                            <p><i class="fas fa-info-circle"></i> 支持常见音频格式：MP3、WAV、OGG等</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 危险操作 -->
                            <div class="settings-section">
                                <div class="section-header">
                                                    <i class="fas fa-exclamation-triangle section-icon danger-section-icon"></i>
                <span class="section-title danger-section-title">危险操作</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showBlacklistSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label" id="block-manage-label">拉黑管理</div>
                                            <div class="setting-desc" id="block-manage-desc">拉黑/解除拉黑管理</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="clearChatHistory()">
                                        <div class="setting-left">
                                            <div class="setting-label">清空聊天记录</div>
                                            <div class="setting-desc">删除所有历史消息，不可恢复</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- 人物编辑表单 -->
                <div id="character-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideCharacterForm()">‹</button>
                        <div class="app-title" id="character-form-title">新建人物</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">头像</label>
                                <div class="avatar-preview" id="avatar-preview">
                                    <div class="avatar-preview-text" id="avatar-preview-text">A</div>
                                </div>
                                <button class="upload-button" onclick="handleAvatarUploadClick()">上传头像</button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">姓名</label>
                                <input type="text" class="form-input" id="character-name" placeholder="输入姓名">
                            </div>
                            <div class="form-group">
                                <label class="form-label">人设</label>
                                <textarea class="form-textarea" id="character-bio" placeholder="输入人物设定"></textarea>
                            </div>
                            <div class="form-actions form-actions-flex">
                                <button class="form-submit form-submit-flex">保存</button>
                                <button class="form-delete form-delete-red" id="character-delete-btn" onclick="deleteCurrentCharacter()">删除</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 🔥【新建人物界面文件输入框】放在界面外面，避免在某些设备上显示 -->
                <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                <input type="file" id="character-card-upload" accept=".png,.json" style="display: none;">

                <!-- 面具创建表单 -->
                <div id="persona-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hidePersonaForm()">‹</button>
                        <div class="app-title" id="persona-form-title">新建面具</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">头像</label>
                                <div class="avatar-preview" id="persona-avatar-preview">
                                    <div class="avatar-preview-text" id="persona-avatar-preview-text">我</div>
                                </div>
                                <button class="upload-button" onclick="handlePersonaAvatarUploadClick()">上传头像</button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">我的名称</label>
                                <input type="text" class="form-input" id="persona-name" placeholder="例如：user小明、user学生、user工作者">
                            </div>

                            <div class="form-group">
                                <label class="form-label">我的描述</label>
                                <textarea class="form-textarea" id="persona-description" placeholder="描述这个身份的特点，包括性格、说话风格、使用场合等..."></textarea>
                            </div>

                            <button class="form-submit" onclick="savePersona()">保存面具</button>
                        </div>
                    </div>
                </div>

                <!-- 🔥【新建面具界面文件输入框】放在界面外面，避免在某些设备上显示 -->
                <input type="file" id="persona-avatar-upload" accept="image/*" style="display: none;">

                <!-- 表情包库上传文件输入框 -->
                <input type="file" id="emoji-library-upload" accept="image/*" multiple style="display: none;">

                <!-- 表情包库管理界面 -->
                <div id="emoji-library-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideEmojiLibraryScreen()">‹</button>
                        <div class="app-title" id="emoji-library-title">表情包库</div>
                        <div class="emoji-library-delete-btn" onclick="startEmojiSelection()" title="批量删除表情包" id="start-selection-btn">
                            <i class="fas fa-trash"></i>
                        </div>
                        <div class="emoji-selection-buttons" id="selection-buttons" style="display: none;">
                            <button onclick="selectAllEmojis()" title="全选">全选</button>
                            <button onclick="deleteSelectedEmojis()" title="删除选中">删除</button>
                            <button onclick="cancelSelection()" title="取消">取消</button>
                        </div>
                    </div>
                    <div class="app-content emoji-library-content-area">
                        <!-- 上传区域 -->
                        <div class="emoji-library-upload-area-small" id="emoji-library-upload-area" onclick="triggerEmojiUpload()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 20px; color: #6B9BD2; margin-bottom: 5px;"></i>
                            <p style="margin: 0; font-size: 14px; color: #333;">点击或拖拽上传表情包</p>
                            <p style="margin: 2px 0 0 0; font-size: 11px; color: #666;">支持 JPG、PNG、GIF 格式</p>
                        </div>

                        <!-- 表情包库统计信息 -->
                        <div class="emoji-library-stats" id="emoji-library-stats" style="display: none;">
                            <div class="stats-item">
                                <span class="stats-label">总数：</span>
                                <span class="stats-value" id="total-emojis">0</span>
                            </div>
                            <div class="stats-item">
                                <span class="stats-label">已设置描述：</span>
                                <span class="stats-value" id="described-emojis">0</span>
                            </div>
                            <div class="stats-item warning" id="undescribed-warning" style="display: none;">
                                <span class="stats-label">⚠️ 未设置描述：</span>
                                <span class="stats-value" id="undescribed-emojis">0</span>
                            </div>
                        </div>

                        <div class="emoji-library-grid" id="emoji-library-grid">
                            <!-- 表情包网格将通过JS动态生成 -->
                        </div>

                        <div class="emoji-library-empty" id="emoji-library-empty" style="display: none;">
                            <i class="fas fa-smile"></i>
                            <p>这个表情包库还是空的</p>
                            <p>点击上方区域上传表情包</p>
                        </div>
                    </div>
                </div>

                <!-- 表情包库创建/编辑表单 -->
                <div id="emoji-library-form-modal" class="modal-overlay" style="display: none;" onclick="hideEmojiLibraryForm(event)">
                    <div class="modal-content emoji-library-form-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3 id="emoji-library-form-title">新建表情包库</h3>
                            <button class="modal-close-btn" onclick="hideEmojiLibraryForm()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">库名称</label>
                                <input type="text" class="form-input" id="emoji-library-name-input" placeholder="例如：可爱动物、搞笑表情、日常聊天">
                            </div>
                            <div class="form-group">
                                <label class="form-label">描述（可选）</label>
                                <textarea class="form-textarea" id="emoji-library-description-input" placeholder="描述这个表情包库的用途和特点..." rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-btn cancel-btn" onclick="hideEmojiLibraryForm()">取消</button>
                            <button class="modal-btn confirm-btn" onclick="saveEmojiLibrary()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- API聊天界面 -->
                <div id="api-chat-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div id="ai-heartrate-display" style="display: none;">♥️ 72 bpm</div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="header">
                        <div class="default-controls">
                            <button class="back-btn" onclick="backToChatApp().catch(e => console.error('返回聊天应用失败:', e))">‹</button>
                            <span class="header-title" id="api-chat-title">角色聊天</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="toggleOfflineMode()" id="offline-mode-btn" title="切换线下剧情模式">
                                    <i class="fas fa-door-open" id="offline-mode-icon"></i>
                                </span>
                                <span class="action-btn" onclick="showChatSettings()">
                                <i class="fas fa-ellipsis-v"></i>
                                </span>
                            </div>
                        </div>
                        <div class="selection-controls">
                            <span id="selection-cancel-btn">取消</span>
                            <span id="selection-count"></span>
                            <span id="selection-delete-btn">删除</span>
                        </div>
                        <span id="selection-forward-btn" onclick="showForwardTargetModal()" title="转发">
                            <i class="fas fa-share"></i>
                        </span>
                        </div>
                    </div>
                    <div class="app-content padding-none-flex">

                        <div class="chat-dialog">
                            <div class="chat-messages" id="api-chat-messages">
                                <!-- 聊天消息将通过JS动态生成 -->
                            </div>


                            <div class="chat-input-area">
                                <!-- 展开的工具面板 -->
                                <div class="tools-panel" id="tools-panel" style="display: none;">
                                    <div class="tools-grid">
                                        <div class="tool-item" id="regenerate-tool-item" onclick="regenerateLastResponse(); hideToolsPanel();" style="display: none;">
                                            <div class="tool-icon">
                                        <i class="fas fa-redo-alt"></i>
                                            </div>
                                            <span class="tool-label">重回</span>
                                        </div>
                                        <div class="tool-item" onclick="handleVoiceRecording(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-microphone"></i>
                                            </div>
                                            <span class="tool-label">语音</span>
                                        </div>
                                        <div class="tool-item" onclick="showCustomEmojiPanel(); hideToolsPanel();">
                                            <div class="tool-icon">
                                                <i class="fas fa-smile"></i>
                                            </div>
                                            <span class="tool-label">表情</span>
                                        </div>
                                        <div class="tool-item" onclick="openCamera(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-camera"></i>
                                            </div>
                                            <span class="tool-label">拍照</span>
                                        </div>
                                        <div class="tool-item" onclick="uploadImage(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-image"></i>
                                            </div>
                                            <span class="tool-label">图片</span>
                                        </div>
                                        <div class="tool-item" onclick="openTransfer(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-exchange-alt"></i>
                                            </div>
                                            <span class="tool-label">转账</span>
                                        </div>
                                        <div class="tool-item single-chat-only" onclick="makeCall(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-phone"></i>
                                            </div>
                                            <span class="tool-label">电话</span>
                                        </div>
                                        <div class="tool-item single-chat-only" onclick="openVideoCall(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-video"></i>
                                            </div>
                                            <span class="tool-label">视频</span>
                                        </div>
                                        <div class="tool-item" onclick="shareLocation(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                            </div>
                                            <span class="tool-label">位置</span>
                                        </div>
                                        <div class="tool-item diary-tool" onclick="showDiaryMenu(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-book"></i>
                                            </div>
                                            <span class="tool-label">日记</span>
                                        </div>
                                        <div class="tool-item game-tool single-chat-only" onclick="showGameMenu(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-gamepad"></i>
                                            </div>
                                            <span class="tool-label">游戏</span>
                                        </div>
                                        <div class="tool-item" onclick="openMusicPlayer(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-headphones"></i>
                                            </div>
                                            <span class="tool-label">听歌</span>
                                        </div>
                                        <div class="tool-item single-chat-only" onclick="openShoppingScreen(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-shopping-cart"></i>
                                            </div>
                                            <span class="tool-label">购物</span>
                                        </div>
                                        <div class="tool-item single-chat-only" onclick="showCharacterFootprints(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-map-marked-alt"></i>
                                            </div>
                                            <span class="tool-label">足迹</span>
                                        </div>
                                        <div class="tool-item single-chat-only" onclick="showCharacterPhone(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-mobile-alt"></i>
                                            </div>
                                            <span class="tool-label">查看</span>
                                        </div>

                                    </div>
                                </div>

                                <!-- 输入区域 -->
                                <div class="input-controls">
                                <button class="chat-action-btn toggle-tools-btn" onclick="toggleToolsPanel()" title="功能菜单" id="toggle-tools-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <div style="position: relative; flex: 1; min-width: 0;">
                                    <textarea class="chat-input" id="api-chat-input" rows="1" placeholder="输入消息..."></textarea>
                                    <!-- @群成员下拉选择框 -->
                                    <div class="mention-dropdown" id="mention-dropdown">
                                        <!-- 动态生成群成员列表 -->
                                    </div>
                                </div>
                                    <button class="chat-action-btn" onclick="triggerSmartReply()" title="获取AI回复">
                                        <i class="fas fa-comment-dots"></i>
                                </button>
                                <button class="send-button" onclick="sendApiMessage()">
                                    发送
                                </button>
                                </div>
                            </div>
                        </div>

                        <!-- 自定义表情包面板 -->
                        <div class="custom-emoji-panel" id="custom-emoji-panel">
                            <div class="emoji-tabs">
                                <div class="emoji-tab active" data-tab="recent">最近</div>
                                <div class="emoji-tab" data-tab="custom">全部</div>
                            </div>
                            <div class="emoji-content">
                                <div class="emoji-grid" id="emoji-grid">
                                    <!-- 表情包网格将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 线下剧情模式覆盖层 -->
                    <div id="offline-mode-overlay" class="offline-mode-overlay" style="display: none;">
                        <div class="offline-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="offline-mode-header">
                            <button class="back-btn" onclick="exitOfflineMode()">‹</button>
                            <span class="header-title" id="offline-mode-title">线下剧情模式</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="showOfflineHistoryModal()" title="查看聊天记录">
                                    <i class="fas fa-history"></i>
                                </span>
                                <span class="action-btn" onclick="showOfflineUISettings()" title="界面设置">
                                    <i class="fas fa-cog"></i>
                                </span>
                                <span class="action-btn" onclick="showOfflinePresetSettings()" title="添加预设">
                                    <i class="fas fa-plus"></i>
                                </span>
                            </div>
                        </div>

                        <div class="offline-mode-content">
                            <div class="offline-chat-messages" id="offline-chat-messages">
                                <!-- 线下模式的聊天消息 -->
                            </div>

                            <div class="offline-input-area">
                                <div class="offline-input-container">
                                    <textarea id="offline-input" placeholder="在线下剧情模式中输入..." rows="3"></textarea>
                                    <div class="offline-button-group">
                                        <button class="offline-regenerate-btn" onclick="regenerateLastOfflineMessage()" title="重新生成AI回复">
                                            <i class="fas fa-redo-alt"></i>
                                        </button>
                                        <button class="offline-send-btn" onclick="sendOfflineMessage()">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 🔥【聊天界面文件输入框】放在界面外面，避免在某些设备上显示 -->
                <input type="file" id="image-upload" accept="image/*" style="display: none;">
                <input type="file" id="emoji-upload" accept="image/*" style="display: none;" multiple>

                <!-- 个人表情包描述添加模态框 -->
                <div id="personal-emoji-description-modal" class="modal-overlay" style="display: none;" onclick="hidePersonalEmojiDescriptionModal(event)">
                    <div class="modal-content personal-emoji-description-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>添加表情包描述</h3>
                            <button class="modal-close-btn" onclick="hidePersonalEmojiDescriptionModal()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="emoji-preview-container">
                                <img id="personal-emoji-preview-image" src="" alt="表情包预览" style="max-width: 100px; max-height: 100px; border-radius: 8px; margin-bottom: 15px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">表情包描述</label>
                                <textarea class="form-textarea" id="personal-emoji-description-input" placeholder="请为这个表情包添加描述，帮助AI更好地理解表情包内容" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-btn cancel-btn" onclick="hidePersonalEmojiDescriptionModal()">取消</button>
                            <button class="modal-btn confirm-btn" onclick="confirmPersonalEmojiDescription()">确定</button>
                        </div>
                    </div>
                </div>

                <!-- 🔥【新增】角色足迹模态框 -->
                <div id="character-footprints-modal" class="modal-overlay" style="display: none;" onclick="hideCharacterFootprints(event)">
                    <div class="modal-content footprints-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div class="footprints-header-info">
                                <div class="footprints-character-avatar" id="footprints-character-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="footprints-character-info">
                                    <h3 id="footprints-character-name">角色足迹</h3>
                                    <p class="footprints-subtitle">查看Ta的行为轨迹</p>
                                </div>
                            </div>
                            <div class="footprints-header-actions">
                                <button class="footprints-refresh-btn" onclick="refreshCharacterFootprints()" title="刷新足迹">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="modal-close-btn" onclick="hideCharacterFootprints()">×</button>
                            </div>
                        </div>
                        <div class="modal-body footprints-body">
                            <div class="footprints-settings">
                                <div class="footprints-setting-item">
                                    <label>自动更新频率</label>
                                    <select id="footprints-update-frequency" onchange="updateFootprintsFrequency()">
                                        <option value="manual" selected>手动刷新</option>
                                        <option value="30">每30分钟</option>
                                        <option value="60">每小时</option>
                                        <option value="120">每2小时</option>
                                        <option value="180">每3小时</option>
                                    </select>
                                </div>
                            </div>
                            <div class="footprints-timeline" id="footprints-timeline">
                                <!-- 足迹时间线将通过JS动态生成 -->
                                <div class="footprints-empty-state">
                                    <i class="fas fa-map-marked-alt"></i>
                                    <p>暂无足迹记录</p>
                                    <p>点击刷新按钮获取最新足迹</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 浏览器界面 -->
                <div id="browser-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('browser-screen')">‹</button>
                        <div class="app-title">浏览器</div>
                    </div>
                    <div class="app-content padding-none-flex">
                        <div class="browser-toolbar">
                            <input type="text" class="browser-url-bar" id="browser-url" placeholder="输入网址">
                            <button onclick="loadUrl()">前往</button>
                        </div>
                        <iframe class="browser-content" id="browser-frame"></iframe>
                    </div>
                </div>



                <!-- 设置应用 -->
                <div id="settings-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('settings-screen')">‹</button>
                            <div class="app-title">设置</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showApp('api-settings-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wifi">
                                    <i class="fas fa-wifi"></i>
                                </div>
                                <div>API设置</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('theme-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon settings-icon-custom">
                                    <i class="fas fa-palette"></i>
                                </div>
                                <div>主题设置</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('wallpaper-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wallpaper">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div>壁纸设置</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('appearance-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div>外观设置</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('display-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-font"></i>
                                </div>
                                <div>字体与字号</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('sound-settings-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon sound">
                                    <i class="fas fa-volume-up"></i>
                                </div>
                                <div>音效设置</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('data-management-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon data-management">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div>数据管理</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('emergency-recovery-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon" style="background: #ff4444; color: white;">
                                    <i class="fas fa-life-ring"></i>
                                </div>
                                <div>紧急恢复</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('about-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon about">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div>关于我们</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>



                <!-- 数据管理 -->
                <div id="data-management-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('data-management-screen')">‹</button>
                            <div class="app-title">数据管理</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <!-- 存储空间使用情况 -->
                        <div class="data-section">
                            <div class="data-section-title">存储空间使用情况</div>
                            <div class="storage-usage" id="storage-usage">
                                <div class="storage-item">
                                    <div class="storage-label">聊天记录</div>
                                    <div class="storage-size" id="chat-storage-size">计算中...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">角色数据</div>
                                    <div class="storage-size" id="character-storage-size">计算中...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">聊天设置</div>
                                    <div class="storage-size" id="settings-storage-size">计算中...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">表情包</div>
                                    <div class="storage-size" id="emoji-storage-size">计算中...</div>
                                </div>
                                <div class="storage-total">
                                    <div class="storage-label">总计</div>
                                    <div class="storage-size" id="total-storage-size">计算中...</div>
                                </div>
                            </div>
                        </div>

                        <!-- 数据导入导出 -->
                        <div class="data-section">
                            <div class="data-section-title">数据备份与恢复</div>
                            <div class="settings-item" onclick="exportAllData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon export">
                                        <i class="fas fa-download"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">导出所有数据</div>
                                        <div class="setting-desc">导出所有记录为JSON文件</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="settings-item" onclick="exportLightweightData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon export">
                                        <i class="fas fa-file-export"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">轻量级导出</div>
                                        <div class="setting-desc">导出核心数据，适合大数据量时使用</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="settings-item" onclick="importDataFromFile()">
                                <div class="settings-item-left">
                                    <div class="settings-icon import">
                                        <i class="fas fa-upload"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">导入数据</div>
                                        <div class="setting-desc">从JSON文件恢复聊天记录和设置</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <!-- 数据检查与修复 -->
                        <div class="data-section">
                            <div class="data-section-title">数据检查与修复</div>
                            <div class="settings-item" onclick="checkAndFixChatHistory()">
                                <div class="settings-item-left">
                                    <div class="settings-icon import">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">检查聊天历史</div>
                                        <div class="setting-desc">检查并修复聊天记录数据，恢复丢失的消息</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="debugChatMessagesFormat()">
                                <div class="settings-item-left">
                                    <div class="settings-icon debug">
                                        <i class="fas fa-bug"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">调试聊天记录格式</div>
                                        <div class="setting-desc">分析聊天记录的数据格式，帮助诊断导入问题</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="debugGroupChatData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon debug">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">调试群聊数据</div>
                                        <div class="setting-desc">检查群聊数据的存储状态，诊断群聊显示问题</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="debugImportFunction()">
                                <div class="settings-item-left">
                                    <div class="settings-icon debug">
                                        <i class="fas fa-code"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">调试导入函数</div>
                                        <div class="setting-desc">检查当前使用的导入函数版本，诊断数据丢失问题</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="runDataIntegrityDiagnosis()">
                                <div class="settings-item-left">
                                    <div class="settings-icon debug">
                                        <i class="fas fa-stethoscope"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">🔍 数据完整性诊断</div>
                                        <div class="setting-desc">检查角色记忆是否错乱，诊断数据隔离问题</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="fixDataSyncIssues()">
                                <div class="settings-item-left">
                                    <div class="settings-icon import">
                                        <i class="fas fa-sync-alt"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">🔧 修复数据同步问题</div>
                                        <div class="setting-desc">修复数据库与内存不一致，解决角色记忆错乱</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <!-- 选择性清理 -->
                        <div class="data-section">
                            <div class="data-section-title">存储清理</div>
                            <div class="settings-item" onclick="cleanupOrphanedContacts()">
                                <div class="settings-item-left">
                                    <div class="settings-icon cleanup">
                                        <i class="fas fa-user-slash"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">清理孤立数据</div>
                                        <div class="setting-desc">清理不存在的角色数据和相关记录</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="showCleanupOptions()">
                                <div class="settings-item-left">
                                    <div class="settings-icon cleanup">
                                        <i class="fas fa-broom"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">选择性清理</div>
                                        <div class="setting-desc">清理特定类型的数据以释放空间</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="settings-item" onclick="compressAllImages()">
                                <div class="settings-item-left">
                                    <div class="settings-icon compress">
                                        <i class="fas fa-compress-arrows-alt"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">压缩图片</div>
                                        <div class="setting-desc">压缩所有头像和背景图片以节省空间</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <!-- 危险操作 -->
                        <div class="data-section danger-section">
                            <div class="data-section-title">危险操作</div>
                            <div class="settings-item danger-item" onclick="clearAllData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">清空所有数据</div>
                                        <div class="setting-desc">删除所有数据，不可恢复！</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 🚨 紧急恢复界面 -->
                <div class="app-screen" id="emergency-recovery-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('emergency-recovery-screen')">‹</button>
                            <div class="app-title" style="color: #ff4444;">🚨 紧急恢复</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div style="padding: 20px; color: #333;">
                            <!-- 警告卡片 - 毛玻璃风格 -->
                            <div style="background: linear-gradient(135deg, rgba(255, 68, 68, 0.15) 0%, rgba(255, 68, 68, 0.08) 100%); border: 2px solid rgba(255, 68, 68, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 25px; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); box-shadow: 0 8px 32px rgba(255, 68, 68, 0.1);">
                                <h3 style="color: #ff4444; margin: 0 0 12px 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>⚠️</span> 数据丢失检测
                                </h3>
                                <p style="margin: 0; font-size: 15px; color: #666; line-height: 1.5;">如果您的角色突然消失，请使用以下功能恢复数据。</p>
                            </div>

                            <!-- 第一步 -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>🔍</span> 第一步：检查数据状态
                                </h4>
                                <button onclick="checkDataStatus()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease; margin-bottom: 15px;">
                                    检查当前数据状态
                                </button>
                                <div id="data-status-result" style="background: rgba(248, 249, 250, 0.9); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: none; backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
                                    <pre id="data-status-text" style="font-size: 12px; margin: 0; white-space: pre-wrap; color: #333; font-family: 'SF Mono', Monaco, monospace;"></pre>
                                </div>
                            </div>

                            <!-- 第二步 -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>🔍</span> 第二步：深度数据挖掘
                                </h4>
                                <p style="font-size: 14px; color: #666; margin-bottom: 15px; line-height: 1.5;">搜索浏览器中可能残留的角色数据：</p>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <button onclick="deepDataSearch()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">
                                        🔍 深度搜索残留数据
                                    </button>
                                    <button onclick="searchChatHistory()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                        💬 从聊天记录推断角色
                                    </button>
                                </div>
                                <div id="deep-search-result" style="background: rgba(248, 249, 250, 0.9); border-radius: 12px; padding: 15px; margin-top: 15px; display: none; backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
                                    <pre id="deep-search-text" style="font-size: 12px; margin: 0; white-space: pre-wrap; color: #333; font-family: 'SF Mono', Monaco, monospace;"></pre>
                                </div>
                            </div>

                            <!-- 第三步 -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>📥</span> 第三步：文件导入恢复
                                </h4>
                                <p style="font-size: 14px; color: #666; margin-bottom: 15px; line-height: 1.5;">如果您有备份文件：</p>
                                <input type="file" id="recovery-file-input" accept=".json" style="width: 100%; padding: 12px 15px; border: 2px solid rgba(0, 0, 0, 0.08); border-radius: 12px; font-size: 16px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); transition: all 0.3s ease; color: #333; box-sizing: border-box; margin-bottom: 15px;">
                                <button onclick="recoverFromFile()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">
                                    从文件恢复数据
                                </button>
                            </div>

                            <!-- 第四步 -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>🔧</span> 第四步：重建角色卡
                                </h4>
                                <p style="font-size: 14px; color: #666; margin-bottom: 15px; line-height: 1.5;">从聊天记录重建丢失的角色：</p>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <button onclick="rebuildCharactersFromChat()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">
                                        🔧 自动重建所有角色
                                    </button>
                                    <button onclick="showManualRebuild()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                        ✏️ 手动重建角色
                                    </button>
                                </div>
                            </div>

                            <!-- 调试工具 -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>🔍</span> 调试：检查当前状态
                                </h4>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <button onclick="debugCurrentState()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                        🔍 检查当前数据状态
                                    </button>
                                    <button onclick="forceRefreshAll()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">
                                        🔄 强制刷新所有界面
                                    </button>
                                </div>
                            </div>

                            <!-- 第五步 -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>🧹</span> 第五步：清理异常数据
                                </h4>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <button onclick="cleanupBadData()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                        清除张三李四等异常角色
                                    </button>
                                    <button onclick="forceReload()" style="width: 100%; padding: 14px 20px; background: #FF3B30; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3); transition: all 0.3s ease;">
                                        强制重新加载数据
                                    </button>
                                </div>
                            </div>

                            <!-- 恢复日志 -->
                            <div id="recovery-log" style="background: rgba(248, 249, 250, 0.9); border-radius: 16px; padding: 20px; margin-top: 20px; max-height: 200px; overflow-y: auto; display: none; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);">
                                <h5 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>📋</span> 恢复日志：
                                </h5>
                                <div id="recovery-log-content" style="font-size: 13px; font-family: 'SF Mono', Monaco, monospace; color: #555; line-height: 1.4;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 关于我们 -->
                <div id="about-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('about-screen')">‹</button>
                            <div class="app-title">关于我们</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="about-content">
                            <div class="about-title">EVE聊天室</div>
                            <div class="about-version">版本 1.0.0</div>
                            <div class="about-author">作者@EVE</div>
                        </div>
                    </div>
                </div>

                <!-- 电话通话界面 -->
                <div id="phone-call-screen" class="app-screen">
                    <div class="call-background"></div>
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="call-content">
                        <div class="call-header">
                            <div class="call-avatar">
                                <img id="call-avatar-img" src="" alt="通话头像">
                            </div>
                            <div class="call-name" id="call-name">角色名称</div>
                            <div class="call-status" id="call-status">正在通话中...</div>
                            <div class="call-time" id="call-timer">00:00</div>
                        </div>

                        <div class="call-message-container" id="call-message-container">
                            <!-- 通话中的消息将在这里显示 -->
                        </div>

                        <div class="call-input-area">
                            <input type="text" id="call-input" placeholder="输入消息..." class="call-text-input" onkeypress="if(event.key === 'Enter') { event.preventDefault(); sendCallMessage(); }">
                            <button class="call-send-btn" onclick="sendCallMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>

                        <div class="call-controls">
                            <button class="call-control-btn end-call-btn" onclick="endCall()">
                                <i class="fas fa-phone" style="transform: rotate(135deg);"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 来电显示界面 -->
                <div id="incoming-call-screen" class="app-screen">
                    <div class="call-background incoming"></div>
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="incoming-call-content">
                        <div class="call-header">
                            <div class="call-avatar large-avatar">
                                <img id="incoming-call-avatar" src="" alt="来电头像">
                            </div>
                            <div class="call-name" id="incoming-call-name">角色名称</div>
                            <div class="call-status">来电</div>
                            <div class="call-text" id="incoming-call-text">想和你通话...</div>
                        </div>

                        <div class="incoming-call-controls">
                            <button class="incoming-call-btn reject-btn" onclick="rejectCall()">
                                <div class="call-btn-icon">
                                    <i class="fas fa-phone" style="transform: rotate(135deg);"></i>
                                </div>
                                <div class="call-btn-text">拒绝</div>
                            </button>
                            <button class="incoming-call-btn accept-btn" onclick="acceptCall()">
                                <div class="call-btn-icon">
                                    <i class="fas fa-phone"></i>
                                </div>
                                <div class="call-btn-text">接听</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 🔥【新增】视频来电显示界面 -->
                <div id="incoming-video-call-screen" class="app-screen">
                    <div class="video-call-background"></div>
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="incoming-call-content">
                        <div class="call-header">
                            <div class="call-avatar large-avatar">
                                <img id="incoming-video-call-avatar" src="" alt="视频来电头像">
                            </div>
                            <div class="call-name" id="incoming-video-call-name">角色名称</div>
                            <div class="call-status">视频来电</div>
                            <div class="call-text" id="incoming-video-call-text">想和你视频聊聊...</div>
                        </div>

                        <div class="incoming-call-controls">
                            <button class="incoming-call-btn reject-btn" onclick="rejectVideoCall()">
                                <div class="call-btn-icon">
                                    <i class="fas fa-phone" style="transform: rotate(135deg);"></i>
                                </div>
                                <div class="call-btn-text">拒绝</div>
                            </button>
                            <button class="incoming-call-btn accept-btn" onclick="acceptVideoCall()">
                                <div class="call-btn-icon">
                                    <i class="fas fa-video"></i>
                                </div>
                                <div class="call-btn-text">接听</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 🔥【新增】视频通话界面 -->
                <div id="video-call-screen" class="app-screen">
                    <div class="video-call-background"></div>
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 主画面：角色通话形象 -->
                    <div class="video-call-main-view">
                        <img id="video-call-character-avatar" src="" alt="角色通话形象" class="character-video-avatar">

                        <!-- 右上角小窗口：用户通话形象 -->
                        <div class="video-call-user-window">
                            <img id="video-call-user-avatar" src="" alt="用户通话形象" class="user-video-avatar">
                        </div>

                        <!-- 通话信息覆盖层 -->
                        <div class="video-call-overlay">
                            <div class="video-call-info">
                                <div class="video-call-name" id="video-call-name">角色名称</div>
                                <div class="video-call-status" id="video-call-status">视频通话中...</div>
                                <div class="video-call-time" id="video-call-timer">00:00</div>
                            </div>
                        </div>


                    </div>

                    <!-- 消息浮现区域 -->
                    <div class="video-call-floating-messages" id="video-call-floating-messages">
                        <!-- 视频通话中的消息将以浮现气泡形式在这里显示 -->
                    </div>

                    <!-- 输入和控制区域 -->
                    <div class="video-call-bottom-area">
                        <div class="video-call-input-area">
                            <input type="text" id="video-call-input" placeholder="输入消息..." class="video-call-text-input" onkeypress="if(event.key === 'Enter') { event.preventDefault(); sendVideoCallMessage(); }">
                            <button class="video-call-send-btn" onclick="sendVideoCallMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>

                        <div class="video-call-controls">
                            <button class="video-call-control-btn mute-btn" onclick="toggleVideoMute()" id="video-mute-btn">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="video-call-control-btn end-call-btn" onclick="endVideoCall()">
                                <i class="fas fa-phone" style="transform: rotate(135deg);"></i>
                            </button>
                            <button class="video-call-control-btn camera-btn" onclick="toggleVideoCamera()" id="video-camera-btn">
                                <i class="fas fa-video"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 字体与字号设置 -->
                <div id="display-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('display-screen')">‹</button>
                            <div class="app-title">字体与字号</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="font-size-preview">
                            <div class="font-size-preview-text" id="font-size-preview">
                                这是一段示例文字，用于预览字体大小效果。调节下方滑块可以改变字体大小。
                            </div>
                        </div>

                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">字体与字号</div>
                                    <div class="setting-desc">选择字体文件并调节全局字体大小</div>
                                </div>
                            </div>
                        </div>

                        <div class="font-size-slider-container">
                            <div class="font-size-labels">
                                <span>小</span>
                                <span>标准</span>
                                <span>大</span>
                            </div>
                            <input type="range" class="font-size-slider" id="font-size-slider"
                                   min="12" max="20" step="1" value="15"
                                   onchange="changeFontSize(this.value)">
                            <div class="font-size-value">
                                当前字号：<span id="font-size-value">15px</span>
                            </div>
                        </div>

                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">字距设置</div>
                                    <div class="setting-desc">调节文字之间的间距</div>
                                </div>
                            </div>
                        </div>

                        <div class="font-size-slider-container">
                            <div class="font-size-labels">
                                <span>紧凑</span>
                                <span>标准</span>
                                <span>宽松</span>
                            </div>
                            <input type="range" class="font-size-slider" id="letter-spacing-slider"
                                   min="-0.5" max="2" step="0.1" value="0"
                                   onchange="changeLetterSpacing(this.value)">
                            <div class="font-size-value">
                                当前字距：<span id="letter-spacing-value">标准</span>
                            </div>
                        </div>

                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">自动缩放</div>
                                    <div class="setting-desc">根据屏幕尺寸自动调整字体大小</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="auto-scale-toggle" onchange="toggleAutoScale()">
                                <span class="settings-slider"></span>
                            </label>
                        </div>

                        <!-- 🔥【新增】自定义字体设置 -->
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">自定义字体</div>
                                    <div class="setting-desc">使用在线字体链接自定义全局字体</div>
                                </div>
                            </div>
                        </div>

                        <div class="custom-font-container">
                            <div class="form-group">
                                <label>字体链接</label>
                                <input type="url" id="global-font-url" placeholder="支持CSS链接或TTF/OTF/WOFF字体文件链接" class="form-input">
                                <div class="font-url-hint">
                                    <div>支持格式：</div>
                                    <div>• CSS链接：https://fontsapi.zeoseven.com/5/main/result.css</div>
                                    <div>• 字体文件：https://files.catbox.moe/fp15b6.ttf</div>
                                </div>
                            </div>

                            <div class="font-action-buttons">
                                <button type="button" class="font-button font-button-preview" onclick="previewGlobalFont()">
                                    <i class="fas fa-eye"></i> 预览字体
                                </button>
                                <button type="button" class="font-button font-button-apply" onclick="applyGlobalFont()">
                                    <i class="fas fa-check"></i> 应用字体
                                </button>
                                <button type="button" class="font-button font-button-reset" onclick="resetGlobalFont()">
                                    <i class="fas fa-undo"></i> 重置字体
                                </button>
                            </div>

                            <div id="global-font-status" class="font-status" style="display: none;">
                                <div class="font-status-text"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 屏幕尺寸设置 -->
                <div id="screen-size-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('screen-size-screen')">‹</button>
                        <div class="app-title">屏幕尺寸</div>
                    </div>
                    <div class="app-content">
                        <div class="size-option" onclick="changeScreenSize(350, 740, '适中尺寸')" id="size-350-740">
                            <div class="size-option-left">
                                <div class="size-name">适中尺寸</div>
                                <div class="size-desc">350×740 (推荐)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-s"></div>
                            </div>
                            <i class="fas fa-check check-icon"></i>
                        </div>

                        <div class="size-option" onclick="changeScreenSize(425, 860, 'iPhone 15')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 15</div>
                                <div class="size-desc">425×860 (适配手机)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-l"></div>
                            </div>
                        </div>

                        <div class="size-option" onclick="changeScreenSize(450, 950, 'iPhone 15 Plus')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 15 Plus</div>
                                <div class="size-desc">450×950 (大屏)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-xl"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 外观设置 -->
                <div id="appearance-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('appearance-screen')">‹</button>
                            <div class="app-title">外观设置</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">全屏显示</div>
                                    <div class="setting-desc">自动适应浏览器屏幕，无边框全屏效果</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="phone-border-toggle" onchange="togglePhoneBorder()">
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item" onclick="showScreenSizeOptions()">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">屏幕尺寸</div>
                                    <div class="setting-desc" id="current-screen-size">当前：350×740 (适中尺寸)</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <!-- 🔥【修改】主屏幕字体设置 - 改为下拉菜单 -->
                        <div class="settings-item" style="position: relative;">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">主屏幕字体</div>
                                    <div class="setting-desc">设置主屏幕字体及电池的颜色</div>
                                </div>
                            </div>
                            <div class="home-font-selector" onclick="toggleHomeFontDropdown()">
                                <span id="current-home-font-text">黑色</span>
                                <i class="fas fa-chevron-down" id="home-font-arrow"></i>
                            </div>

                            <!-- 🔥【新增】主屏幕字体下拉选择菜单 -->
                            <div id="home-font-dropdown" class="home-font-dropdown" style="display: none;">
                                <div class="home-font-option selected" onclick="selectHomeFont('black')">
                                    <i class="fas fa-check"></i>
                                    <span>黑色</span>
                                    <small>适合浅色壁纸</small>
                                </div>
                                <div class="home-font-option" onclick="selectHomeFont('white')">
                                    <i class="fas fa-check"></i>
                                    <span>白色</span>
                                    <small>适合深色壁纸</small>
                                </div>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">状态栏图标</div>
                                    <div class="setting-desc">自定义时间右侧显示的图标或文字</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="text" id="status-icon-input" placeholder="输入" maxlength="5"
                                       style="width: 50px; padding: 6px 8px; border: 1px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));
                                              border-radius: var(--theme-input-radius, 15px); background: var(--theme-form-bg, rgba(255, 255, 255, 0.8));
                                              font-size: 14px; text-align: center;"
                                       onchange="updateStatusIcon()">
                                <button onclick="resetStatusIcon()"
                                        style="padding: 6px 10px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8));
                                               border: 1px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1));
                                               border-radius: var(--theme-input-radius, 15px); color: var(--theme-button-secondary-color, #555);
                                               font-size: 12px; cursor: pointer; flex-shrink: 0;">
                                    重置
                                </button>
                            </div>
                        </div>

                        <!-- 🔥【新增】时间日期样式设置 -->
                        <div class="settings-item" style="position: relative;">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">时间日期样式</div>
                                    <div class="setting-desc">选择主屏幕时间日期的显示风格</div>
                                </div>
                            </div>
                            <div class="clock-style-selector" onclick="toggleClockStyleDropdown()">
                                <span id="current-clock-style-text">默认</span>
                                <i class="fas fa-chevron-down" id="clock-style-arrow"></i>
                            </div>

                            <!-- 🔥【新增】下拉选择菜单 -->
                            <div id="clock-style-dropdown" class="clock-style-dropdown" style="display: none;">
                                <div class="clock-style-option selected" onclick="selectClockStyle('default')">
                                    <i class="fas fa-check"></i>
                                    <span>默认样式</span>
                                    <small>经典简洁的时间显示</small>
                                </div>
                                <div class="clock-style-option" onclick="selectClockStyle('bold')">
                                    <i class="fas fa-check"></i>
                                    <span>粗体样式</span>
                                    <small>类似iPhone锁屏的粗体显示</small>
                                </div>
                                <div class="clock-style-option" onclick="selectClockStyle('compact')">
                                    <i class="fas fa-check"></i>
                                    <span>紧凑样式</span>
                                    <small>类似Android的简洁显示</small>
                                </div>
                                <div class="clock-style-option" onclick="selectClockStyle('modern')">
                                    <i class="fas fa-check"></i>
                                    <span>现代样式</span>
                                    <small>类似小米MIUI的现代设计</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 音效设置界面 -->
                <div id="sound-settings-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('sound-settings-screen')">‹</button>
                            <div class="app-title">音效设置</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="form-container">
                            <!-- 音效开关 -->
                            <div class="form-group">
                                <label class="switch-label">
                                    <span>启用音效</span>
                                    <input type="checkbox" id="sound-enabled" checked onchange="toggleSoundSystem()">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>

                            <!-- 音效设置列表 -->
                            <div id="sound-settings-list">
                                <!-- 接收消息音效 -->
                                <div class="sound-setting-item">
                                    <div class="sound-setting-header">
                                        <h3>接收消息音效</h3>
                                        <p>角色发消息时播放</p>
                                    </div>
                                    <div class="sound-setting-controls">
                                        <input type="url" placeholder="输入音效链接" id="sound-messageReceived-url" class="sound-url-input">
                                        <input type="file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" id="sound-messageReceived-file" style="display: none;" onchange="handleSoundFileUpload(this, 'messageReceived')">
                                        <button onclick="document.getElementById('sound-messageReceived-file').click()" class="sound-file-btn">
                                            <i class="fas fa-upload"></i> 本地文件
                                        </button>
                                        <button onclick="testSound('messageReceived')" class="sound-test-btn">
                                            <i class="fas fa-play"></i> 试听
                                        </button>
                                        <button onclick="clearSound('messageReceived')" class="sound-clear-btn">
                                            <i class="fas fa-trash"></i> 清除
                                        </button>
                                    </div>
                                </div>

                                <!-- 发送消息音效 -->
                                <div class="sound-setting-item">
                                    <div class="sound-setting-header">
                                        <h3>发送消息音效</h3>
                                        <p>用户发消息时播放</p>
                                    </div>
                                    <div class="sound-setting-controls">
                                        <input type="url" placeholder="输入音效链接" id="sound-messageSent-url" class="sound-url-input">
                                        <input type="file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" id="sound-messageSent-file" style="display: none;" onchange="handleSoundFileUpload(this, 'messageSent')">
                                        <button onclick="document.getElementById('sound-messageSent-file').click()" class="sound-file-btn">
                                            <i class="fas fa-upload"></i> 本地文件
                                        </button>
                                        <button onclick="testSound('messageSent')" class="sound-test-btn">
                                            <i class="fas fa-play"></i> 试听
                                        </button>
                                        <button onclick="clearSound('messageSent')" class="sound-clear-btn">
                                            <i class="fas fa-trash"></i> 清除
                                        </button>
                                    </div>
                                </div>

                                <!-- 消息推送音效 -->
                                <div class="sound-setting-item">
                                    <div class="sound-setting-header">
                                        <h3>消息推送音效</h3>
                                        <p>收到推送通知时播放</p>
                                    </div>
                                    <div class="sound-setting-controls">
                                        <input type="url" placeholder="输入音效链接" id="sound-notification-url" class="sound-url-input">
                                        <input type="file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" id="sound-notification-file" style="display: none;" onchange="handleSoundFileUpload(this, 'notification')">
                                        <button onclick="document.getElementById('sound-notification-file').click()" class="sound-file-btn">
                                            <i class="fas fa-upload"></i> 本地文件
                                        </button>
                                        <button onclick="testSound('notification')" class="sound-test-btn">
                                            <i class="fas fa-play"></i> 试听
                                        </button>
                                        <button onclick="clearSound('notification')" class="sound-clear-btn">
                                            <i class="fas fa-trash"></i> 清除
                                        </button>
                                    </div>
                                </div>

                                <!-- 拨出通话音效 -->
                                <div class="sound-setting-item">
                                    <div class="sound-setting-header">
                                        <h3>拨出通话音效</h3>
                                        <p>用户拨打语音/视频通话时播放</p>
                                    </div>
                                    <div class="sound-setting-controls">
                                        <input type="url" placeholder="输入音效链接" id="sound-outgoingCall-url" class="sound-url-input">
                                        <input type="file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" id="sound-outgoingCall-file" style="display: none;" onchange="handleSoundFileUpload(this, 'outgoingCall')">
                                        <button onclick="document.getElementById('sound-outgoingCall-file').click()" class="sound-file-btn">
                                            <i class="fas fa-upload"></i> 本地文件
                                        </button>
                                        <button onclick="testSound('outgoingCall')" class="sound-test-btn">
                                            <i class="fas fa-play"></i> 试听
                                        </button>
                                        <button onclick="clearSound('outgoingCall')" class="sound-clear-btn">
                                            <i class="fas fa-trash"></i> 清除
                                        </button>
                                    </div>
                                </div>

                                <!-- 来电音效 -->
                                <div class="sound-setting-item">
                                    <div class="sound-setting-header">
                                        <h3>来电音效</h3>
                                        <p>角色拨打语音/视频通话时播放</p>
                                    </div>
                                    <div class="sound-setting-controls">
                                        <input type="url" placeholder="输入音效链接" id="sound-incomingCall-url" class="sound-url-input">
                                        <input type="file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" id="sound-incomingCall-file" style="display: none;" onchange="handleSoundFileUpload(this, 'incomingCall')">
                                        <button onclick="document.getElementById('sound-incomingCall-file').click()" class="sound-file-btn">
                                            <i class="fas fa-upload"></i> 本地文件
                                        </button>
                                        <button onclick="testSound('incomingCall')" class="sound-test-btn">
                                            <i class="fas fa-play"></i> 试听
                                        </button>
                                        <button onclick="clearSound('incomingCall')" class="sound-clear-btn">
                                            <i class="fas fa-trash"></i> 清除
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 说明文字 -->
                            <div class="sound-settings-note">
                                <p><i class="fas fa-info-circle"></i> 支持在线链接和本地文件（最大3MB）</p>
                                <p><i class="fas fa-info-circle"></i> 支持常见音频格式：MP3、WAV、OGG等</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 主题设置界面 -->
                <div id="theme-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('theme-screen')">‹</button>
                            <div class="app-title">主题设置</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="theme-option" onclick="changeTheme('default').catch(e => console.error('切换主题失败:', e))">
                            <div class="theme-preview theme-preview-simple">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">简约风格</div>
                                <div class="theme-description">清新简洁的默认主题</div>
                            </div>
                        </div>

                        <div class="theme-option" onclick="changeTheme('cute').catch(e => console.error('切换主题失败:', e))">
                            <div class="theme-preview theme-preview-cute">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">可爱风格</div>
                                <div class="theme-description">温馨可爱的粉色主题</div>
                            </div>
                        </div>

                        <div class="theme-option" onclick="changeTheme('dark').catch(e => console.error('切换主题失败:', e))">
                            <div class="theme-preview theme-preview-dark">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">夜间模式</div>
                                <div class="theme-description">护眼的深色主题</div>
                            </div>
                        </div>

                        <div class="theme-option" onclick="showApp('custom-theme-screen')">
                            <div class="theme-preview theme-preview-custom">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content">
                                    <i class="fas fa-paint-brush"></i>
                                </div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">自定义主题</div>
                                <div class="theme-description">打造专属的个性化界面</div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- 自定义主题界面 -->
                <div id="custom-theme-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('custom-theme-screen')">‹</button>
                            <div class="app-title">自定义主题</div>
                        </div>
                    </div>
                    <div class="app-content custom-theme-content">
                        <!-- 主题分类选项卡 -->
                        <div class="custom-theme-tabs">
                            <div class="custom-theme-tab active" onclick="switchCustomThemeTab('chat')">
                                <i class="fas fa-comment-dots"></i>
                                <span>聊天界面</span>
                            </div>
                            <div class="custom-theme-tab" onclick="switchCustomThemeTab('global')">
                                <i class="fas fa-mobile-alt"></i>
                                <span>全局界面</span>
                            </div>
                        </div>

                        <!-- 聊天界面自定义 -->
                        <div id="chat-theme-content" class="custom-theme-content-pane">
                            <!-- 聊天界面背景设置 -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-image"></i>
                                    <span>界面背景</span>
                                </div>

                                <div class="custom-theme-item" onclick="uploadChatTopBackground()" id="chat-top-bg-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-window-maximize"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">顶部应用栏背景</div>
                                            <div class="theme-item-desc">包含状态栏和标题栏</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="chat-top-bg-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="chat-top-bg-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadChatBottomBackground()" id="chat-bottom-bg-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-keyboard"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">底部输入栏背景</div>
                                            <div class="theme-item-desc">输入框和按钮区域</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="chat-bottom-bg-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="chat-bottom-bg-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- 按钮自定义设置 -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-mouse-pointer"></i>
                                    <span>按钮样式</span>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('back')" id="back-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-arrow-left"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">返回按钮</div>
                                            <div class="theme-item-desc">聊天界面左上角返回按钮</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="back-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="back-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('offline')" id="offline-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-door-open"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">线下模式按钮</div>
                                            <div class="theme-item-desc">聊天界面线下模式切换</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="offline-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="offline-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('settings')" id="settings-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-cog"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">聊天设置按钮</div>
                                            <div class="theme-item-desc">聊天界面右上角设置按钮</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="settings-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="settings-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('expand')" id="expand-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-plus"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">功能区展开按钮</div>
                                            <div class="theme-item-desc">底部输入栏左侧展开按钮</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="expand-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="expand-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('continue')" id="continue-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-comment-dots"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">续写按钮</div>
                                            <div class="theme-item-desc">获取AI回复按钮</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="continue-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="continue-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('send')" id="send-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-paper-plane"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">发送消息按钮</div>
                                            <div class="theme-item-desc">底部输入栏发送按钮</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="send-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="send-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- 应用范围设置 -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-layer-group"></i>
                                    <span>应用范围</span>
                                </div>

                                <div class="theme-scope-options">
                                    <div class="theme-scope-option active" data-scope="selected">
                                        <i class="fas fa-users"></i>
                                        <span>选择聊天窗口</span>
                                    </div>
                                    <div class="theme-scope-option" data-scope="all">
                                        <i class="fas fa-globe"></i>
                                        <span>所有聊天窗口</span>
                                    </div>
                                </div>

                                <!-- 选择聊天窗口列表（当选择"选择聊天窗口"时显示） -->
                                <div id="chat-selection-list" class="chat-selection-list">
                                    <!-- 聊天窗口列表将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>

                        <!-- 全局界面自定义 -->
                        <div id="global-theme-content" class="custom-theme-content-pane" style="display: none;">
                            <!-- 全局应用栏设置 -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-window-maximize"></i>
                                    <span>应用栏样式（排除聊天界面）</span>
                                </div>

                                <div class="custom-theme-item" onclick="uploadGlobalTopAppBar()" id="global-top-app-bar-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-window-maximize"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">顶部应用栏</div>
                                            <div class="theme-item-desc">应用到除API聊天和短信聊天以外的所有应用页顶部</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="global-top-app-bar-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="global-top-app-bar-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadGlobalBottomAppBar()" id="global-bottom-app-bar-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-window-minimize"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">底部应用栏</div>
                                            <div class="theme-item-desc">应用到除API聊天和短信聊天以外的所有应用页底部</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="global-bottom-app-bar-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="global-bottom-app-bar-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- 标题栏按钮设置 -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-mouse-pointer"></i>
                                    <span>标题栏按钮（排除聊天界面）</span>
                                </div>

                                <div class="custom-theme-item" onclick="uploadGlobalBackButton()" id="global-back-button-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-arrow-left"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">返回按钮</div>
                                            <div class="theme-item-desc">应用到除API聊天和短信聊天以外的返回按钮</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="global-back-button-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="global-back-button-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadGlobalAddButton()">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-plus"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">添加按钮</div>
                                            <div class="theme-item-desc">应用到除API聊天和短信聊天以外的添加按钮</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="global-add-button-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- 全局背景设置 -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-image"></i>
                                    <span>应用背景（排除聊天界面）</span>
                                </div>

                                <div class="custom-theme-item" onclick="uploadGlobalBackground()">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-desktop"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">全局应用背景</div>
                                            <div class="theme-item-desc">应用到除API聊天和短信聊天以外的所有应用界面</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="global-bg-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                </div>
                            </div>


                        </div>

                        <!-- 底部操作按钮 -->
                        <div class="custom-theme-actions">
                            <button class="theme-action-btn manage-btn" onclick="showThemeManagement().catch(e => console.error('显示主题管理失败:', e))">
                                <i class="fas fa-cog"></i>
                                <span>管理</span>
                            </button>
                            <button class="theme-action-btn reset-btn" onclick="resetCustomTheme().catch(e => console.error('重置主题失败:', e))">
                                <i class="fas fa-undo"></i>
                                <span>重置</span>
                            </button>
                            <button class="theme-action-btn preview-btn" onclick="previewCustomTheme()">
                                <i class="fas fa-eye"></i>
                                <span>预览</span>
                            </button>
                            <button class="theme-action-btn apply-btn" onclick="applyCustomTheme().catch(e => console.error('应用主题失败:', e))">
                                <i class="fas fa-check"></i>
                                <span>应用</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 壁纸设置 -->
                <div id="wallpaper-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('wallpaper-screen')">‹</button>
                            <div class="app-title">壁纸</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showWallpaperPicker()">
                            <div class="settings-item-left">
                                <div>选择新壁纸</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showIconPicker()">
                            <div class="settings-item-left">
                                <div>更改应用图标</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>

                <!-- 无线局域网设置 -->
                <div id="wifi-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('wifi-screen')">‹</button>
                        <div class="app-title">无线局域网</div>
                    </div>
                    <div class="app-content">
                        <div class="wifi-settings">
                            <div class="settings-item">
                                <div class="settings-item-left">
                                    <div>无线局域网</div>
                                </div>
                                <label class="settings-toggle">
                                    <input type="checkbox" checked>
                                    <span class="settings-slider"></span>
                                </label>
                            </div>

                            <div class="wifi-network">
                                <div class="wifi-network-left">
                                    <div class="wifi-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div>
                                        <div>HomeWiFi</div>
                                        <div class="wifi-strength">
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                        </div>
                                    </div>
                                </div>
                                <i class="fas fa-check check-icon"></i>
                            </div>

                            <div class="settings-item settings-item-margin" onclick="showApp('api-settings-screen')">
                                <div class="settings-item-left">
                                    <div>API设置</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API设置界面 -->
                <div id="api-settings-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('api-settings-screen')">‹</button>
                            <div class="app-title">API设置</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="form-container" style="color: #000000;">



                            <!-- 快速设置卡片 -->
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label style="color: #333; margin-bottom: 15px; display: block; font-size: 16px; font-weight: 600;">🚀 快速设置</label>

                                <!-- Gemini直连卡片 -->
                                <div style="margin-bottom: 12px; padding: 18px; background: linear-gradient(135deg, rgba(74, 132, 193, 0.1) 0%, rgba(74, 132, 193, 0.05) 100%); border: 2px solid rgba(74, 132, 193, 0.2); border-radius: 16px; color: #333; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);" onclick="setGeminiDirect()">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--theme-button-bg, #4a84c1);">🌟 Gemini 直连</div>
                                            <div style="font-size: 13px; color: #666;">自动配置Google官方API，支持最新模型</div>
                                        </div>
                                        <div style="background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(74, 132, 193, 0.3);">点击配置</div>
                                    </div>
                            </div>

                                <!-- HuggingFace反代卡片 -->
                                <div style="margin-bottom: 15px; padding: 18px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%); border: 2px solid rgba(255, 193, 7, 0.2); border-radius: 16px; color: #333; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);" onclick="setHuggingFaceProxy()">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: #f39c12;">🤗 HuggingFace 反代</div>
                                            <div style="font-size: 13px; color: #666;">免费使用多种大模型，支持Claude等</div>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);">点击配置</div>
                                    </div>
                            </div>

                                <div style="font-size: 12px; color: #666; text-align: center; margin-top: 10px;">
                                    ⚠️ 使用前请确保有对应的API密钥
                                </div>
                            </div>

                            <!-- API配置表单 - 美化版 -->
                            <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);">

                                <!-- API地址 -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">API地址</label>
                                    <input type="text" id="api-base" placeholder="例如: https://api.openai.com 或 @https://xxx-xxx.hf.space/v1" style="width: 100%; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); box-sizing: border-box;">
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">支持标准API和HuggingFace反代（格式：@https://xxx.hf.space/v1）</div>
                            </div>

                                <!-- API密钥 -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">API密钥</label>
                                    <input type="password" id="api-key" placeholder="sk-... 或 Google AI Studio API Key" style="width: 100%; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); box-sizing: border-box;">
                                </div>

                                <!-- 模型选择 -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">模型</label>
                                    <div style="display: flex; gap: 10px; align-items: center; width: 100%; overflow: hidden;">
                                        <select id="model-select" style="flex: 1; min-width: 0; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); max-height: 200px; overflow-y: auto;">
                                            <!-- 模型选项将通过JS动态填充 -->
                                    </select>
                                        <button id="fetch-models-btn" onclick="fetchModels()" style="padding: 10px 16px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; backdrop-filter: blur(10px); transition: all 0.3s ease; white-space: nowrap;">拉取模型</button>
                                </div>
                            </div>

                                <!-- 温度参数 -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">温度参数 (<span id="temperature-value" style="color: var(--theme-button-bg, #4a84c1); font-weight: 700;">0.75</span>)</label>
                                    <div style="background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 12px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));">
                                        <input type="range" id="temperature-slider" min="0" max="2" step="0.05" value="0.75" oninput="document.getElementById('temperature-value').textContent = parseFloat(this.value).toFixed(2);" style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, rgba(74, 132, 193, 0.2) 0%, rgba(74, 132, 193, 0.4) 100%); outline: none; -webkit-appearance: none; appearance: none;">
                                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #666;">
                                            <span>0.00 (保守)</span>
                                            <span>1.00 (平衡)</span>
                                            <span>2.00 (创新)</span>
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">温度越低，回答越保守稳定；温度越高，回答越有创意多样</div>
                                    </div>
                            </div>

                                <!-- 表情包识别设置 -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">表情包识别</label>
                                    <div style="background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 12px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                            <input type="checkbox" id="emoji-recognition-enabled" style="width: 18px; height: 18px; accent-color: var(--theme-button-bg, #4a84c1);">
                                            <span style="font-size: 14px; color: var(--theme-text-primary, #333);">启用AI识别表情包图片</span>
                                        </label>
                                        <div style="font-size: 12px; color: #666; margin-top: 8px; line-height: 1.4;">
                                            关闭后，AI将无法识别表情包图片内容，但仍可识别普通图片。这可以节省token消耗。
                                        </div>
                                    </div>
                                </div>

                                <!-- 操作按钮 -->
                                <div style="display: flex; gap: 12px; margin-top: 25px;">
                                    <button id="test-api-connection-btn" onclick="testApiConnection()" style="flex: 1; padding: 14px 20px; background: linear-gradient(135deg, #34c759 0%, #30d158 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3); transition: all 0.3s ease;">测试连接</button>
                                    <button id="save-api-settings-btn" onclick="saveApiSettings()" style="flex: 1; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">保存设置</button>
                                </div>
                            </div>

                            <!-- API配置管理 -->
                            <hr style="margin: 30px 0; border: none; border-top: 1px solid #eaeaea;">
                            <div class="api-config-manager" style="background: rgba(248, 249, 250, 0.8); border-radius: 16px; padding: 20px; margin: 15px 0; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>💾</span> API配置管理
                                </h4>
                                <p style="font-size: 13px; color: #666; margin: 0 0 15px 0; line-height: 1.5;">保存当前配置为预设，方便快速切换不同的API服务</p>

                                <div class="save-config-section" style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.6); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                                        <input type="text" id="config-name-input" placeholder="输入配置名称 (如: OpenAI、Gemini、Claude等)" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.9);">
                                        <button id="save-current-config-btn" onclick="saveCurrentConfig()" style="padding: 8px 16px; background: #e8ebf7; color: #5a6acf; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;">保存</button>
                        </div>
                                    <div style="font-size: 12px; color: #888;">当前配置将保存为: <span style="color: #333; font-weight: 500;">URL + 模型 + 温度设置</span></div>
                                </div>

                                <div class="saved-configs-section">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                        <label style="font-size: 14px; font-weight: 500; color: #333;">已保存的配置</label>
                                        <button id="clear-all-configs-btn" onclick="clearAllConfigs()" style="padding: 6px 12px; background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;">🗑️ 清空全部</button>
                                    </div>
                                    <div id="saved-configs-container" style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
                                        <!-- 保存的配置卡片将在这里动态生成 -->
                                    </div>
                                    <div id="no-configs-message" style="text-align: center; color: #999; padding: 30px 20px; font-size: 14px; display: none;">
                                        <div style="font-size: 24px; margin-bottom: 8px;">📝</div>
                                        <div>还没有保存任何配置</div>
                                        <div style="font-size: 12px; margin-top: 4px;">在上方输入配置名称并点击"保存配置"</div>
                                    </div>
                                </div>
                            </div>



                        </div>
                    </div>
                </div>

                <!-- 角色手机界面 -->
                <div id="character-phone-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('character-phone-screen'); showApp('api-chat-screen');">‹</button>
                        <div class="app-title" id="character-phone-title">角色手机</div>
                    </div>

                    <div class="app-content character-phone-content">
                        <!-- 手机内容区域 -->
                        <div class="phone-content-area">
                            <!-- 消息内容 -->
                            <div class="phone-tab-content" id="phone-messages-content">
                                <div class="phone-messages-list">
                                    <div class="phone-message-item">
                                        <div class="phone-message-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="phone-message-info">
                                            <div class="phone-message-name">小红</div>
                                            <div class="phone-message-preview">今天天气真好呢~</div>
                                            <div class="phone-message-time">10:30</div>
                                        </div>
                                    </div>
                                    <div class="phone-message-item">
                                        <div class="phone-message-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="phone-message-info">
                                            <div class="phone-message-name">小明</div>
                                            <div class="phone-message-preview">周末一起出去玩吧</div>
                                            <div class="phone-message-time">昨天</div>
                                        </div>
                                    </div>
                                    <div class="phone-message-item">
                                        <div class="phone-message-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="phone-message-info">
                                            <div class="phone-message-name">妈妈</div>
                                            <div class="phone-message-preview">记得按时吃饭哦</div>
                                            <div class="phone-message-time">昨天</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 备忘录内容 -->
                            <div class="phone-tab-content" id="phone-notes-content" style="display: none;">
                                <div class="phone-notes-list">
                                    <div class="phone-note-item" onclick="openPhoneNote('购物清单')">
                                        <div class="phone-note-title">购物清单</div>
                                        <div class="phone-note-preview">牛奶、面包、鸡蛋...</div>
                                        <div class="phone-note-time">今天 14:20</div>
                                    </div>
                                    <div class="phone-note-item" onclick="openPhoneNote('工作计划')">
                                        <div class="phone-note-title">工作计划</div>
                                        <div class="phone-note-preview">完成项目报告，准备会议...</div>
                                        <div class="phone-note-time">昨天 16:45</div>
                                    </div>
                                    <div class="phone-note-item" onclick="openPhoneNote('读书笔记')">
                                        <div class="phone-note-title">读书笔记</div>
                                        <div class="phone-note-preview">今天读了一本很有趣的书...</div>
                                        <div class="phone-note-time">2天前</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 相册内容 -->
                            <div class="phone-tab-content" id="phone-photos-content" style="display: none;">
                                <div class="phone-photos-grid">
                                    <div class="phone-photo-item" onclick="openPhonePhoto('春日樱花')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="phone-photo-item" onclick="openPhonePhoto('咖啡时光')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="phone-photo-item" onclick="openPhonePhoto('夕阳西下')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="phone-photo-item" onclick="openPhonePhoto('城市夜景')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="phone-photo-item" onclick="openPhonePhoto('美食记录')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="phone-photo-item" onclick="openPhonePhoto('旅行回忆')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 底部标签页 -->
                        <div class="phone-tabs">
                            <div class="phone-tab active" onclick="switchPhoneTab('messages')">
                                <i class="fas fa-comment"></i>
                                <span>消息</span>
                            </div>
                            <div class="phone-tab" onclick="switchPhoneTab('notes')">
                                <i class="fas fa-sticky-note"></i>
                                <span>备忘录</span>
                            </div>
                            <div class="phone-tab" onclick="switchPhoneTab('photos')">
                                <i class="fas fa-images"></i>
                                <span>相册</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 角色手机对话详情界面 -->
                <div id="character-phone-chat-screen" class="app-screen" style="display: none;">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('character-phone-chat-screen'); showApp('character-phone-screen');">‹</button>
                        <div class="app-title" id="phone-chat-contact-name">联系人</div>
                    </div>

                    <div class="app-content phone-chat-content">
                        <!-- 对话消息区域 -->
                        <div class="phone-chat-messages" id="phone-chat-messages">
                            <!-- 消息将通过JavaScript动态生成 -->
                        </div>

                        <!-- 输入区域 -->
                        <div class="phone-chat-input-area">
                            <div class="phone-chat-input-container">
                                <input type="text" class="phone-chat-input" placeholder="输入消息..." readonly>
                                <button class="phone-chat-send-btn" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 角色手机备忘录详情界面 -->
                <div id="character-phone-note-screen" class="app-screen" style="display: none;">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('character-phone-note-screen'); showApp('character-phone-screen');">‹</button>
                        <div class="app-title" id="phone-note-title">备忘录</div>
                    </div>

                    <div class="app-content phone-note-detail-content">
                        <div class="phone-note-detail">
                            <div class="phone-note-detail-header">
                                <h2 id="phone-note-detail-title">备忘录标题</h2>
                                <div class="phone-note-detail-time" id="phone-note-detail-time">时间</div>
                            </div>
                            <div class="phone-note-detail-body" id="phone-note-detail-body">
                                备忘录内容...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 角色手机照片详情界面 -->
                <div id="character-phone-photo-screen" class="app-screen" style="display: none;">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('character-phone-photo-screen'); showApp('character-phone-screen');">‹</button>
                        <div class="app-title">照片</div>
                    </div>

                    <div class="app-content phone-photo-detail-content">
                        <div class="phone-photo-detail">
                            <div class="phone-photo-detail-image" id="phone-photo-detail-image">
                                <div class="phone-photo-placeholder-large">
                                    <i class="fas fa-image"></i>
                                    <p>照片预览</p>
                                </div>
                            </div>
                            <div class="phone-photo-detail-info">
                                <div class="phone-photo-detail-title" id="phone-photo-detail-title">照片标题</div>
                                <div class="phone-photo-detail-time" id="phone-photo-detail-time">拍摄时间</div>
                                <div class="phone-photo-detail-description" id="phone-photo-detail-description">照片描述</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 颜色选择器模态框 -->
                <div class="modal" id="color-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title" id="color-picker-title">选择颜色</div>
                            <button class="modal-close" onclick="hideModal('color-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="color-picker" id="color-picker">
                                <div class="color-option color-red" onclick="selectColor('#FF3B30')"></div>
                                <div class="color-option color-orange" onclick="selectColor('#FF9500')"></div>
                                <div class="color-option color-yellow" onclick="selectColor('#FFCC00')"></div>
                                <div class="color-option color-green" onclick="selectColor('#34C759')"></div>
                                <div class="color-option color-light-blue" onclick="selectColor('#5AC8FA')"></div>
                                <div class="color-option color-blue" onclick="selectColor('#007AFF')"></div>
                                <div class="color-option color-purple" onclick="selectColor('#5856D6')"></div>
                                <div class="color-option color-pink" onclick="selectColor('#AF52DE')"></div>
                                <div class="color-option color-red-alt" onclick="selectColor('#FF2D55')"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">透明度</label>
                                <input type="range" class="opacity-slider" id="opacity-slider" min="0" max="1" step="0.1" value="1">
                                <span id="opacity-value">100%</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('color-picker-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="applyColorSelection()">应用</button>
                        </div>
                    </div>
                </div>

                <!-- 壁纸选择器模态框 -->
                <div class="modal" id="wallpaper-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">选择壁纸</div>
                            <button class="modal-close" onclick="hideModal('wallpaper-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="wallpaper-preview-container" id="wallpaper-preview-container">
                                <div class="wallpaper-preview-placeholder">
                                    <i class="fas fa-image"></i>
                                    <div>选择本地图片后可在此预览</div>
                                </div>
                            </div>
                            <div class="settings-item upload-custom-item" onclick="uploadCustomWallpaper()">
                                <div class="settings-item-left">
                                    <div>从相册选择</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <input type="file" id="custom-wallpaper-upload" accept="image/*" class="file-input-hidden">
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('wallpaper-picker-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="applyWallpaperSelection()">应用</button>
                        </div>
                    </div>
                </div>

                <!-- 图片上传选择模态框 -->
                <div class="modal" id="image-upload-choice-modal">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <div class="modal-title" id="image-upload-choice-title">选择图片来源</div>
                            <button class="modal-close" onclick="hideModal('image-upload-choice-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="upload-choice-container">
                                <div class="upload-choice-option" onclick="chooseLocalUpload()">
                                    <div class="upload-choice-icon">
                                        <i class="fas fa-upload"></i>
                                    </div>
                                    <div class="upload-choice-text">
                                        <div class="upload-choice-title">本地上传</div>
                                        <div class="upload-choice-desc">从设备选择图片文件</div>
                                    </div>
                                </div>
                                <div class="upload-choice-option" onclick="chooseUrlUpload()">
                                    <div class="upload-choice-icon">
                                        <i class="fas fa-link"></i>
                                    </div>
                                    <div class="upload-choice-text">
                                        <div class="upload-choice-title">在线图床</div>
                                        <div class="upload-choice-desc">输入图片URL地址</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- URL输入模态框 -->
                <div class="modal" id="url-input-modal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <div class="modal-title" id="url-input-title">输入图片URL</div>
                            <button class="modal-close" onclick="hideModal('url-input-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="url-input-container">
                                <label for="image-url-input">图片URL地址：</label>
                                <input type="url" id="image-url-input" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                                <div class="url-tips">
                                    <p><strong>支持的图床：</strong></p>
                                    <ul>
                                        <li>PostImg: https://i.postimg.cc/...</li>
                                        <li>Catbox: https://files.catbox.moe/...</li>
                                        <li>ImgBB: https://i.ibb.co/...</li>
                                        <li>Imgur: https://i.imgur.com/...</li>
                                        <li>其他支持直链的图床</li>
                                    </ul>
                                </div>
                                <div class="url-preview" id="url-preview" style="display: none;">
                                    <img id="url-preview-img" style="max-width: 100%; max-height: 200px; border-radius: 5px;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('url-input-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="confirmUrlUpload()">确认</button>
                        </div>
                    </div>
                </div>

                <!-- 图标选择器模态框 -->
                <div class="modal" id="icon-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">更改应用图标</div>
                            <button class="modal-close" onclick="hideModal('icon-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- 应用列表 -->
                            <div class="app-list-section">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">选择要修改的应用</h4>
                                <div id="app-list-container" class="app-list-grid">
                                    <!-- 动态生成应用列表 -->
                                </div>
                            </div>

                            <!-- 图标上传区域 -->
                            <div class="icon-upload-section" id="icon-upload-section" style="display: none;">
                                <h4 style="margin: 20px 0 15px 0; color: #333; font-size: 16px;">上传新图标</h4>
                                <div class="upload-area" onclick="triggerIconUpload()">
                                    <div class="upload-placeholder" id="upload-placeholder">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: #999; margin-bottom: 10px;"></i>
                                        <div style="color: #666;">点击选择图片</div>
                                        <div style="color: #999; font-size: 12px; margin-top: 5px;">支持 JPG、PNG 格式</div>
                                    </div>
                                    <img id="icon-preview-img" class="icon-preview-img" style="display: none;">
                                </div>
                                <input type="file" id="custom-icon-upload" accept="image/*" class="file-input-hidden">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('icon-picker-modal')">取消</button>
                            <button class="modal-button modal-primary" id="apply-icon-btn" onclick="applyIconChange()" style="display: none;">应用</button>
                        </div>
                    </div>
                </div>

                <!-- 照片拍摄模态框 -->






                <!-- 聊天选项模态框 -->
                <div class="modal" id="chat-options-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">选择聊天类型</div>
                            <button class="modal-close" onclick="hideModal('chat-options-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="chat-option-item" onclick="showSingleChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-user icon-user-blue"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">单聊</div>
                                    <div class="chat-option-desc">与单个角色进行对话</div>
                                </div>
                            </div>
                            <div class="chat-option-item" onclick="showGroupChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-users icon-users-green"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">群聊</div>
                                    <div class="chat-option-desc">与多个角色同时聊天</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 单聊角色选择模态框 -->
                <div class="modal" id="single-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">选择聊天角色</div>
                            <button class="modal-close" onclick="hideModal('single-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body" id="single-chat-body">
                            <!-- 角色列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 群聊角色选择模态框 -->
                <div class="modal" id="group-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">创建群聊</div>
                            <button class="modal-close" onclick="hideModal('group-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">群聊名称</label>
                                <input type="text" class="form-input" id="group-chat-name" placeholder="例如：动态分享、工作群">
                            </div>
                            <div class="form-group">
                                <label class="form-label">选择成员 (至少2人，最多20人)</label>
                                <div id="group-chat-members">
                                    <!-- 群聊成员选择将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('group-chat-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="createGroupChat()">创建群聊</button>
                        </div>
                    </div>
                </div>

                <!-- 历史消息设置模态框 -->
                <div class="modal" id="history-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">历史消息设置</div>
                            <button class="modal-close" onclick="hideModal('history-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <div class="setting-card" style="margin-bottom: 20px;">
                                <div class="setting-item" style="margin-bottom: 15px;">
                                    <div class="setting-left">
                                        <div class="setting-label" style="font-size: 16px; margin-bottom: 8px;">附带历史消息数 (回合数)</div>
                                        <div class="setting-desc" style="font-size: 14px; line-height: 1.4;">AI回复时参考的历史对话回合数</div>
                                    </div>
                                    <div class="setting-right">
                                        <span class="setting-value" id="history-count-display" style="font-size: 16px; font-weight: 600;">5回合</span>
                                    </div>
                                </div>
                                <div class="setting-range-container" style="margin-bottom: 15px;">
                                    <input type="range" class="theme-range" id="history-messages-count" min="0" max="100" step="1" value="5">
                                    <div class="range-labels">
                                        <span>0回合</span>
                                        <span>100回合</span>
                                    </div>
                                </div>
                                <div class="custom-input-container" style="margin-bottom: 15px;">
                                    <span class="input-label">自定义数值：</span>
                                    <input type="number" class="theme-input" id="custom-history-count" min="0" max="500" value="5" style="width: 80px; margin: 0 8px;">
                                    <span class="input-unit">回合 (最大500)</span>
                                </div>
                                <div class="setting-explanation">
                                    <div class="explanation-text">
                                        <strong>说明：</strong><br>
                                        • 一回合 = 你的一条消息 + AI的一条回复<br>
                                        • 设置为5表示AI回复时会参考最近5回合对话<br>
                                        • 注意：数值过大可能影响API响应速度
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 20px; gap: 0;">
                            <button class="theme-button theme-button-secondary" onclick="hideModal('history-settings-modal')" style="margin: 0; padding: 12px 20px;">取消</button>
                            <button class="theme-button theme-button-primary" onclick="saveHistorySettings()" style="margin: 0; padding: 12px 20px;">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 记忆挂载设置模态框 -->
                <div class="modal" id="memory-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">记忆挂载设置</div>
                            <button class="modal-close" onclick="hideModal('memory-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="memory-mount-enabled" class="checkbox-with-margin">
                                    启用记忆挂载
                                </label>
                                <p class="small-text margin-top-5">
                                    开启后，AI会参考其他聊天窗口的对话内容作为背景记忆
                                </p>
                            </div>
                            <div class="form-group hide" id="memory-mount-details">
                                <label class="form-label">每个聊天挂载条数</label>
                                <input type="range" class="api-form-range" id="memory-mount-count" min="1" max="20" step="1" value="3">
                                <div class="flex-space-between">
                                    <span>1条</span>
                                    <span id="memory-mount-display">3条</span>
                                    <span>20条</span>
                                </div>
                            </div>
                            <div class="form-group hide" id="memory-mount-chats">
                                <label class="form-label">选择要挂载的聊天</label>
                                <div id="memory-mount-list" class="max-height-200-auto">
                                    <!-- 聊天列表将通过JS动态生成 -->
                                </div>
                                <p class="small-text margin-top-8">
                                    选择的聊天记录会作为背景信息提供给AI参考
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('memory-mount-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveMemoryMountSettings()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 头像设置模态框 -->
                <div class="modal" id="avatar-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">双方头像设置</div>
                            <button class="modal-close" onclick="hideModal('avatar-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="avatar-setting-group">
                                <label class="form-label">我的头像 (仅在此聊天窗口生效)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="my-chat-avatar-preview">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <input type="file" id="my-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('my-chat-avatar-upload').click()">上传头像</button>
                                </div>
                            </div>
                            <div class="avatar-setting-group">
                                <label class="form-label">对方头像 (仅在此聊天窗口生效)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="ai-chat-avatar-preview">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <input type="file" id="ai-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('ai-chat-avatar-upload').click()">上传头像</button>
                                    <button class="upload-button clear-avatar-btn" onclick="clearAiChatAvatar()">清除聊天头像</button>
                                </div>
                                <p class="small-text margin-top-5">
                                    注意：如果角色在聊天中更换了头像，会覆盖此设置，点击"清除聊天头像"可重置为角色卡默认头像
                                </p>
                            </div>
                            <div class="form-group margin-top-20">
                                <label class="form-label">头像形状</label>
                                <div class="avatar-shape-options">
                                    <label class="shape-radio-option">
                                        <input type="radio" name="avatar-shape" value="circle" checked>
                                        <span class="shape-radio-text">圆形</span>
                                    </label>
                                    <label class="shape-radio-option">
                                        <input type="radio" name="avatar-shape" value="rounded-square">
                                        <span class="shape-radio-text">方形</span>
                                    </label>
                                </div>
                                <p class="small-text margin-top-5">
                                    选择头像在聊天中的显示形状
                                </p>
                            </div>
                            <div class="form-group margin-top-20">
                                <label class="form-label">
                                    <input type="checkbox" id="hide-avatars" class="checkbox-with-margin">
                                    隐藏双方头像
                                </label>
                                <p class="small-text margin-top-5">
                                    开启后，聊天界面将不显示任何头像
                                </p>
                            </div>
                            <p class="small-text margin-top-15">
                                注意：此设置仅影响当前聊天窗口显示，不会同步修改角色卡或面具设置
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('avatar-settings-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveChatAvatarSettings()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 昵称设置模态框 -->
                <div class="modal" id="nickname-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">双方备注设置</div>
                            <button class="modal-close" onclick="hideModal('nickname-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">我的昵称 (仅在此聊天中显示)</label>
                                <input type="text" class="form-input" id="my-chat-nickname" placeholder="输入你在此聊天中的昵称">
                            </div>
                            <div class="form-group">
                                <label class="form-label">对方昵称 (仅在此聊天中显示)</label>
                                <input type="text" class="form-input" id="ai-chat-nickname" placeholder="输入对方在此聊天中的昵称">
                            </div>
                            <p class="small-text margin-top-10">
                                注意：此设置仅影响当前聊天窗口显示，不会同步修改角色卡或面具设置。角色也可能根据心情和聊天内容自主修改自己的昵称。
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('nickname-settings-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveChatNicknameSettings()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 戳一戳后缀设置模态框 -->
                <div class="modal" id="poke-suffix-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">戳一戳后缀设置</div>
                            <button class="modal-close" onclick="hideModal('poke-suffix-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">我的戳一戳后缀</label>
                                <input type="text" class="form-input" id="my-poke-suffix" placeholder="留空为无后缀（例如：的小脸蛋）">
                                <p class="tiny-text margin-top-5">显示为：[角色名]戳了戳你[后缀]，留空则显示：[角色名]戳了戳你</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">对方戳一戳后缀</label>
                                <input type="text" class="form-input" id="ai-poke-suffix" placeholder="留空为无后缀（例如：的小手）">
                                <p class="tiny-text margin-top-5">显示为：你戳了戳[角色名][后缀]，留空则显示：你戳了戳[角色名]</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('poke-suffix-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="savePokeSuffixSettings()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 聊天背景设置模态框 -->
                <div class="modal" id="background-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">聊天背景设置</div>
                            <button class="modal-close" onclick="hideModal('background-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="background-preview-container">
                                <div class="background-preview" id="chat-background-preview">
                                    <div class="preview-text">背景预览</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="file" id="background-upload" accept="image/*" class="file-input-hidden">
                                <button class="form-button" onclick="document.getElementById('background-upload').click()">选择背景图片</button>
                                <button class="form-button form-button-secondary" onclick="removeBackground()">移除背景</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('background-settings-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveChatBackgroundSettings()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 🔥【新增】群成员气泡颜色设置模态框 -->
                <div class="modal" id="group-member-colors-modal" style="z-index: 10001;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">群成员气泡颜色设置</div>
                            <button class="modal-close" onclick="hideModal('group-member-colors-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-explanation">
                                <div class="explanation-text">为每个群成员设置独特的气泡颜色，让群聊更加生动有趣。</div>
                            </div>
                            <div id="group-member-colors-list">
                                <!-- 动态生成群成员颜色设置项 -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('group-member-colors-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveGroupMemberColors()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 气泡样式设置模态框 -->
                <div class="modal" id="bubble-style-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">气泡样式设置</div>
                            <button class="modal-close" onclick="hideModal('bubble-style-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="bubble-style-section">
                                <label class="form-label">选择气泡样式</label>
                                <div class="bubble-style-grid">
                                    <div class="bubble-style-option" data-style="default">
                                        <div class="style-preview">
                                            <div class="preview-bubble sent-preview">默认样式</div>
                                            <div class="preview-bubble received-preview">经典圆角</div>
                                        </div>
                                        <div class="style-name">默认样式</div>
                                    </div>

                                    <div class="bubble-style-option" data-style="shadow">
                                        <div class="style-preview bubble-style-shadow">
                                            <div class="preview-bubble sent-preview">经典阴影</div>
                                            <div class="preview-bubble received-preview">立体感</div>
                                        </div>
                                        <div class="style-name">经典阴影</div>
                                    </div>

                                    <div class="bubble-style-option" data-style="tail">
                                        <div class="style-preview bubble-style-tail">
                                            <div class="preview-bubble sent-preview">带尖角</div>
                                            <div class="preview-bubble received-preview">气泡戳</div>
                                        </div>
                                        <div class="style-name">经典气泡</div>
                                    </div>

                                    <div class="bubble-style-option" data-style="paper">
                                        <div class="style-preview bubble-style-paper">
                                            <div class="preview-bubble sent-preview">纸张卡片</div>
                                            <div class="preview-bubble received-preview">质感</div>
                                        </div>
                                        <div class="style-name">纸张样式</div>
                                    </div>
                                </div>
                            </div>

                            <div class="color-setting-group">
                                <label class="form-label">自定义颜色</label>
                                <div class="color-picker-container">
                                    <div class="flex-gap-15">
                                        <div class="flex-1">
                                            <label class="label-small">我的气泡</label>
                                            <input type="color" id="my-bubble-color" class="color-input" value="#007AFF">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">对方气泡</label>
                                            <input type="color" id="ai-bubble-color" class="color-input" value="#f0f0f0">
                                            <!-- 🔥【新增】群聊角色单独设置按钮 -->
                                            <div id="group-member-colors-btn" style="display: none; margin-top: 8px;">
                                                <button type="button" class="theme-button theme-button-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="showGroupMemberColorSettings()">
                                                    为群成员单独设置
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="opacity-setting">
                                    <div class="flex-gap-15-mb-15">
                                        <div class="flex-1">
                                            <label class="label-small">我的气泡透明度：<span id="my-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="my-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">对方气泡透明度：<span id="ai-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="ai-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                    </div>
                                </div>

                                <div class="padding-setting">
                                    <label class="form-label">气泡大小调节</label>
                                    <div class="flex-gap-15-mb-10">
                                        <div class="flex-1">
                                            <label class="label-small">内边距：<span id="bubble-padding-value">中等</span></label>
                                            <input type="range" id="bubble-padding" min="4" max="16" step="2" value="12" class="width-100">
                                        </div>
                                    </div>
                                    <p class="tiny-text-gray margin-top-5">
                                        调整气泡内文字与边缘的距离，数值越大气泡越大
                                    </p>
                                </div>
                            </div>

                            <!-- 自定义CSS -->
                            <div class="custom-css-section">
                                <label class="form-label">自定义CSS样式</label>
                                <textarea id="custom-bubble-css" placeholder="输入自定义CSS代码...

示例（使用标准选择器）：
/* 用户消息气泡 */
.message-container.sent .message-bubble {
    background: linear-gradient(45deg, #007AFF, #5AC8FA) !important;
    border-radius: 20px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
}

/* AI消息气泡 */
.message-container.received .message-bubble {
    background: #f0f0f0 !important;
    border-radius: 20px !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

/* 消息容器 */
.message-container {
    margin-bottom: 10px !important;
}" rows="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 12px; resize: vertical;" oninput="updatePreview()"></textarea>
                            </div>

                            <!-- 实时预览 -->
                            <div class="preview-section">
                                <label class="form-label">实时预览</label>
                                <div class="preview-container" id="bubble-preview">
                                    <div class="preview-chat">
                                        <!-- AI消息 - 使用与实际聊天界面一致的结构 -->
                                        <div class="message-container received">
                                            <div class="message-avatar">AI</div>
                                            <div class="message-bubble" id="preview-ai">
                                                这是角色发送的消息预览
                                            </div>
                                        </div>
                                        <!-- 用户消息 - 使用与实际聊天界面一致的结构 -->
                                        <div class="message-container sent">
                                            <div class="message-bubble" id="preview-user">
                                                这是用户发送的消息预览
                                            </div>
                                            <div class="message-avatar">我</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('bubble-style-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveBubbleStyleSettings()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 定时发布设置模态框 -->
                <div class="modal" id="schedule-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">定时发布设置</div>
                            <button class="modal-close" onclick="hideModal('schedule-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="schedule-enabled" class="checkbox-with-margin">
                                    启用定时发布
                                </label>
                                <p class="small-text margin-top-5">
                                    开启后，角色会在指定时间点自动发布社交动态
                                </p>
                            </div>
                            <div class="form-group hide" id="schedule-times-group">
                                <label class="form-label">发布时间点</label>
                                <div id="schedule-times-container">
                                    <!-- 时间点将通过JS动态添加 -->
                                </div>
                                <button type="button" class="form-button form-button-secondary" onclick="addScheduleTime()">+ 添加时间点</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('schedule-settings-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveScheduleSettings()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 身份选择器模态框 -->
                <!-- 身份选择模态框已移除，身份在创建对话时选择 -->

                <!-- 世界书挂载设置模态框 -->
                <div class="modal" id="worldbook-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">世界书挂载设置</div>
                            <button class="modal-close" onclick="hideModal('worldbook-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="worldbook-mount-enabled" class="checkbox-with-margin">
                                    启用世界书挂载
                                </label>
                                <p class="small-text margin-top-5">
                                    开启后，AI会参考选定的世界书内容作为背景知识进行对话
                                </p>
                            </div>
                            <div class="form-group hide" id="worldbook-mount-details">
                                <label class="form-label">选择要挂载的世界书</label>
                                <div id="worldbook-mount-list" class="max-height-300-auto">
                                    <!-- 世界书列表将通过JS动态生成 -->
                                </div>
                                <p class="small-text margin-top-8">
                                    选择的世界书内容会作为背景知识提供给AI参考，帮助AI更好地理解对话上下文
                                </p>
                            </div>
                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>功能说明：</strong><br>
                                    • <strong>世界书挂载：</strong>将选定的世界书内容作为AI的背景知识<br>
                                    • <strong>多选支持：</strong>可以同时挂载多个世界书，内容会合并使用<br>
                                    • <strong>智能应用：</strong>AI会根据对话内容智能引用相关的世界书知识<br>
                                    • <strong>优先级：</strong>世界书知识优先级低于角色设定和历史对话
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 20px; gap: 0;">
                            <button class="modal-button modal-secondary" onclick="hideModal('worldbook-mount-modal')" style="margin: 0; padding: 12px 20px;">取消</button>
                            <button class="modal-button modal-primary" onclick="saveWorldbookMountSettings()" style="margin: 0; padding: 12px 20px;">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 表情包库挂载设置模态框 -->
                <div class="modal" id="emoji-library-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">表情包库挂载设置</div>
                            <button class="modal-close" onclick="hideModal('emoji-library-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="emoji-library-mount-enabled" class="checkbox-with-margin" onchange="toggleEmojiLibraryMountDetails()">
                                    启用表情包库挂载
                                </label>
                                <p class="small-text margin-top-5">
                                    开启后，聊天中的表情包面板只显示选定库中的表情包
                                </p>
                            </div>
                            <div id="emoji-library-mount-details" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">选择表情包库</label>
                                    <div id="emoji-library-mount-list" class="checkbox-list">
                                        <!-- 表情包库列表将通过JS动态生成 -->
                                    </div>
                                    <p class="small-text margin-top-5">
                                        可以选择多个表情包库，它们的表情包会合并显示
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 20px; gap: 0;">
                            <button class="modal-button modal-secondary" onclick="hideModal('emoji-library-mount-modal')" style="margin: 0; padding: 12px 20px;">取消</button>
                            <button class="modal-button modal-primary" onclick="saveEmojiLibraryMountSettings()" style="margin: 0; padding: 12px 20px;">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 搜索聊天内容模态框 -->
                <div class="modal" id="search-chat-modal">
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                        <div class="modal-header">
                            <div class="modal-title">查找聊天内容</div>
                            <button class="modal-close" onclick="hideModal('search-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">搜索关键词</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="search-keyword-input" placeholder="输入要搜索的关键词..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                                    <button onclick="performChatSearch()" style="padding: 8px 16px; background: #4a84c1; color: white; border: none; border-radius: 6px; cursor: pointer;">搜索</button>
                                </div>
                            </div>

                            <div id="search-results-summary" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                                <div id="search-stats"></div>
                            </div>

                            <div id="search-results-container" style="border: 1px solid #eee; border-radius: 6px; display: none;">
                                <div id="search-results-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 消息上下文模态框 -->
                <div class="modal" id="message-context-modal">
                    <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
                        <div class="modal-header">
                            <div class="modal-title">消息上下文</div>
                            <button class="modal-close" onclick="hideModal('message-context-modal')">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                            <div id="message-context-container" style="border: 1px solid #eee; border-radius: 6px; padding: 15px;">
                                <!-- 上下文消息将在这里显示 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 时间戳设置模态框 -->
                <div class="modal" id="timestamp-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">时间戳设置</div>
                            <button class="modal-close" onclick="hideModal('timestamp-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="timestamp-modal-enabled" class="checkbox-with-margin" checked>
                                    显示时间戳
                                </label>
                                <p class="small-text margin-top-5">
                                    在聊天消息中显示时间信息
                                </p>
                            </div>

                            <div class="form-group" id="timestamp-options-group">
                                <label class="form-label">时间戳位置</label>
                                <div class="timestamp-position-options">
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="center" checked>
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">居中显示</div>
                                            <div class="option-desc">时间戳显示在聊天中间，每5分钟出现一次</div>
                                        </div>
                                    </label>

                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="bubble">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">气泡外侧</div>
                                            <div class="option-desc">时间戳显示在每条消息气泡的外侧</div>
                                        </div>
                                    </label>

                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="avatar">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">头像下方</div>
                                            <div class="option-desc">时间戳显示在头像正下方位置</div>
                                        </div>
                                    </label>

                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="inside">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">气泡内</div>
                                            <div class="option-desc">时间戳显示在气泡内右下角，与文字齐平</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>位置说明：</strong><br>
                                    • <strong>居中显示：</strong>时间戳水平居中，仅在超过5分钟间隔时显示<br>
                                    • <strong>气泡外侧：</strong>每条消息都显示时间，用户消息在左下角，角色消息在右下角<br>
                                    • <strong>头像下方：</strong>时间戳显示在对应头像的正下方位置<br>
                                    • 所有时间戳均使用灰色小字显示，不影响聊天体验
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('timestamp-settings-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveTimestampSettings()">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- 转账功能相关模态框 -->
    <div id="transfer-modal">
        <div class="transfer-content">
                            <div class="transfer-header">发起转账</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">转账金额</label>
                                    <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="1000000000" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">备注 (可选)</label>
                                    <input type="text" id="transfer-note" placeholder="说点什么吧..." maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">取消</button>
                <button id="transfer-confirm-btn">确认转账</button>
            </div>
        </div>
    </div>

    <div id="transfer-confirm-modal">
        <div class="transfer-confirm-content">
            <div class="transfer-confirm-title">收到一笔转账</div>
            <div class="transfer-confirm-info">
                <div class="transfer-confirm-amount">¥ 0.00</div>
                <div class="transfer-confirm-note">备注：</div>
            </div>
            <div class="transfer-confirm-actions">
                <button id="transfer-reject-btn">退回</button>
                <button id="transfer-accept-btn">确认收款</button>
                </div>
            </div>
        </div>



    <!-- 播放列表模态框 -->
    <div id="playlist-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>播放列表</h3>
                <button class="close-btn" onclick="closePlaylistModal()">&times;</button>
            </div>

            <div class="playlist-content">
                <!-- 添加歌曲区域 -->
                <div class="add-song-section">
                    <h4>添加新歌曲</h4>
                    <div class="input-row">
                        <input type="text" id="song-title-input" placeholder="歌曲标题" class="song-input half-width">
                        <input type="text" id="song-artist-input" placeholder="艺术家" class="song-input half-width">
                    </div>
                    <div class="input-row">
                        <input type="text" id="song-url-input" placeholder="歌曲URL或选择本地文件" class="song-input half-width">
                        <div class="file-input-wrapper half-width">
                            <button onclick="document.getElementById('local-music-input').click()" class="upload-btn" style="width: 100%; padding: 8px;">
                                <i class="fas fa-file-audio"></i> 本地音乐
                            </button>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="file-input-wrapper half-width">
                            <input type="file" id="song-cover-input" accept="image/*,.jpg,.jpeg,.png,.gif,.webp" class="file-input" title="选择封面图片">
                            <span class="file-input-text">未选封面</span>
                        </div>
                        <div class="file-input-wrapper half-width">
                            <button onclick="document.getElementById('lyrics-file-input').click()" class="upload-btn" style="width: 100%; padding: 8px;">
                                <i class="fas fa-file-text"></i> 歌词文件
                            </button>
                        </div>
                    </div>
                    <div class="lyrics-input-section">
                        <div id="lyrics-file-status" style="display: none; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background-color: #f8f9fa; color: #007AFF; font-size: 14px; text-align: center;">
                            <!-- 选择歌词文件后显示状态 -->
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px; font-size: 11px; color: #666;">
                            <span>支持格式：LRC、TXT、bin等歌词文件（iPhone用户可选择任意文件）</span>
                        </div>
                        <div style="margin-top: 6px; font-size: 11px; color: #666;">
                            <span>💡 推荐使用在线URL，导入本地歌曲可能会带来内存负担</span>
                        </div>
                    </div>
                    <!-- 隐藏的文件输入 -->
                    <input type="file" id="local-music-input" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" style="display: none;">
                    <input type="file" id="lyrics-file-input" style="display: none;">
                    <button onclick="addCustomSong()" class="add-song-btn">
                        添加歌曲
                    </button>
                </div>

                <!-- 当前播放列表 -->
                <div class="current-playlist">
                    <h4>当前播放列表</h4>
                    <div id="playlist-items" class="playlist-items">
                        <!-- 播放列表项将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 音乐播放模态框 -->
    <div id="music-modal" class="music-modal" style="display: none;">
        <div class="music-modal-content">
            <div class="music-modal-header">
                <button class="music-modal-close" onclick="closeMusicModal()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="music-header-title">正在播放</div>
                <button class="music-view-toggle" onclick="toggleMusicView()" id="view-toggle-btn">
                    <i class="fas fa-list"></i>
                </button>
            </div>

            <div class="music-modal-body">
                <!-- 唱片机模式 -->
                <div id="vinyl-mode" class="music-view-mode">
                    <div class="vinyl-player">
                        <div class="vinyl-container">
                            <div class="vinyl-disc" id="vinyl-disc">
                                <div class="vinyl-grooves"></div>
                                <div class="vinyl-center"></div>
                                <div class="vinyl-label">
                                    <img id="album-cover" class="album-cover-display" style="display: none;" />
                                    <!-- 只显示封面，不支持点击上传 -->
                                </div>
                            </div>
                            <div class="tonearm" id="tonearm"></div>
                        </div>

                        <div class="song-info">
                            <div class="song-title" id="vinyl-song-title">选择歌曲</div>
                            <div class="song-artist" id="vinyl-artist-name">未知艺术家</div>
                        </div>

                        <div class="vinyl-lyrics">
                            <div class="lyrics-container">
                                <div class="lyric-line active" id="lyric-current">点击播放开始听歌</div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- 完整歌词模式 -->
                <div id="lyrics-mode" class="music-view-mode" style="display: none;">
                    <div class="lyrics-mode">
                        <div class="lyrics-header">
                            <div class="song-title" id="lyrics-song-title">选择歌曲</div>
                            <div class="song-artist" id="lyrics-artist-name">未知艺术家</div>
                        </div>
                        <div class="full-lyrics-container">
                            <div class="full-lyrics" id="full-lyrics-display">
                                <div class="lyric-line active">♪ 点击播放开始听歌</div>
                                <div class="lyric-line">选择你喜欢的歌曲</div>
                                <div class="lyric-line">和角色一起享受音乐时光</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="music-modal-controls">
                <!-- 当前歌词显示 -->
                <div class="current-lyric-display">
                    <div class="current-lyric-text" id="current-lyric-text">♪ 点击播放开始听歌</div>
                </div>

                <div class="music-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="modal-progress"></div>
                    </div>
                    <div class="time-display">
                        <span id="modal-current-time">0:00</span>
                        <span id="modal-total-time">0:00</span>
                    </div>
                </div>

                <div class="music-control-buttons">
                    <button class="control-btn shuffle" id="play-mode-btn" onclick="togglePlayMode()" title="顺序播放">
                        <i class="fas fa-list-ol"></i>
                    </button>
                    <button class="control-btn" onclick="previousTrack()" title="上一首">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-pause-btn" id="modal-play-btn" onclick="togglePlayback()" title="播放/暂停">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn" onclick="nextTrack()" title="下一首">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-btn playlist" id="playlist-btn" onclick="openPlaylistModal()" title="播放列表">
                        <i class="fas fa-music"></i>
                    </button>
                </div>

                <div class="listening-time">
                    <i class="fas fa-clock"></i>
                    <span id="listening-duration">已一起听 0 分钟</span>
                </div>
            </div>

            <!-- 关闭按钮 - 关机按钮样式 -->
            <button class="music-close-btn" onclick="closeMusicPlayer()" title="结束听歌">
                <i class="fas fa-power-off"></i>
            </button>


        </div>
    </div>

    <!-- 🔥【新增】群成员头像更换模态框 -->
    <div class="modal" id="member-avatar-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">更换成员头像</h3>
                <button class="modal-close" onclick="hideMemberAvatarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="member-avatar-form">
                    <div class="current-member-info">
                        <h4 id="member-avatar-name" class="member-name-title">角色名称</h4>
                        <p class="member-info-desc">为该角色设置新的头像，将在群聊中立即生效</p>
                    </div>

                    <div class="avatar-upload-section">
                        <div class="avatar-preview-large">
                            <img id="member-avatar-preview" src="" alt="头像预览" class="preview-image">
                        </div>

                        <div class="upload-buttons">
                            <button class="upload-btn primary" onclick="handleMemberAvatarUpload()">
                                <i class="fas fa-upload"></i>
                                选择新头像
                            </button>
                            <button class="upload-btn secondary" onclick="resetMemberAvatar()">
                                <i class="fas fa-undo"></i>
                                重置默认
                            </button>
                        </div>

                        <input type="file" id="member-avatar-upload" accept="image/*" style="display: none;">
                    </div>

                    <div class="avatar-tips">
                        <div class="tips-header">
                            <i class="fas fa-info-circle"></i>
                            <span>头像更换说明</span>
                        </div>
                        <div class="tips-content">
                            • 支持JPG、PNG等常见图片格式<br>
                            • 建议使用正方形图片，效果更佳<br>
                            • 头像更换后将在群聊中立即显示<br>
                            • 角色也可以在聊天时自主更换头像
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-secondary" onclick="hideMemberAvatarModal()">取消</button>
                <button class="modal-button modal-primary" onclick="saveMemberAvatar()">保存更改</button>
            </div>
        </div>
    </div>

    <!-- 群公告编辑模态框 -->
    <div class="modal" id="group-notice-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑群公告</h3>
                <button class="modal-close" onclick="hideGroupNoticeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="group-notice-form">
                    <div class="form-group">
                        <label class="form-label">群公告内容</label>
                        <textarea
                            id="group-notice-content"
                            class="form-textarea group-notice-textarea"
                            placeholder="输入群公告内容...&#10;&#10;可以包括：&#10;• 群规则说明&#10;• 重要通知&#10;• 活动安排&#10;• 其他事项"
                            maxlength="500"></textarea>
                        <div class="notice-char-count">
                            <span id="notice-char-current">0</span>/500字
                        </div>
                    </div>
                    <div class="notice-tips">
                        <div class="tips-header">
                            <i class="fas fa-lightbulb"></i>
                            <span>公告小贴士</span>
                        </div>
                        <div class="tips-content">
                            • 简洁明了，突出重点<br>
                            • 使用友好的语调<br>
                            • 定期更新重要信息<br>
                            • 可以使用emoji增加趣味性
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideGroupNoticeModal()">取消</button>
                <button class="modal-primary" onclick="saveGroupNotice()">保存公告</button>
            </div>
        </div>
    </div>

    <!-- 定时发布时间设置模态框 -->
    <div class="modal" id="schedule-times-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">定时发布时间设置</h3>
                <button class="modal-close" onclick="hideModal('schedule-times-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    设置角色每天自动发布动态的时间点（最多10个）
                </p>
                <div id="schedule-times-modal-container">
                    <!-- 时间输入项将动态生成 -->
                </div>
                <button onclick="addScheduleTime()" style="margin-top: 10px; padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    + 添加时间点
                </button>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideModal('schedule-times-modal')">取消</button>
                <button class="modal-primary" onclick="saveScheduleTimes()">保存</button>
            </div>
        </div>
    </div>



    <!-- 游戏选择模态框 -->
    <div id="game-menu-modal" class="modal" style="display: none;">
        <div class="modal-content game-modal-content">
            <div class="modal-header game-modal-header">
                <div class="game-modal-title">
                    <i class="fas fa-gamepad"></i>
                    <span>选择游戏</span>
                </div>
                <button class="modal-close game-modal-close" onclick="hideGameMenu()">×</button>
            </div>
            <div class="modal-body game-modal-body">
                <div class="game-buttons-container" id="game-buttons-container">
                    <!-- 游戏按钮将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 位置分享模态框 -->
    <div id="chat-location-modal" class="modal" style="display: none;">
        <div class="modal-content location-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">分享位置</h3>
                <button class="modal-close" onclick="hideChatLocationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="location-input-section">
                    <label for="location-address">位置名称</label>
                    <input type="text" id="location-address" placeholder="请输入位置名称，如：咖啡厅、学校、家..." maxlength="50">

                    <!-- 最近使用历史记录 -->
                    <div class="location-history" id="location-history">
                        <div class="location-history-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="display: inline-block; margin-right: 6px; vertical-align: middle;">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                            </svg>
                            最近使用
                        </div>
                        <div class="location-history-items" id="location-history-items">
                            <div class="location-history-empty">暂无历史记录</div>
                        </div>
                    </div>
                </div>
                <div class="virtual-map-container">
                    <div class="map-header" style="background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 100%);">
                        <div class="map-location-name" id="map-location-display" style="color: #52c41a;">请输入位置名称</div>
                        <div class="map-coordinates" style="color: #73d13d;">116.4074°E, 39.9042°N</div>
                    </div>
                    <div class="virtual-map">
                        <div class="map-background"></div>
                        <!-- 弯曲河流 -->
                        <div class="river" style="top: 8%; left: 55%; width: 25px; height: 4px; transform: rotate(30deg);"></div>
                        <div class="river-curve" style="top: 18%; left: 68%; width: 22px; height: 4px; transform: rotate(10deg);"></div>
                        <div class="river" style="top: 26%; left: 78%; width: 20px; height: 4px; transform: rotate(-10deg);"></div>
                        <div class="river-curve" style="top: 32%; left: 85%; width: 18px; height: 4px; transform: rotate(-30deg);"></div>
                        <div class="river" style="top: 60%; left: 5%; width: 28px; height: 4px; transform: rotate(-15deg);"></div>
                        <div class="river-curve" style="top: 68%; left: 25%; width: 25px; height: 4px; transform: rotate(5deg);"></div>
                        <div class="river" style="top: 75%; left: 42%; width: 22px; height: 4px; transform: rotate(20deg);"></div>
                        <!-- 公园绿地 -->
                        <div style="position: absolute; top: 25%; left: 65%; width: 25px; height: 20px; background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 50%, #b7eb8f 100%); border-radius: 3px; opacity: 0.6; z-index: 1;"></div>
                        <div style="position: absolute; top: 50%; left: 15%; width: 30px; height: 25px; background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 50%, #b7eb8f 100%); border-radius: 3px; opacity: 0.6; z-index: 1;"></div>
                        <!-- 道路 -->
                        <div class="map-roads">
                            <div class="road road-horizontal" style="top: 30%; left: 0; width: 100%;"></div>
                            <div class="road road-vertical" style="left: 25%; top: 0; height: 100%;"></div>
                            <div class="road road-horizontal" style="top: 70%; left: 0; width: 100%;"></div>
                            <div class="road road-vertical" style="left: 75%; top: 0; height: 100%;"></div>
                        </div>
                        <!-- 建筑物 -->
                        <div class="map-buildings">
                            <div class="building" style="top: 10%; left: 35%; width: 20px; height: 15px; background: linear-gradient(135deg, #f0f0f0 0%, #d9d9d9 100%); border: 1px solid #bfbfbf; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 15%; left: 55%; width: 25px; height: 20px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border: 1px solid #91d5ff; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 40%; left: 10%; width: 18px; height: 12px; background: linear-gradient(135deg, #fff1f0 0%, #ffd8d6 100%); border: 1px solid #ffaaa5; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 45%; left: 85%; width: 22px; height: 18px; background: linear-gradient(135deg, #f0f0f0 0%, #d9d9d9 100%); border: 1px solid #bfbfbf; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 75%; left: 40%; width: 30px; height: 20px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border: 1px solid #91d5ff; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 80%; left: 15%; width: 20px; height: 15px; background: linear-gradient(135deg, #fff1f0 0%, #ffd8d6 100%); border: 1px solid #ffaaa5; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                        </div>
                        <!-- 树木 -->
                        <div style="position: absolute; top: 35%; left: 20%; width: 8px; height: 8px; background: radial-gradient(circle, #52c41a 0%, #389e0d 70%, #237804 100%); border-radius: 50%; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); z-index: 3;"></div>
                        <div style="position: absolute; top: 60%; left: 30%; width: 6px; height: 6px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <div style="position: absolute; top: 12%; left: 70%; width: 7px; height: 7px; background: radial-gradient(circle, #52c41a 0%, #389e0d 70%, #237804 100%); border-radius: 50%; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); z-index: 3;"></div>
                        <div style="position: absolute; top: 85%; left: 90%; width: 5px; height: 5px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <div style="position: absolute; top: 50%; left: 90%; width: 6px; height: 6px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <!-- 位置标记 -->
                        <div class="map-marker" id="location-marker">
                            <div class="marker-pin">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                </svg>
                            </div>
                        </div>
                        <div class="map-current-location">
                            <div class="current-location-dot"></div>
                        </div>
                    </div>
                    <div class="map-footer">
                        <div class="map-scale">500m</div>
                        <div class="map-controls">
                            <button class="map-control-btn" onclick="randomizeMapPosition()">🎯 重新定位</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideChatLocationModal()">取消</button>
                <button class="modal-primary" onclick="sendLocationMessage()">发送位置</button>
            </div>
        </div>
    </div>
    </div>

    <!-- 🚫【拉黑系统】模态框 -->
    <div id="blacklist-settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">拉黑管理</h3>
                <button class="modal-close" onclick="hideBlacklistSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="section-header">
                        <i class="fas fa-user-slash section-icon"></i>
                        <span class="section-title">当前状态</span>
                    </div>
                    <div class="setting-card">
                        <div class="setting-item" id="current-blacklist-status">
                            <div class="setting-left">
                                <div class="setting-label">拉黑状态</div>
                                <div class="setting-desc" id="blacklist-status-desc">正常聊天中</div>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="settings-section">
                    <div class="section-header">
                        <i class="fas fa-exclamation-triangle section-icon danger-section-icon"></i>
                        <span class="section-title danger-section-title">操作</span>
                    </div>
                    <div class="setting-card">
                        <div class="setting-item" id="block-action-item" onclick="performBlockAction()">
                            <div class="setting-left">
                                <div class="setting-label" id="block-action-label">拉黑此角色</div>
                                <div class="setting-desc" id="block-action-desc">阻止该角色向你发送消息</div>
                            </div>
                            <div class="setting-right">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideBlacklistSettings()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 🚫【好友申请】模态框 -->
    <div id="friend-request-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">好友申请</h3>
                <button class="modal-close" onclick="hideFriendRequestModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">申请理由（可选）</label>
                    <textarea id="friend-request-message" class="form-textarea" placeholder="请输入申请理由..." maxlength="200"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideFriendRequestModal()">取消</button>
                <button class="modal-primary" onclick="sendFriendRequestConfirm()">发送申请</button>
            </div>
        </div>
    </div>

    <!-- 🔥【新增】心声模态框 -->
    <div id="inner-thoughts-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    💭心声
                </h3>
                <button class="modal-close" onclick="hideInnerThoughtsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="inner-thoughts-content" class="inner-thoughts-content">
                    <div class="inner-thoughts-loading">
                        <div class="loading-spinner"></div>
                        <p>正在读取角色的内心想法...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary inner-thoughts-refresh-btn" onclick="refreshInnerThoughts(selectedMessageId)">
                    <i class="fas fa-sync-alt"></i> 重新生成
                </button>
                <button class="modal-secondary" onclick="hideInnerThoughtsModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 转发目标选择模态框 -->
    <div class="modal" id="forward-target-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">选择一个聊天</div>
                <button class="modal-close" onclick="hideModal('forward-target-modal')">&times;</button>
            </div>
            <div class="modal-body" id="forward-target-list">
            </div>
        </div>
    </div>

    <!-- 查看转发记录详情模态框 -->
    <div class="modal" id="forwarded-view-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="forwarded-view-title">聊天记录</div>
                <button class="modal-close" onclick="hideModal('forwarded-view-modal')">&times;</button>
            </div>
            <div class="modal-body" id="forwarded-view-content">
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <script src="production.js"></script>
    <script src="database.js"></script>
    <script src="main.js"></script>
    <script src="auth.js"></script> 

</body>
</html>